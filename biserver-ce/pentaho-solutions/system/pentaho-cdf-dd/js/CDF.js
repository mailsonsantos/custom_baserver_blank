
pentaho=typeof pentaho=="undefined"?{}:pentaho;pentaho.palettes=[];pentaho.palettes.push({name:'palette 1',colors:["#336699","#99CCFF","#999933","#666699","#CC9933","#006666","#3399FF","#993300","#CCCC99","#666666","#FFCC66","#6699CC","#663366"]});pentaho.palettes.push({name:'palette 2',colors:["#880a0f","#b09a6b","#772200","#c52f0d","#123d82","#4a0866","#ffaa00","#1e8ad3","#aa6611","#772200","#8b2834","#333333"]});pentaho.palettes.push({name:'palette 3',colors:["#387179","#626638","#A8979A","#B09A6B","#772200","#C52F0D","#123D82","#4A0866","#445500","#FFAA00","#1E8AD3","#AA6611","#772200"]});pentaho.visualizations=pentaho.visualizations||[];pentaho.visualizations.getById=function(id){for(var i=0;i<this.length;i++){if(this[i].id==id){return this[i];}}
return null;};var visualizations=pentaho.visualizations;pentaho.VizController=function(id){this.id=id;this.domNode=null;this.isDragging=false;this.combinations=[];this.selections=[];this.highlights=[];this.metrics=null;this.origTable=null;this.dataTable=null;this.currentViz=null;this.currentAction='select';this.layoutPanelElement=null;this.layoutPanel=null;this.visualPanelElement=null;this.layoutShown=false;this.toolbarElement=null;this.title=null;this.chart=null;this.palette=pentaho.palettes[0];this.lastError=null;this.memberPalette=null;this.formatInfo=null;}
pentaho.VizController.prototype.getError=function(){return this.lastError;}
pentaho.VizController.prototype.getState=function(){try{var state={};if(this.currentViz){state.vizId=this.currentViz.id;if(this.chart.getState){state.vizState=this.chart.getState();}}
return state;}catch(e){this.lastError=e;return null;}}
pentaho.VizController.prototype.setState=function(state){try{if(!this.currentViz||this.currentViz.id!=state.vizId){for(var idx=0;idx<pentaho.visualizations.length;idx++){if(pentaho.visualizations[idx].id==state.id){this.currentViz=pentaho.visualizations[idx];break;}}
if(!this.currentViz){alert('Visualization not found: '+state.vizId);}
this.setVisualization(this.currentViz);}
delete state.dataReqs;dojo.safeMixin(this.currentViz,state);if(this.chart&&this.chart.setState){this.chart.setState(state.vizState);}
return true;}catch(e){this.lastError=e;return false;}}
pentaho.VizController.prototype.setDomNode=function(node){try{this.domNode=node;while(node.firstChild){node.removeChild(node.firstChild);}
var width=this.domNode.offsetWidth;var height=this.domNode.offsetHeight;this.visualPanelElement=document.createElement("DIV");this.visualPanelElement.setAttribute('id','visualPanelElement-'+this.id);this.visualPanelElement.setAttribute('style','border:0px solid #red; background-color: white; width: '+(width)+'px; height: '+(height)+'px');this.domNode.appendChild(this.visualPanelElement);return true;}catch(e){this.lastError=e;return false;}}
pentaho.VizController.prototype.setDataTable=function(table){try{this.origTable=table;this.setupTable();return true;}catch(e){this.lastError=e;return false;}}
pentaho.VizController.prototype.setMemberPalette=function(colors){this.memberPalette=colors;}
pentaho.VizController.prototype.setFormatInfo=function(formatInfo){this.formatInfo=formatInfo;}
pentaho.VizController.prototype.setTitle=function(title){this.title=title;}
pentaho.VizController.prototype.setVisualization=function(visualization,options){try{if(this.currentViz&&this.currentViz['class']!=visualization['class']){this.setDomNode(this.domNode);}
this.currentViz=visualization;this.doVisualization(visualization,options);return true;}catch(e){this.lastError=e;return false;}}
pentaho.VizController.prototype.updateVisualization=function(options){try{if(!this.currentViz){return;}
this.doVisualization(this.currentViz,options);return true;}catch(e){this.lastError=e;return false;}}
pentaho.VizController.prototype.doVisualization=function(visualization,userDefinedOptions){this.userDefinedOptions=userDefinedOptions||{};if(!this.dataTable){return;}
try{currentView=new pentaho.DataView(this.dataTable);var className=visualization['class'];var options={'title':this.title,'width':this.visualPanelElement.offsetWidth,'height':this.visualPanelElement.offsetHeight,metrics:this.metrics,palette:this.palette,controller:this,action:this.currentAction,selections:this.highlights};if(visualization.needsColorGradient){var gradMap=[[255,0,0],[255,255,0],[0,0,255],[0,255,0]];options.color1=gradMap[0];options.color2=gradMap[3];}
var propMap=visualization.propMap;if(propMap){for(var propNo=0;propNo<propMap.length;propNo++){var prop=propMap[propNo];var propValue=null;if(prop.source=='columnlabel'){propValue=currentView.getColumnLabel(prop.position);}
if(prop.source=='maxvalue'){propValue=this.metrics[prop.position].range.max;}
if(prop.source=='minvalue'){propValue=this.metrics[prop.position].range.min;}
var obj=options;for(var nameNo=0;nameNo<prop.name.length;nameNo++){if(nameNo<prop.name.length-1){if(!obj[prop.name[nameNo]]){obj[prop.name[nameNo]]={};}
obj=obj[prop.name[nameNo]]}
else{obj[prop.name[nameNo]]=propValue;}}}}
if(visualization.args){for(var x in visualization.args){options[x]=visualization.args[x];}}
for(var x in this.userDefinedOptions){options[x]=this.userDefinedOptions[x];}
options.memberPalette=this.memberPalette?this.memberPalette:{};options.formatInfo=this.formatInfo;var id='chart_div'+this.id;if(this.chart&&this.chart.vizId==visualization.id){}else{var chartDiv=this.visualPanelElement;eval('this.chart = new '+className+'(chartDiv)');pentaho.events.addListener(this.chart,'select',function(){return myself.chartSelectHandler.apply(myself,arguments||[]);});pentaho.events.addListener(this.chart,'doubleclick',function(){return myself.chartDoubleClickHandler.apply(myself,arguments||[]);});pentaho.events.addListener(this.chart,'onmouseover',function(){return myself.chartMouseOverHandler.apply(myself,arguments||[]);});pentaho.events.addListener(this.chart,'onmouseout',function(){return myself.chartMouseOutHandler.apply(myself,arguments||[]);});}
var myself=this;this.chart.controller=this;this.chart.id='viz'+this.id;this.chart.vizId=visualization.id;if(!currentView){alert('No suitable dataset');document.getElementById('chart_div').innerHTML='';return;}
try{this.chart.draw(currentView,options);}catch(e){if(console&&console.log){console.log(e.message);}}
this.currentViz=visualization;return true;}catch(e){this.lastError=e;return false;}}
pentaho.VizController.prototype.chartSelectHandler=function(args){this.processHighlights(args);pentaho.events.trigger(this,"select",args);}
pentaho.VizController.prototype.chartDoubleClickHandler=function(args){pentaho.events.trigger(this,"doubleclick",args);}
pentaho.VizController.prototype.processHighlights=function(args){var mode=args.selectionMode||"TOGGLE";if(mode=="REPLACE"){this.highlights=[];}
for(var i=0;i<args.selections.length;i++){var selectedItem=args.selections[i];var rowItem;var colId;var colLabel;var value;var colItem;var rowId;var rowLabel;if(selectedItem.rowItem){rowItem=selectedItem.rowItem;rowId=selectedItem.rowId;rowLabel=selectedItem.rowLabel;}
if(selectedItem.column||selectedItem.column==0){colId=selectedItem.columnId;colLabel=selectedItem.columnLabel;colItem=selectedItem.columnItem;}
if((selectedItem.row||selectedItem.row==0)&&selectedItem.column){value=selectedItem.value;}
var removed=false;var modified=false;if(mode=="TOGGLE"){for(var hNo=0;hNo<this.highlights.length;hNo++){var highlightRowItem=this.highlights[hNo].rowItem;var highlightColItem=this.highlights[hNo].colItem;var rowItemsSame=highlightRowItem&&(highlightRowItem==rowItem||(highlightRowItem.join&&(highlightRowItem.join('-')==rowItem.join('-'))));var colItemsSame=highlightColItem&&(highlightColItem==colItem||(highlightColItem.join&&(highlightColItem.join('-')==colItem.join('-'))));if(typeof colItemsSame=='undefined'){colItemsSame=true;}
if(rowItemsSame&&colItemsSame&&this.highlights[hNo].colId&&this.highlights[hNo].colId==colId&&this.highlights[hNo].type=='column'&&selectedItem.type=='cell'){this.highlights[hNo].type='row';highlight.id=selectedItem.rowId;highlight.value=rowItem;modified=true;break;}
else if(rowItemsSame&&colItemsSame&&this.highlights[hNo].colId&&this.highlights[hNo].colId==colId&&this.highlights[hNo].type=='column'){this.highlights.splice(hNo,1);removed=true;break;}
else if(rowItemsSame&&colItemsSame){this.highlights.splice(hNo,1);removed=true;break;}}}
if(!removed&&!modified){highlight={rowItem:rowItem,colId:colId,colLabel:colLabel,colItem:colItem,rowId:rowId,rowLabel:rowLabel};highlight.type=selectedItem.type;if(selectedItem.type=='row'){highlight.id=rowId;highlight.value=rowItem;}
else if(selectedItem.type=='column'){highlight.type='column';highlight.id=colId;highlight.value=colLabel;}
else if(selectedItem.type=='cell'){highlight.type='cell';highlight.id=colId;highlight.value=colLabel;}
this.highlights.push(highlight);}}}
pentaho.VizController.prototype.createCombination=function(){var type,columnId,values=[];for(var idx=0;idx<this.highlights.length;idx++){if(idx==0){type=this.highlights[idx].type;values.push(this.highlights[idx].value);columnId=this.highlights[idx].id;}
else if(this.highlights[idx].id==columnId){values.push(this.highlights[idx].value);}}
this.combinations.push({values:values,columnId:columnId});this.setupTable();this.highlights=[];this.updateVisualization();}
pentaho.VizController.prototype.updateHighlights=function(){if(this.chart.setHighlights){this.chart.setHighlights(this.highlights);}}
pentaho.VizController.prototype.clearSelections=function(){this.highlights=[];}
pentaho.VizController.prototype.setupTable=function(){if(!this.origTable){return;}
this.metrics=[];this.dataTable=this.origTable;if(this.combinations&&this.combinations.length>0){var rows=this.origTable.getFilteredRows([{column:0,combinations:this.combinations}]);var view=new pentaho.DataView(table);view.setRows(rows);this.dataTable=view;}
for(var colNo=0;colNo<this.dataTable.getNumberOfColumns();colNo++){if(this.dataTable.getColumnType(colNo)=='string'){var values=this.dataTable.getDistinctValues(colNo);var paletteMap=pentaho.VizController.createPaletteMap(values,this.palette);this.metrics.push({values:values,paletteMap:paletteMap});}
else if(this.dataTable.getColumnType(colNo)=='number'){var range=this.dataTable.getColumnRange(colNo);this.metrics.push({range:range});}}}
function sort(columnIdx,direction){var rows=this.dataTable.sort([{column:columnIdx,desc:direction==pentaho.pda.Column.SORT_TYPES.DESCENDING}]);clearDataDisplay();displayData();}
pentaho.VizController.createPaletteMap=function(items,palette){var map={};for(var itemNo=0;itemNo<items.length&&itemNo<palette.colors.length;itemNo++){map[items[itemNo]]=palette.colors[itemNo];}
for(var itemNo=palette.colors.length;itemNo<items.length;itemNo++){map[items[itemNo]]="#000000";}
return map;}
pentaho.VizController.getRrbGradient=function(value,min,max,color1,color2){if(max-min<=0){return pentaho.VizController.getRrbColor(color2[0],color2[1],color2[2]);}
var inRange=(value-min)/(max-min);var cols=new Array(3);cols[0]=Math.floor(inRange*(color2[0]-color1[0])+color1[0]);cols[1]=Math.floor(inRange*(color2[1]-color1[1])+color1[1]);cols[2]=Math.floor(inRange*(color2[2]-color1[2])+color1[2]);return pentaho.VizController.getRrbColor(cols[0],cols[1],cols[2]);}
pentaho.VizController.getRgbGradientFromMultiColorHex=function(value,min,max,colors){var steps=colors.length-1;var range=max-min;if(range<=0){var start=colors.length-1;var end=start;}else{var start=Math.floor(((value-min)/range)*steps);var end=Math.ceil(((value-min)/range)*steps);}
var color1=pentaho.VizController.convertToRGB(colors[start]);var color2=pentaho.VizController.convertToRGB(colors[end]);var rangeMin=(start==0)?1:(start/steps)*max;var rangeMax=(end/steps)*max;var inRange
if(rangeMin==rangeMax){inRange=1;}else{inRange=(value-rangeMin)/(rangeMax-rangeMin);}
var cols=new Array(3);cols[0]=Math.floor(inRange*(color2[0]-color1[0])+color1[0]);cols[1]=Math.floor(inRange*(color2[1]-color1[1])+color1[1]);cols[2]=Math.floor(inRange*(color2[2]-color1[2])+color1[2]);return pentaho.VizController.getRrbColor(cols[0],cols[1],cols[2]);}
pentaho.VizController.getDarkerFromColorHex=function(color,k){var comps=pentaho.VizController.convertToRGB(color);k=Math.pow(0.7,k!=null?k:1);return pentaho.VizController.getRrbColor(Math.max(0,Math.floor(k*comps[0])),Math.max(0,Math.floor(k*comps[1])),Math.max(0,Math.floor(k*comps[2])));};pentaho.VizController.getRgbStepFromMultiColorHex=function(value,min,max,colors){var steps=colors.length-1;var range=max-min;var step=Math.round(((value-min)/range)*steps);var color=pentaho.VizController.convertToRGB(colors[step]);return pentaho.VizController.getRrbColor(color[0],color[1],color[2]);}
pentaho.VizController.convertToRGB=function(hex){if(hex.indexOf("#")==0){hex=hex.substring(1);}else{hex=pentaho.VizController.CSS_Names[hex.toLowerCase()];}
return[parseInt(hex.substring(0,2),16),parseInt(hex.substring(2,4),16),parseInt(hex.substring(4,6),16)];}
pentaho.VizController.getRrbColor=function(r,g,b){return'RGB('+r+','+g+','+b+')';}
pentaho.VizController.prototype.resize=function(width,height){this.visualPanelElement.style.width=width+"px";this.visualPanelElement.style.height=height+"px";this.chart.resize(width,height);}
pentaho.VizController.dashboardMode=false;try{window.parent&&typeof(window.parent.PentahoDashboardController)!=="undefined";}catch(ignored){}
pentaho.VizController.CSS_Names={"aliceblue":"F0F8FF","antiquewhite":"FAEBD7","aqua":"00FFFF","aquamarine":"7FFFD4","azure":"F0FFFF","beige":"F5F5DC","bisque":"FFE4C4","black":"000000","blanchedalmond":"FFEBCD","blue":"0000FF","blueviolet":"8A2BE2","brown":"A52A2A","burlywood":"DEB887","cadetblue":"5F9EA0","chartreuse":"7FFF00","chocolate":"D2691E","coral":"FF7F50","cornflowerblue":"6495ED","cornsilk":"FFF8DC","crimson":"DC143C","cyan":"00FFFF","darkblue":"00008B","darkcyan":"008B8B","darkgoldenRod":"B8860B","darkgray":"A9A9A9","darkgrey":"A9A9A9","darkgreen":"006400","darkkhaki":"BDB76B","darkmagenta":"8B008B","darkoliveGreen":"556B2F","darkorange":"FF8C00","darkorchid":"9932CC","darkred":"8B0000","darksalmon":"E9967A","darkseagreen":"8FBC8F","darkslateblue":"483D8B","darkslategray":"2F4F4F","darkslategrey":"2F4F4F","darkturquoise":"00CED1","darkviolet":"9400D3","deeppink":"FF1493","deepskyblue":"00BFFF","dimgray":"696969","dimgrey":"696969","dodgerblue":"1E90FF","firebrick":"B22222","floralwhite":"FFFAF0","forestgreen":"228B22","fuchsia":"FF00FF","gainsboro":"DCDCDC","ghostwhite":"F8F8FF","gold":"FFD700","goldenrod":"DAA520","gray":"808080","grey":"808080","green":"008000","greenyellow":"ADFF2F","honeydew":"F0FFF0","hotpink":"FF69B4","indianred":"CD5C5C","indigo":"4B0082","ivory":"FFFFF0","khaki":"F0E68C","lavender":"E6E6FA","lavenderblush":"FFF0F5","lawngreen":"7CFC00","lemonchiffon":"FFFACD","lightblue":"ADD8E6","lightcoral":"F08080","lightcyan":"E0FFFF","lightgoldenrodyellow":"FAFAD2","lightgray":"D3D3D3","lightgrey":"D3D3D3","lightgreen":"90EE90","lightpink":"FFB6C1","lightsalmon":"FFA07A","lightseagreen":"20B2AA","lightskyblue":"87CEFA","lightslategray":"778899","lightslategrey":"778899","lightsteelblue":"B0C4DE","lightyellow":"FFFFE0","lime":"00FF00","limegreen":"32CD32","linen":"FAF0E6","magenta":"FF00FF","maroon":"800000","mediumaquamarine":"66CDAA","mediumblue":"0000CD","mediumorchid":"BA55D3","mediumpurple":"9370D8","mediumseagreen":"3CB371","mediumslateblue":"7B68EE","mediumspringgreen":"00FA9A","mediumturquoise":"48D1CC","mediumvioletred":"C71585","midnightblue":"191970","mintcream":"F5FFFA","mistyrose":"FFE4E1","moccasin":"FFE4B5","navajowhite":"FFDEAD","navy":"000080","oldlace":"FDF5E6","olive":"808000","olivedrab":"6B8E23","orange":"FFA500","orangered":"FF4500","orchid":"DA70D6","palegoldenrod":"EEE8AA","palegreen":"98FB98","paleturquoise":"AFEEEE","palevioletRed":"D87093","papayawhip":"FFEFD5","peachpuff":"FFDAB9","peru":"CD853F","pink":"FFC0CB","plum":"DDA0DD","powderblue":"B0E0E6","purple":"800080","red":"FF0000","rosybrown":"BC8F8F","royalblue":"4169E1","saddlebrown":"8B4513","salmon":"FA8072","sandybrown":"F4A460","seagreen":"2E8B57","seashell":"FFF5EE","sienna":"A0522D","silver":"C0C0C0","skyblue":"87CEEB","slateblue":"6A5ACD","slategray":"708090","slategrey":"708090","snow":"FFFAFA","springgreen":"00FF7F","steelblue":"4682B4","tan":"D2B48C","teal":"008080","thistle":"D8BFD8","tomato":"FF6347","turquoise":"40E0D0","violet":"EE82EE","wheat":"F5DEB3","white":"FFFFFF","whitesmoke":"F5F5F5","yellow":"FFFF00","yellowgreen":"9ACD32"}
pentaho=typeof pentaho=="undefined"?{}:pentaho;pentaho.DataTable=function(jsonTable){this.jsonTable=jsonTable;this.className="pentaho.DataTable";if(jsonTable.metadata){this.jsonTable=pentaho.DataTable.convertCdaToDataTable(jsonTable);}}
pentaho.DataTable.convertCdaToDataTable=function(cdaTable){var cols=[];var rows=[];for(var columnIdx=0;columnIdx<cdaTable.metadata.length;columnIdx++){col={id:cdaTable.metadata[columnIdx].colName,type:cdaTable.metadata[columnIdx].colType.toLowerCase(),label:cdaTable.metadata[columnIdx].colLabel}
if(!col.label){col.label=col.id;}
if(col.type=='numeric'){col.type='number';}
cols.push(col);}
var cdaData=cdaTable.resultset;for(var rowIdx=0;rowIdx<cdaData.length;rowIdx++){var cells=[];var cdaRow=cdaData[rowIdx];for(columnIdx=0;columnIdx<cdaRow.length;columnIdx++){cells.push({v:cdaRow[columnIdx]});}
var row={c:cells};rows.push(row);}
return{cols:cols,rows:rows};}
pentaho.DataTable.prototype.makePostable=function(){this.jsonTable["class"]="org.pentaho.dataservice.DataTable";for(var idx=0;idx<this.getNumberOfColumns();idx++){this.jsonTable.cols[idx]["class"]="org.pentaho.dataservice.Column";}
for(var idx=0;idx<this.getNumberOfRows();idx++){var cells=this.jsonTable.rows[idx].c;if(cells){for(cellNo=0;cellNo<cells.length;cellNo++){if(cells[cellNo]){cells[cellNo]["class"]="org.pentaho.dataservice.Cell";}}}}}
pentaho.DataTable.prototype.getJsonTable=function(){return this.jsonTable;}
pentaho.DataTable.prototype.getNumberOfColumns=function(){return this.jsonTable.cols.length;}
pentaho.DataTable.prototype.getNumberOfRows=function(){return this.jsonTable.rows.length;}
pentaho.DataTable.prototype.getColumnType=function(columnIdx){return this.jsonTable.cols[columnIdx].type;}
pentaho.DataTable.prototype.getColumnId=function(columnIdx){return this.jsonTable.cols[columnIdx].id;}
pentaho.DataTable.prototype.getColumnLabel=function(columnIdx){return this.jsonTable.cols[columnIdx].label;}
pentaho.DataTable.prototype.getValue=function(rowIdx,columnIdx){if(!this.jsonTable.rows[rowIdx].c[columnIdx]){return null;}
if(this.jsonTable.rows[rowIdx].c[columnIdx].v!==undefined){return this.jsonTable.rows[rowIdx].c[columnIdx].v;}else{return this.jsonTable.rows[rowIdx].c[columnIdx];}}
pentaho.DataTable.prototype._getCell=function(rowIdx,columnIdx){if(!this.jsonTable.rows[rowIdx].c[columnIdx]){return null;}
return this.jsonTable.rows[rowIdx].c[columnIdx];}
pentaho.DataTable.prototype.getFormattedValue=function(rowIdx,columnIdx){if(!this.jsonTable.rows[rowIdx].c[columnIdx]){return null;}
else if(this.jsonTable.rows[rowIdx].c[columnIdx].f!==undefined){return this.jsonTable.rows[rowIdx].c[columnIdx].f;}
else if(this.jsonTable.rows[rowIdx].c[columnIdx].v!==undefined){return this.jsonTable.rows[rowIdx].c[columnIdx].v;}
else if(this.jsonTable.rows[rowIdx].c[columnIdx].v==null){return null;}
else{return this.jsonTable.rows[rowIdx].c[columnIdx];}}
pentaho.DataTable.prototype.getColumnRange=function(columnIdx,options){var min;var max;var set=false;var key=options&&options.key;for(var rowNo=0;rowNo<this.getNumberOfRows();rowNo++){var value=this.getValue(rowNo,columnIdx);if(value!=null){if(key){value=key(value);}
if(!set){min=value;max=value;set=true;}else{if(value<min){min=value;}
if(value>max){max=value;}}}}
var range={min:min,max:max}
return range;}
pentaho.DataTable.prototype.getDistinctValues=function(columnIdx){var values=[];var valueMap={};var isNumber=this.getColumnType(columnIdx)=='number';for(var rowNo=0;rowNo<this.getNumberOfRows();rowNo++){var value=isNumber?this.getValue(rowNo,columnIdx):this.getFormattedValue(rowNo,columnIdx);if(!valueMap[value]){valueMap[value]=true;values.push(value);}}
return values;}
pentaho.DataTable.prototype.getDistinctFormattedValues=function(columnIdx){var values=[];var valueMap={};for(var rowNo=0;rowNo<this.getNumberOfRows();rowNo++){var value=this.getFormattedValue(rowNo,columnIdx);if(!valueMap[value]){valueMap[value]=true;values.push(value);}}
return values;}
pentaho.DataTable.prototype.getFilteredRows=function(filters){var rows=[];var comboMap={};for(var rowNo=0;rowNo<this.getNumberOfRows();rowNo++){for(var filterNo=0;filterNo<filters.length;filterNo++){if(filters[filterNo].value){if(this.getValue(rowNo,filters[filterNo].column)==filters[filterNo].value){rows.push(rowNo);}}
if(filters[filterNo].combinations){var value=this.getValue(rowNo,filters[filterNo].column);var combinations=filters[filterNo].combinations;var combined=false;for(combinationNo=0;combinationNo<combinations.length;combinationNo++){for(valueNo=0;valueNo<combinations[combinationNo].values.length;valueNo++){if(value==combinations[combinationNo].values[valueNo]){if(comboMap[combinationNo]){comboMap[combinationNo][1].push(rowNo);}else{var row=['combine',[]];row[1].push(rowNo);rows.push(row);comboMap[combinationNo]=row;}
combined=true;}}}
if(!combined){rows.push(rowNo);}}}}
return rows;}
pentaho.DataTable.prototype.setColumnProperty=function(columnIndex,name,value){if(columnIndex>=0&&columnIndex<this.jsonTable.cols.length){this.jsonTable.cols[columnIndex][name]=value;}}
pentaho.DataTable.prototype.getColumnProperty=function(columnIndex,name){if(columnIndex>=0&&columnIndex<this.jsonTable.cols.length){return this.jsonTable.cols[columnIndex][name];}
return null;}
pentaho.DataView=function(dataTable){this.dataTable=dataTable;this.rows=null;this.columns=null;this.className="pentaho.DataView";}
pentaho.DataView.prototype.setRows=function(rows){this.rows=rows;}
pentaho.DataView.prototype.setColumns=function(columns){this.columns=columns;}
pentaho.DataView.prototype.getColumnRange=function(columnIdx,options){var min;var max;var set=false;var key=options&&options.key;for(var rowNo=0;rowNo<this.getNumberOfRows();rowNo++){var value=this.getValue(rowNo,columnIdx);if(value!=null){if(key){value=key(value);}
if(!set){min=value;max=value;set=true;}else{if(value<min){min=value;}
if(value>max){max=value;}}}}
var range={min:min,max:max}
return range;}
pentaho.DataView.prototype.getDistinctValues=function(columnIdx){var values=[];var valueMap={};for(var rowNo=0;rowNo<this.getNumberOfRows();rowNo++){var value=this.getValue(rowNo,columnIdx);if(!valueMap[value]){valueMap[value]=true;values.push(value);}}
return values;}
pentaho.DataView.prototype.getDistinctFormattedValues=function(columnIdx){var values=[];var valueMap={};for(var rowNo=0;rowNo<this.getNumberOfRows();rowNo++){var value=this.getFormattedValue(rowNo,columnIdx);if(!valueMap[value]){valueMap[value]=true;values.push(value);}}
return values;}
pentaho.DataView.prototype.hideColumns=function(columns){tmpCols=[];for(var columnIdx=0;columnIdx<this.getNumberOfColumns();columnIdx++){tmpCols.push(columnIdx);}
for(var idx=columns.length-1;idx>-1;idx--){tmpCols.splice(columns[idx],1)}
this.columns=tmpCols;}
pentaho.DataView.prototype.getNumberOfRows=function(){return this.rows==null?this.dataTable.getNumberOfRows():this.rows.length;}
pentaho.DataView.prototype.getNumberOfColumns=function(){return this.columns==null?this.dataTable.getNumberOfColumns():this.columns.length;}
pentaho.DataView.prototype.getColumnId=function(columnIdx){return this.columns==null?this.dataTable.getColumnId(columnIdx):this.dataTable.getColumnId(this.columns[columnIdx]);}
pentaho.DataView.prototype.getColumnLabel=function(columnIdx){return this.columns==null?this.dataTable.getColumnLabel(columnIdx):this.dataTable.getColumnLabel(this.columns[columnIdx]);}
pentaho.DataView.prototype.getColumnType=function(columnIdx){return this.columns==null?this.dataTable.getColumnType(columnIdx):this.dataTable.getColumnType(this.columns[columnIdx]);}
pentaho.DataView.prototype.getValue=function(rowNo,colNo){var rowIdx=this.rows==null?rowNo:this.rows[rowNo];var colIdx=this.columns==null?colNo:this.columns[colNo];if(rowIdx.length&&rowIdx[0]=='combine'){var type=this.getColumnType(colNo);var value
for(var idx=0;idx<rowIdx[1].length;idx++){if(idx==0){value=this.dataTable.getValue(rowIdx[1][idx],colIdx);}
else if(type=='string'){value+=' + '+this.dataTable.getValue(rowIdx[1][idx],colIdx);}
else if(type=='number'){value+=this.dataTable.getValue(rowIdx[1][idx],colIdx);}}
return value;}
return this.dataTable.getValue(rowIdx,colIdx);}
pentaho.DataView.prototype._getCell=function(rowNo,colNo){var rowIdx=this.rows==null?rowNo:this.rows[rowNo];var colIdx=this.columns==null?colNo:this.columns[colNo];return this.dataTable._getCell(rowIdx,colIdx);}
pentaho.DataView.prototype.getFormattedValue=function(rowNo,colNo){var rowIdx=this.rows==null?rowNo:this.rows[rowNo];var colIdx=this.columns==null?colNo:this.columns[colNo];if(rowIdx.length&&rowIdx[0]=='combine'){var type=this.getColumnType(colNo);var value
for(var idx=0;idx<rowIdx[1].length;idx++){if(idx==0){value=this.dataTable.getFormattedValue(rowIdx[1][idx],colIdx);}
else if(type=='string'){value+=' + '+this.dataTable.getFormattedValue(rowIdx[1][idx],colIdx);}
else if(type=='number'){value+=this.dataTable.getFormattedValue(rowIdx[1][idx],colIdx);}}
return value;}
return this.dataTable.getFormattedValue(rowIdx,colIdx);}
pentaho.DataView.prototype.toDataTable=function(){var cols=[];for(var colIdx=0;colIdx<this.getNumberOfColumns();colIdx++){col={type:this.getColumnType(colIdx),id:this.getColumnId(colIdx),label:this.getColumnLabel(colIdx)}
cols.push(col);}
var rows=[];for(var rowIdx=0;rowIdx<this.getNumberOfRows();rowIdx++){cells=[];for(var colIdx=0;colIdx<this.getNumberOfColumns();colIdx++){var cell=this._getCell(rowIdx,colIdx);cells.push(cell);}
row={c:cells};rows.push(row);}
var json={cols:cols,rows:rows};var table=new pentaho.DataTable(json);return table;}
pentaho.DataView.prototype.setColumnProperty=function(columnIndex,name,value){this.dataTable.setColumnProperty(columnIndex,name,value);}
pentaho.DataView.prototype.getColumnProperty=function(columnIndex,name){return this.dataTable.getColumnProperty(columnIndex,name);};(function(){function argRequired(name){return new Error("Argument '"+name+"' is required.");}
function argInvalid(name,text){return new Error("Argument '"+name+"' is invalid."+(text?(" "+text):""));}
pentaho.DataView.prototype.createTrend=pentaho.DataTable.prototype.createTrend=function(trendArgs){if(!(trendArgs instanceof Object)){throw argRequired('trendArgs');}
var trendType=trendArgs.type;if(!trendType){throw argRequired('trendArgs.type');}
trendType=''+trendType;var trendInfo=pentaho.trends.get(trendType,true);var colCount=this.getNumberOfColumns();var xIndex=trendArgs.x;if(xIndex==null){throw argRequired('trendArgs.x');}
xIndex=+xIndex;if(isNaN(xIndex)){throw argInvalid('trendArgs.x',"Not a number.");}
if(xIndex<0||xIndex>=colCount){throw argInvalid('trendArgs.x',"Out of range.");}
var yIndex=trendArgs.y;if(yIndex==null){throw argRequired('trendArgs.y');}
yIndex=+yIndex;if(isNaN(yIndex)){throw argInvalid('trendArgs.y',"Not a number.");}
if(yIndex<0||yIndex>=colCount){throw argInvalid('trendArgs.y',"Out of range.");}
if(this.getColumnType(yIndex)!=='number'){throw argInvalid('trendArgs.y',"Must be a numeric column.");}
var trendName=trendArgs.name||(trendType+"Trend");var trendLabel=trendArgs.label||(trendArgs.name?trendName:trendInfo.label);var trendOptions=trendArgs.options||{};var table=(this.dataTable||this).jsonTable;var trendIndex=table.cols.length;table.cols.push({type:'number',id:trendName,label:trendLabel});var isXDiscrete=this.getColumnType(xIndex)!=='number';var rowIndexesEnumtor=this.getRowIndexEnumerator();var me=this;var funX=isXDiscrete?null:function(i){return me.getValue(i,xIndex);};var funY=function(i){return me.getValue(i,yIndex);};var options=Object.create(trendOptions);options.rows=rowIndexesEnumtor;options.x=funX;options.y=funY;var trendModel=trendInfo.model(options);if(!trendModel){dojo.forEach(table.rows,function(row){row.c[trendIndex]={v:null};});return false;}
dojo.forEach(table.rows,function(row,i){var trendX=funX?funX(i):i;var trendY=trendX!=null?trendModel.sample(trendX,funY(i),i):null;row.c[trendIndex]={v:trendY};});return true;};pentaho.DataView.prototype.getRowIndexEnumerator=pentaho.DataTable.prototype.getRowIndexEnumerator=function(){var index=-1;var count=this.getNumberOfRows();var enumtor={item:undefined,next:function(){if(index<count-1){enumtor.item=++index;return true;}
if(enumtor.item){enumtor.item=undefined;}
return false;}};return enumtor;};var _trends={};pentaho.trends={};pentaho.trends.define=function(type,spec){if(!type){throw argRequired('type');}
type=''+type;if(!spec){throw argRequired('spec');}
var model=spec.model;if(!model){throw argRequired('spec.model');}
if(typeof model!=='function'){throw argInvalid('spec.model',"Not a function");}
var label=spec.label;if(!label){label=type.chartAt(0).toUpperCase()+type.substr(1)+" Trend";}
var trendInfo={type:type,label:label,model:model};_trends[type]=trendInfo;};pentaho.trends.get=function(type,assert){if(!type){throw argRequired('type');}
var trendInfo=_trends.hasOwnProperty(type)?_trends[type]:null;if(!trendInfo&&assert){throw argInvalid('type',"There is no trend type named '"+type+"'.");}
return trendInfo;};pentaho.trends.types=function(){var ret=[];for(var p in _trends){if(Object.prototype.hasOwnProperty.call(_trends,p)){ret.push(p);}}
return ret;};function parseNum(value){return value!=null?(+value):NaN;}
pentaho.trends.define('linear',{label:'Linear trend',model:function(options){var rowsQuery=options.rows;var funX=options.x;var funY=options.y;var i=0;var N=0;var sumX=0;var sumY=0;var sumXY=0;var sumXX=0;while(rowsQuery.next()){var row=rowsQuery.item;var x=funX?parseNum(funX(row)):i;if(!isNaN(x)){var y=parseNum(funY(row));if(!isNaN(y)){N++;sumX+=x;sumY+=y;sumXY+=x*y;sumXX+=x*x;}}
i++;}
var alpha,beta;if(N>=2){var avgX=sumX/N;var avgY=sumY/N;var avgXY=sumXY/N;var avgXX=sumXX/N;var den=(avgXX-avgX*avgX);if(den===0){beta=0;}else{beta=(avgXY-(avgX*avgY))/den;}
alpha=avgY-beta*avgX;return{alpha:alpha,beta:beta,reset:function(){},sample:function(x){return alpha+beta*(+x);}};}}});}());
pentaho=typeof pentaho=="undefined"?{}:pentaho;pentaho.events={};pentaho.events.listeners=[];pentaho.events.trigger=function(object,eventName,args){for(var lNo=0;lNo<pentaho.events.listeners.length;lNo++){if(pentaho.events.listeners[lNo].object==object&&pentaho.events.listeners[lNo].eventName==eventName){pentaho.events.listeners[lNo].func(args);}}}
pentaho.events.addListener=function(object,eventName,func){pentaho.events.listeners.push({object:object,eventName:eventName,func:func});}
pentaho.events.removeListener=function(object,eventName){var lNo=0;while(lNo<pentaho.events.listeners.length){if(pentaho.events.listeners[lNo].object==object&&pentaho.events.listeners[lNo].eventName==eventName){pentaho.events.listeners.splice(lNo,1);}else{lNo++;}}}
pentaho.events.removeSource=function(object){var lNo=0;while(lNo<pentaho.events.listeners.length){if(pentaho.events.listeners[lNo].object==object){pentaho.events.listeners.splice(lNo,1);}else{lNo++;}}}
(function($){$.ga={};$.ga.load=function(uid,callback){jQuery.ajax({type:'GET',url:(document.location.protocol=="https:"?"https://ssl":"http://www")+'.google-analytics.com/ga.js',cache:true,success:function(){if(typeof _gat==undefined){throw"_gat has not been defined";}t=_gat._createTracker(uid);bind();if($.isFunction(callback)){callback(t)}t._trackPageview()},dataType:'script',data:null})};var t;var bind=function(){if(noT()){throw"pageTracker has not been defined";}for(var $1 in t){if($1.charAt(0)!='_')continue;$.ga[$1.substr(1)]=t[$1]}};var noT=function(){return t==undefined}})(jQuery);
var googleAnalyticsComponent=BaseComponent.extend({update:function(){jQuery.globalEval('$(document).ready( function() { $.ga.load("'+this.gaTrackingId+'"); } );');}});
var DuplicateComponent=BaseComponent.extend({update:function(){var myself=this,ph=$("#"+myself.htmlObject).empty(),link=$("<a href='javascript:;'>Duplicate</a>");link.click(function(){myself.duplicate();});link.appendTo(ph);},duplicate:function(parameterValues){var myself=this;var cdePrefix="render_";parameterValues=parameterValues||{};if(!Dashboards.duplicateIndex){Dashboards.duplicateIndex=0;}
Dashboards.duplicateIndex+=1;var suffix="_"+Dashboards.duplicateIndex;var params={};$.each(myself.parameters,function(i,p){var param=p+suffix;Dashboards.setBookmarkable(param,Dashboards.isBookmarkable(p));Dashboards.setParameter(param,parameterValues[p]||Dashboards.getParameterValue(p));params[p]=param;});var comps={};$.each(myself.components,function(i,c){var comp=c+suffix;comps[c]=comp;});for(c in myself.components){var cName=myself.components[c];cName=RegExp("^"+cdePrefix).test(cName)?cName:cdePrefix+cName;var component=Dashboards.getComponent(cName);if(component){var htmlRemap={};var newPh=$("#"+component.htmlObject).clone();newPh.attr("id",component.htmlObject+suffix);newPh.find("[id]").each(function(i,e){$e=$(e);$e.attr("id",$e.attr("id")+suffix);});if(myself.targetContainer){newPh.appendTo('#'+myself.targetContainer);}else{newPh.insertAfter('#'+myself.targetHtmlObject);}
htmlRemap[component.htmlObject]=newPh.attr('id').replace(/([^\\])\$/g,'$1\\$');var clone=component.clone(params,comps,htmlRemap);clone.name=clone.name+suffix;window[clone.name]=clone;Dashboards.addComponents([clone]);Dashboards.update(clone);}}},clone:function(parameterRemap,componentRemap,htmlRemap){Dashboards.log("This function is deprecated. Please use targetComponent.clone(...), see BaseComponent in CDF (core.js) for more details.","warn");var that=this.base(parameterRemap,componentRemap,htmlRemap);that.targetHtmlObject=htmlRemap[that.targetHtmlObject];if(that.parameters){that.parameters=that.parameters.map(function(param){if(param in parameterRemap){return parameterRemap[param];}else{return param;}});}
return that;}});
if(typeof pv=='undefined'||typeof pv.listenForPageLoad=='undefined'){window.pv={};pv.renderer=function(){return(typeof window.svgweb==="undefined")?"nativesvg":"svgweb";};pv.listenForPageLoad=function(listener){if(document.readyState==="complete"){listener();}
if(pv.renderer()=="svgweb"){window.addEventListener("SVGLoad",listener,false);}else{if(document.addEventListener){window.addEventListener("load",listener,false);}else if(document.attachEvent){window.attachEvent("onload",listener);}}};}
var CggComponent=BaseComponent.extend({ph:null,relComp:null,getScriptUrl:function(){return this.resourceFile;},getOutputType:function(){return'svg';},update:function(){var url=wd.helpers.cggHelper.getCggDrawUrl(),data=this.processParams(),script=this.getScriptUrl(),myself=this,ph=$('#'+myself.htmlObject);pv.listenForPageLoad(function(){$.ajax({url:url,data:data,type:'get',success:function(xmlData){ph.empty();try{ph[0].appendChild(document.importNode(xmlData.lastChild,true));ph.find("svg").width(myself.width).height(myself.height);}catch(e){var obj=myself.createObj(url,script,data,myself.width,myself.height);ph[0].innerHTML=arguments[2].responseText;ph.find("svg").width(myself.width).height(myself.height);}},error:function(){ph.empty();if(pv.renderer()==="svgweb"){var obj=myself.createObj(url,script,data,myself.width,myself.height,true);svgweb.appendChild(obj,ph[0]);}}});});},processParams:function(){var data={};this._processParametersCore(data);var level=this.dashboard.debug;if(level>1){data.paramdebug=true;data.paramdebugLevel=level;}
data.script=escape(this.getScriptUrl());data.outputType=this.getOutputType()||'svg';return data;},_processParametersCore:function(data){var dash=this.dashboard;var params=this.parameters;for(var i=0,L=params.length;i<L;i++){var param=params[i];var value=dash.getParameterValue(param[1]);if($.isArray(value)&&value.length==1&&(''+value[0]).indexOf(';')>=0){value=doCsvQuoting(value[0],';');}
data["param"+param[0]]=value;}},objectUrl:function(baseUrl,script,params){var objUrl=baseUrl+'?',pArray=[];for(var p in params){if(params.hasOwnProperty(p)){pArray.push(escape(p)+'='+escape(params[p]));}}
objUrl+='&'+pArray.join('&');return objUrl;},createObj:function(url,script,data,width,height,svgweb){var obj=(svgweb?document.createElement('object',true):document.createElement('object'));obj.setAttribute('type','image/svg+xml');obj.setAttribute('data',this.objectUrl(url,script,data));obj.setAttribute('width',width);obj.setAttribute('height',height);return obj;}});var CggDialComponent=CggComponent.extend({script:"system/pentaho-cdf-dd/resources/custom/components/cgg/charts/dial.js",getScriptUrl:function(){return this.script;},getOutputType:function(){return'svg';},_processParametersCore:function(data){data.paramvalue=this.dashboard.getParameterValue(this.parameter);data.paramcolors=this.colors;data.paramscale=this.intervals;}});
if(typeof pv=='undefined'||typeof pv.listenForPageLoad=='undefined'){window.pv={};pv.renderer=function(){return(typeof window.svgweb==="undefined")?"nativesvg":"svgweb";};pv.listenForPageLoad=function(listener){if(document.readyState==="complete"){listener();}
if(pv.renderer()=="svgweb"){window.addEventListener("SVGLoad",listener,false);}else{if(document.addEventListener){window.addEventListener("load",listener,false);}else if(document.attachEvent){window.attachEvent("onload",listener);}}};}
var CggComponent=BaseComponent.extend({ph:null,relComp:null,getScriptUrl:function(){return this.resourceFile;},getOutputType:function(){return'svg';},update:function(){var url=wd.helpers.cggHelper.getCggDrawUrl(),data=this.processParams(),script=this.getScriptUrl(),myself=this,ph=$('#'+myself.htmlObject);pv.listenForPageLoad(function(){$.ajax({url:url,data:data,type:'get',success:function(xmlData){ph.empty();try{ph[0].appendChild(document.importNode(xmlData.lastChild,true));ph.find("svg").width(myself.width).height(myself.height);}catch(e){var obj=myself.createObj(url,script,data,myself.width,myself.height);ph[0].innerHTML=arguments[2].responseText;ph.find("svg").width(myself.width).height(myself.height);}},error:function(){ph.empty();if(pv.renderer()==="svgweb"){var obj=myself.createObj(url,script,data,myself.width,myself.height,true);svgweb.appendChild(obj,ph[0]);}}});});},processParams:function(){var data={};this._processParametersCore(data);var level=this.dashboard.debug;if(level>1){data.paramdebug=true;data.paramdebugLevel=level;}
data.script=escape(this.getScriptUrl());data.outputType=this.getOutputType()||'svg';return data;},_processParametersCore:function(data){var dash=this.dashboard;var params=this.parameters;for(var i=0,L=params.length;i<L;i++){var param=params[i];var value=dash.getParameterValue(param[1]);if($.isArray(value)&&value.length==1&&(''+value[0]).indexOf(';')>=0){value=doCsvQuoting(value[0],';');}
data["param"+param[0]]=value;}},objectUrl:function(baseUrl,script,params){var objUrl=baseUrl+'?',pArray=[];for(var p in params){if(params.hasOwnProperty(p)){pArray.push(escape(p)+'='+escape(params[p]));}}
objUrl+='&'+pArray.join('&');return objUrl;},createObj:function(url,script,data,width,height,svgweb){var obj=(svgweb?document.createElement('object',true):document.createElement('object'));obj.setAttribute('type','image/svg+xml');obj.setAttribute('data',this.objectUrl(url,script,data));obj.setAttribute('width',width);obj.setAttribute('height',height);return obj;}});var CggDialComponent=CggComponent.extend({script:"system/pentaho-cdf-dd/resources/custom/components/cgg/charts/dial.js",getScriptUrl:function(){return this.script;},getOutputType:function(){return'svg';},_processParametersCore:function(data){data.paramvalue=this.dashboard.getParameterValue(this.parameter);data.paramcolors=this.colors;data.paramscale=this.intervals;}});
var BogusComponent=BaseComponent.extend({update:function(){if(this.parameters==undefined){this.parameters=[];}
$("#"+this.htmlObject).empty();var myself=this;this.customfunction(this.parameters);}});
var wd=wd||{};wd.components=wd.components||{};wd.components.olapSelector=wd.components.olapSelector||{};var OlapSelectorModel=Backbone.Model.extend({defaults:{"title":"","search":true,"multiselect":true,"multilevelselect":true,"deselectDescendants":false,"searchterm":"","collapsed":true,"values":null,"level":"","paginate":true,"pageStart":0,"pageSize":42,"morePages":false,"totalRecords":0,"mode":"level",olapUtils:null,"levels":null,"breadcrumb":[],"preselected":[],"parameters":[]},initialize:function(){var values=new Backbone.Collection();this.set("values",values);values.comparator=function(left,right){var leftLevel=left.get("level"),rightLevel=right.get("level"),leftMember=left.get("name"),rightMember=right.get("name"),cmpLevel=leftLevel.localeCompare(rightLevel),cmpMember=leftMember.localeCompare(rightMember);return cmpLevel!=0?cmpLevel/Math.abs(cmpLevel):cmpMember!=0?cmpMember/Math.abs(cmpMember):0;};values.model=OptionModel;this.updateValues();this.set("levels",new Backbone.Collection());var levels=this.get("levels");levels.model=LevelModel;this.updateLevels();this.processLevelSelection();levels.on("change:selected",this.processLevelSelection,this);this.setupEvents();this.preSelectValues();},preSelectValues:function(){var myself=this,olapUtils=this.get("olapUtils"),defaultSelect=myself.get("preselected"),levelsArray=myself.get("levels");for(var i=0;i<levelsArray.length;i++){options={pageSize:this.get("pageSize"),pageStart:this.get("pageStart"),searchTerm:this.get("searchterm"),level:levelsArray.at(i).get("name")};olapUtils.getPaginatedLevelMembers(options,function(v){var toChange=myself.processPreSelectValues(v.members,defaultSelect);myself.addPreSelectValues(toChange,myself);});}},processPreSelectValues:function(members,defaultVals){var values=[],selectedLevelDepth=this.getSelectedLevels().at(0).get("depth"),memberDepth;if(!defaultVals.length){return members;}
for(var c=0;c<members.length;c++){level=members[c];memberDepth=(level.qualifiedName.split(".").length-1);for(var p=0;p<defaultVals.length;p++){if(level.qualifiedName===defaultVals[p]){level.selected=true;values.push(level);break;}else if(selectedLevelDepth===memberDepth){values.push(level);break;}}}
return values;},addPreSelectValues:function(toChange,myself){var newValue,values=myself.get("values");for(c=0;c<toChange.length;c++){var newValue=toChange[c],depth;depth=(newValue.qualifiedName.split(".").length-2);newValue.level=myself.get("levels").at(depth).id;values.add(newValue,{silent:true});}
values.trigger("add");},updateLevels:function(){var olapUtils=this.get("olapUtils"),h=olapUtils.getHierarchy();if(h.hasAll){var allMember={name:h.defaultMember,qualifiedName:h.defaultMemberQualifiedName,allMember:true}
this.get("levels").add(allMember);}
this.get("levels").add(olapUtils.getLevels(),{silent:true});},processLevelSelection:function(evt){if(this.getSelectedLevels().length==0){if(evt==null){this.get("levels").at(0).set({"selected":true});}
else{evt.set({selected:true});}
return;}
if(this.getSelectedLevels().size()>1){_(this.getSelectedLevels().without(evt)).each(function(f){f.set({selected:false})});this.set("pageStart",0);return;}},getSelectedLevels:function(){return new Backbone.Collection(this.get("levels").where({selected:true}));},setupEvents:function(){var values=this.get("values");values.on("change:selected",this.updateSelection,this);values.on("change:drill",this.drillDown,this);this.on("page",this.fetchValues,this,this);this.on("change:collapsed",this.handleCollapse,this);this.on("change:searchterm",this.updateSearch,this);this.on("drillUp",this.drillUp,this);this.get("levels").on("select",this.changeLevel,this);},handleCollapse:function(m,isCollapsed){if(isCollapsed){return;}
var oldValues=this.get("values").where({selected:true}).map(function(e){return e.get("qualifiedName");});this.set("oldValues",oldValues);},apply:function(){this.toggleCollapsed();},cancel:function(){var oldValues=this.get("oldValues");this.get("values").each(function(e){e.set("selected",oldValues.indexOf(e.get("qualifiedName"))>-1);});this.get("values").trigger("select");this.toggleCollapsed();},drillDown:function(m,drill){this.get("breadcrumb").push(m);var levels=this.get("levels"),olapUtils=this.get("olapUtils"),defaultQualified=olapUtils.getHierarchy().defaultMemberQualifiedName,atTopLevel,selectedLevel=levels.where({selected:true})[0],qualifiedName=selectedLevel.get("qualifiedName"),idx=levels.indexOf(selectedLevel);selectedLevel.set("selected",false);atTopLevel=qualifiedName==defaultQualified;if(atTopLevel){levels.at(idx+2).set("selected",true);}else{levels.at(idx+1).set("selected",true);}
this.set("pageStart",0,{silent:true});this.trigger("drill");this.fetchValues();},drillUp:function(){var crumbtrail=this.get("breadcrumb");if(crumbtrail.length){crumbtrail.pop();var levels=this.get("levels"),selectedLevel=levels.where({selected:true})[0],idx=levels.indexOf(selectedLevel);selectedLevel.set("selected",false);this.set("pageStart",0,{silent:true});levels.at(idx-1).set("selected",true);this.trigger("drill");this.fetchValues();}},changeLevel:function(m,value){if(m&&value===false){return;}
this.set("breadcrumb",[]);this.trigger("drill");this.set("pageStart",0);this.fetchValues();},fetchValues:function(m,value){var selectedLevel=this.get("levels").where({selected:true})[0],olapUtils=this.get("olapUtils"),options={pageSize:this.get("pageSize"),pageStart:this.get("pageStart"),searchTerm:this.get("searchterm")},breadcrumb=this.get("breadcrumb"),level;if(breadcrumb&&breadcrumb.length){var l=breadcrumb.length-1;options.startMember=breadcrumb[l].get("qualifiedName");}
level=selectedLevel?selectedLevel.get("name"):"";if(!level||level==olapUtils.getHierarchy().defaultMember){options.level=olapUtils.getLevels()[0].name;}else{options.level=level;}
paramArray=this.get("parameters");if(paramArray.length>0){var nameArray=_.keys(paramArray);for(pos=0;pos<paramArray.length;pos++){options[nameArray[pos]]=paramArray[nameArray[pos]];}}
var myself=this;this.get("olapUtils").getPaginatedLevelMembers(options,function(v){myself.set("morePages",v.more);myself.addPage(v.members);});},addPage:function(newValues){var v,newValue,idx=this.get("pageStart");values=this.get("values");for(v=0;v<newValues.length;v++){var newValue=newValues[v],found;newValue.level=this.getSelectedLevels().at(0).get("qualifiedName");found=values.detect(function(model){return model.get("level")==newValue.level&&model.get("qualifiedName")==newValue.qualifiedName;});if(!found){values.add(newValue,{silent:true});}}
values.trigger("add");},nextPage:function(){if(!this.get("morePages")){return;}
var start=this.get("pageStart"),size=this.get("pageSize");this.set("pageStart",start+size);this.trigger("page");},prevPage:function(){if(this.get("pageStart")==0){return;}
var start=this.get("pageStart"),size=this.get("pageSize");this.set("pageStart",Math.max(0,start-size));this.trigger("page");},firstPage:function(){if(this.get("pageStart")==0){return;}
this.set("pageStart",0);this.trigger("page");},lastPage:function(){var total=this.get("totalRecords"),size=this.get("pageSize");this.set("pageStart",total-total%size);this.trigger("page");},goToPage:function(page){var size=this.get("pageSize");this.set("pageStart",page*size);this.trigger("page");},updateValues:function(values){this.get("values").reset(values);},updateSelection:function(m,selected){if(!selected){return}
var isMultiselect=this.get("multiselect"),deselectDescendants=this.get("deselectDescendants"),isMultilevel=this.get("multilevelselect"),selectedLevel=this.getSelectedLevels().at(0).get("qualifiedName"),memberName=m.get("qualifiedName");_(this.get("values").without(m)).each(function(other){if(!isMultiselect){other.set("selected",false);}
if(deselectDescendants&&other.get("qualifiedName").indexOf(memberName)>-1){other.set("selected",false);}
if(!isMultilevel&&selectedLevel!=other.get("level")){other.set("selected",false);}});},clearSelection:function(){this.get("values").each(function(m){m.set("selected",false);})},toggleCollapsed:function(predicate){this.set("collapsed",(_.isBoolean(predicate))?predicate:!this.get("collapsed"));},selectedValues:function(){return _(this.get("values").where({selected:true})).map(function(m){return m.get("value")});},updateSearch:function(){var term=this.get("searchterm");this.set("pageStart",0,{silent:true});this.fetchValues();},notifyUpdate:function(){this.trigger('notify',this);}});var OptionModel=Backbone.Model.extend({defaults:{"idx":0,"name":"","value":null,"level":null,"drill":false,"selected":false},toggleSelected:function(){this.set("selected",!this.get("selected"));}});var LevelModel=OptionModel.extend({defaults:{},initialize:function(o){this.on("change:qualifiedName change:name",function(o){wd.log("Detected changes");this.set("id",o.get("qualifiedName"));this.set("label",o.get("name"));});this.set("id",this.get("qualifiedName"));this.set("label",this.get("name"));}});var OlapSelectorView=Backbone.View.extend({events:{"click .title":"toggleCollapsed","click .first":"firstPage","click .prev":"prevPage","click .next":"nextPage","click .last":"lastPage","click .pages span":"goToPage","change .search input":"updateSearch","click .validate":"apply","click .cancel":"cancel","click .breadcrumb .name":"drillUp"},levelViews:[],renderLevels:function(){var levelContainer=this.$el.find(".levels").empty();_(this.levelViews).each(function(v){levelContainer.append(v.render().el);});},initialize:function(){this.initializeOptions();this.configureListeners();this.levelViews=[];this.model.get("levels").each(function(m){this.levelViews.push(new LevelView({model:m}));},this);},configureListeners:function(){this.model.on("change",this.render,this);this.model.on("drill",this.renderCrumbtrail,this);this.model.on("change:collapsed",this.updateCollapsed,this);this.model.on("page",this.renderPages,this);var values=this.model.get("values");values.on("add remove reset",this.updateOptions,this)
values.on("select",this.updateOptions,this);values.on("notify",this.notifyUpdate,this);},initializeOptions:function(){this._selectedViews=[];this._selectedViewsOut=[];this._optionViews=[];this.model.get("values").each(function(m){this._optionViews.push(new OptionView({model:m}));if(m.get("selected")){this._selectedViews.push(new SelectionView({model:m}));this._selectedViewsOut.push(new SelectionViewOut({model:m}));}},this);},updateSearch:function(evt){this.model.set("searchterm",evt.target.value);},render:function(){this.$el.html(templates.olapSelector.main(this.model.toJSON()));this.renderLevels();this.updateCollapsed();this.renderLevels();this.renderOptions();this.renderPages();this.renderCrumbtrail();this.delegateEvents();},renderCrumbtrail:function(){var currentLevelName=this.model.get("levels").where({selected:true})[0].get("name"),crumbtrail=this.model.get("breadcrumb");if(crumbtrail.length>0){var breadcrumb=crumbtrail[crumbtrail.length-1];this.$el.find(".breadcrumb").html(templates.olapSelector.crumbtrail({level:currentLevelName,name:breadcrumb.get("name")}));}else{this.$el.find(".breadcrumb").empty();}},renderPages:function(){var m=this.model;this.$el.find(".pagination .next").toggleClass("disabled",!m.get("morePages"));this.$el.find(".pagination .prev").toggleClass("disabled",!m.get("pageStart"));this.$el.find(".pagination .first").toggleClass("disabled",!m.get("pageStart"));},renderOptions:function(){var optionContainer=this.$el.find(".rightArea .options").empty(),selectionContainer=this.$el.find(".leftArea .selection").empty(),selectionContainerOut=this.$el.find(".outsideArea .selection").empty(),myself=this,minIdx=this.model.get('pageStart'),maxIdx=this.model.get('pageStart')+this.model.get('pageSize');_(this._optionViews).chain().filter(this.isVisible,this).slice(minIdx,maxIdx).each(function(v){optionContainer.append(v.render().el);},this);_(this._selectedViewsOut).each(function(v){selectionContainerOut.append(v.render().el);});_(this._selectedViews).each(function(v){selectionContainer.append(v.render().el);});},updateOptions:function(){this.initializeOptions();this.renderOptions();this.highlightParents();},notifyUpdate:function(){this.model.toggleCollapsed(false);this.model.toggleCollapsed(true);},isVisible:function(view){var parentModel=this.model,model=view.model,levelVisible=parentModel.getSelectedLevels().at(0).get("id")==model.get("level"),searchTerm=parentModel.get("searchterm"),searchVisible=searchTerm==null||RegExp(searchTerm,"i").test(model.get("name")),drillTerm=_.last(parentModel.get("breadcrumb")),drillVisible=drillTerm==null||model.get("qualifiedName").indexOf(drillTerm.get("qualifiedName"))>-1;return levelVisible&&searchVisible&&drillVisible;},highlightParents:function(){var parentModel=this.model,selectedMembers=parentModel.get("values").where({selected:true}).map(function(m){return m.get("qualifiedName");});_(this._optionViews).each(function(v){var name=v.model.get("qualifiedName");var childrenSelected=_(selectedMembers).chain().without(v.model.get("qualifiedName")).filter(function(m){return m.indexOf(name)>-1;}).value();v.$el.toggleClass("highlight",childrenSelected.length>0);if(childrenSelected.length>0){v.$el.find(".drill-down .label").text(childrenSelected.length);}else{v.$el.find(".drill-down .label").html("&nbsp;");}},this);},toggleSelected:function(m,selected){var vInner,vOuter,v;if(selected){vInner=new SelectionView({model:m});this.$el.find(".leftArea .selection").append(vInner.render().el);this._selectedViews.push(vInner);vOuter=new SelectionViewOut({model:m});this.$el.find(".outsideArea .selection").append(vOuter.render().el);this._selectedViews.push(vOuter);}else{v=_(this._selectedViews).filter(function(v){return v.model===m});var myself=this;_.each(v,function(e){e.remove();myself._selectedViews=_(myself._selectedViews).without(e);});v=_(this._selectedViewsOut).filter(function(v){return v.model===m});var myself=this;_.each(v,function(e){e.remove();myself._selectedViewsOut=_(myself._selectedViewsOut).without(e);});}},drillUp:function(){this.model.trigger("drillUp");},cancel:function(){this.model.cancel();},apply:function(){this.model.apply();},toggleCollapsed:function(){this.model.toggleCollapsed();},updateCollapsed:function(){$('.olapSelectorComponent').addClass('collapsed').removeClass('expanded');if(this.model.get("collapsed")){this.$el.find('.olapSelectorComponent').addClass('collapsed').removeClass('expanded');}else{this.$el.find('.olapSelectorComponent').removeClass('collapsed').addClass('expanded');var optionList=this.$el.find(".optionList"),minimumMargin=10,topEdge=optionList.offset().top,bottomEdge=topEdge+optionList.outerHeight(),topLimit=$(window).scrollTop(),bottomLimit=topLimit+$(window).height(),offset=bottomEdge<=bottomLimit?0:bottomLimit-bottomEdge-minimumMargin;offset=topEdge-offset>=topLimit?offset:topLimit-topEdge+minimumMargin;console.log("Offset is "+offset+" after correction");optionList.css("top",(optionList.position().top+offset)+"px");}},nextPage:function(){this.model.nextPage();},prevPage:function(){this.model.prevPage();},firstPage:function(){this.model.firstPage();},lastPage:function(){this.model.lastPage();},goToPage:function(evt){var page=$(evt.target).attr("data-page");this.model.goToPage(page);}});var OptionView=Backbone.View.extend({tagName:"span",template:null,events:{"click .target":"toggleSelection","click .drill-down":"drillDown"},initialize:function(){this.setTemplate();this.model.on("change:selected",this.updateSelectionDisplay,this);},setTemplate:function(){this.template=templates.olapSelector.option},drillDown:function(){var val=this.model.get("drill");this.model.set("drill",!val);},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.addClass('item');this.updateSelectionDisplay();this.delegateEvents();return this;},toggleSelection:function(){this.model.toggleSelected();this.model.trigger("select");},updateSelectionDisplay:function(){if(this.model.get('selected')){this.$el.addClass('selected');}else{this.$el.removeClass('selected');}}});var LevelView=OptionView.extend({tagName:"span",template:null,setTemplate:function(){this.template=templates.olapSelector.level;}});var SelectionView=Backbone.View.extend({tagName:"li",events:{"click .remove":"unselect"},render:function(){this.$el.html(templates.olapSelector.picked(this.model.toJSON()));this.delegateEvents();return this;},unselect:function(){this.model.set("selected",false);this.model.trigger("select");}});var SelectionViewOut=SelectionView.extend({unselect:function(){this.model.set("selected",false);this.model.trigger("select");this.model.trigger("notify");}});var templates=templates||{};templates.olapSelector={};templates.olapSelector.main=Mustache.compile("<div class='olapSelectorComponent'>"+" <div class='pulldown'>"+"   <div class='title'>{{title}}</div>"+"     <div class='optionList'>"+"       <div class='leftArea'>"+"         <div class='header'>Select Level</div>"+"         <div class='levels'></div>"+"         <div class='selectionPanel'>"+"           <div class='label'>Selected Filters</div>"+"           <ul class='selection'></ul>"+"         </div>"+"       </div>"+"       <div class='rightArea {{#paginate}}paginate{{/paginate}}'>"+"         <div class='header'>"+"<div class='breadcrumb'>Breadcrumb &#x21FE; Content</div>"+"<div class='search'>"+"             <input type='text' placeholder='Search...' value='{{searchterm}}'/>"+"             <div class='cancel'>&nbsp;</div>"+"           </div>"+"         </div>"+"         <div class='options'></div>"+"         <div class='paginationContainer'>"+"           <div class='pagination'>"+"             <div class='prev paginateButton'>Previous Page<div class='arrow'>&nbsp;</div></div>"+"             <div class='next paginateButton'>Next Page<div class='arrow'>&nbsp;</div></div>"+"           </div>"+"         </div>"+"         <div class='footer'>"+"           <div class='button cancel'>Cancel</div>"+"           <div class='button validate'>Apply</div>"+"         </div>"+"       </div>"+"     </div>"+" </div>"+" <div class='outsideArea'>"+"   <ul class='selection'></ul>"+" </div>"+"</div>");templates.olapSelector.option=Mustache.compile("<div class='target'>"+" <span class='name' title='{{name}}'>{{name}}</span>"+" <span class='check'>&nbsp;</span>"+"</div>"+"<div class='drill-down'><span class='label'>&nbsp;</span></div>");templates.olapSelector.picked=Mustache.compile("<div class='target'>"+"  <span class='name' title='{{name}}'>{{name}}</span>"+"  <div class='remove'>&nbsp;</div>"+"</div>");templates.olapSelector.levels=Mustache.compile("<div class='levelTitle'>Levels</div>"+"<div class='levels options'></div>");templates.olapSelector.level=Mustache.compile("<div class='target'>"+"  <span class='name' title='{{label}}'>{{label}}</span>"+"</div>");templates.olapSelector.crumbtrail=Mustache.compile("<span class='level'>{{level}}</span>"+"<span class='separator'>&nbsp;</span>"+"<span class='name'>{{name}}</span>")
if(typeof console==="undefined"){console={};console.log=function(){return;}}
wd=wd||{};wd.utils=wd.utils||{};wd.utils.OlapUtils=function(spec){var defaults={url:wd.helpers.olap.getServiceUrl(),extraParams:{}};var myself={};myself.options=$.extend({},defaults,spec);var isInitialized=false;var catalog=myself.options.catalog;var cube=myself.options.cube;var allSelectedObjects=[];var catalogs=[];var cubeStructureCache={};var olapOperations={GET_OLAP_CUBES:wd.helpers.olap.getCubesUrl(),GET_CUBE_STRUCTURE:wd.helpers.olap.getCubeStructureUrl(),GET_PAGINATED_LEVEL_MEMBERS:wd.helpers.olap.getPaginatedLevelMembersUrl(),GET_MEMBER_STRUCTURE:wd.helpers.olap.getLevelMembersStructureUrl()};myself.initialize=function(){if(!isInitialized){myself.initCatalogs();isInitialized=true;}}
myself.setOptions=function(_args){myself.options=$.extend(myself.options,_args);}
myself.setCatalog=function(catalog){myself.catalog=catalog;myself.options.catalog=catalog;}
myself.initCatalogs=function(){wd.debug("Getting info from cube");var res=myself.callOlapUtilsSync({operation:olapOperations.GET_OLAP_CUBES});catalogs=res.catalogs;wd.info("[OlapUtils] Successfully got catalog information");}
myself.resetCubeStructure=function(_args){var catalog=myself.getSelectedCatalogName(_args);var cube=myself.getSelectedCubeName(_args);var cacheKey=catalog+"::"+cube;if(cacheKey){delete cubeStructureCache[cacheKey];}
else{cubeStructureCache={};}
return true;}
myself.getCatalogs=function(){return catalogs;}
myself.getCubes=function(_args){var catalog=myself.getSelectedCatalogName(_args);var entry=_.find(catalogs,function(c){return c.schema.indexOf(catalog)>=0;});return entry?entry.cubes:null;}
myself.getCubeStructure=function(_args){var catalog=myself.getSelectedCatalogName(_args);var cube=myself.getSelectedCubeName(_args);var cacheKey=catalog+"::"+cube;if(!catalog||!cube){wd.error("Catalog or Cube not specified");return null;}
if(cubeStructureCache[cacheKey]){return cubeStructureCache[cacheKey];}
var params={operation:olapOperations.GET_CUBE_STRUCTURE,catalog:catalog,cube:cube};var result=myself.callOlapUtilsSync(params);cubeStructureCache[cacheKey]=result;return result;}
myself.getCube=function(_args){return myself.getCubeStructure(_args);}
myself.getDimensions=function(_args){var cubeStructure=myself.getCubeStructure(_args);return cubeStructure!=null?cubeStructure.dimensions:null;}
myself.getDimension=function(_args){var dimension=myself.getSelectedDimensionName(_args);var cubeStructure=myself.getCubeStructure(_args);var d=_.find(cubeStructure.dimensions,function(d){return d.name==dimension});return d;}
myself.getHierarchies=function(_args){var d=myself.getDimension(_args);return d!=null?d.hierarchies:null;}
myself.getHierarchy=function(_args){var hierarchyName=myself.getSelectedHierarchyName(_args);var h=_.find(myself.getHierarchies(_args),function(hier){return hier.name==hierarchyName});return h;}
myself.getLevels=function(_args){var h=myself.getHierarchy(_args);return h!=null?h.levels:null;}
myself.getLevel=function(_args){var levelName=myself.getSelectedLevelName(_args);var l=_.find(myself.getLevels(_args),function(level){return level.name==levelName});return l;}
myself.getPaginatedLevelMembers=function(_args,callback){var defaults={operation:olapOperations.GET_PAGINATED_LEVEL_MEMBERS,startMember:"",pageStart:0,pageSize:100,searchTerm:"",context:""}
var params=$.extend({},defaults,_args);params.catalog=myself.getSelectedCatalogName(_args);params.cube=myself.getSelectedCubeName(_args);var l=myself.getLevel(_args);params.level=l.qualifiedName;myself.callOlapUtils(params,function(json){var members=json.members;wd.debug("Got results for paginatedLevelMembers: "+_(members).pluck("name").join(", "));if(callback){callback(json);}});};myself.getOlapUtilsUrl=function(){return myself.options.url};myself.getSelectedCatalogName=function(_args){var catalog=$.extend({},myself.options,_args).catalog;return catalog;};myself.getSelectedCubeName=function(_args){return $.extend({},myself.options,_args).cube;};myself.getSelectedDimensionName=function(_args){return $.extend({},myself.options,_args).dimension;};myself.getSelectedHierarchyName=function(_args){var h=$.extend({},myself.options,_args).hierarchy;if(h==null){h=myself.getHierarchies(_args)[0].name;myself.options.hierarchy=h;wd.info("No hierarchy explicitly selected - setting the default one to '"+h+"'");}
return h;};myself.getSelectedLevelName=function(_args){return $.extend({},myself.options,_args).level;};myself.callOlapUtilsSync=function(params){return myself.callOlapUtils(params,undefined,undefined,true);}
myself.callOlapUtils=function(params,callback,errorCallback,sync){var myself=this;var ret;$.ajax({type:"GET",url:myself.getOlapUtilsUrl()+params.operation,data:$.extend({},myself.options.extraParams,params),dataType:"json",success:function(json){if(json&&json.status=="true"&&json.result){if(sync){ret=json.result}
else{callback(json.result);}}
else{if(typeof(errorCallback)!='function')errorCallback=alert;return errorCallback(json);}},async:!sync});return ret;};myself.initialize();wd.info("OlapUtils initialized!");return myself;}
if(!Array.prototype.map)
{Array.prototype.map=function(fun)
{var len=this.length;if(typeof fun!="function")
throw new TypeError();var res=new Array(len);var thisp=arguments[1];for(var i=0;i<len;i++)
{if(i in this)
res[i]=fun.call(thisp,this[i],i,this);}
return res;};}
if(!Array.prototype.indexOf){Array.prototype.indexOf=function(searchElement){"use strict";if(this==null){throw new TypeError();}
var t=Object(this);var len=t.length>>>0;if(len===0){return-1;}
var n=0;if(arguments.length>0){n=Number(arguments[1]);if(n!=n){n=0;}else if(n!=0&&n!=Infinity&&n!=-Infinity){n=(n>0||-1)*Math.floor(Math.abs(n));}}
if(n>=len){return-1;}
var k=n>=0?n:Math.max(len-Math.abs(n),0);for(;k<len;k++){if(k in t&&t[k]===searchElement){return k;}}
return-1;}}
Function.prototype.method=Function.prototype.method||function(name,func){this.prototype[name]=func;return this;};var wd=wd||{};wd.loglevels=['debug','info','warn','error','exception'];wd.loglevel='debug';wd.log=function(m,type){type=type||"info";if(wd.loglevels.indexOf(type)<wd.loglevels.indexOf(wd.loglevel)){return;}
if(typeof console!=="undefined"){if(type&&console[type]){console[type]("["+type+"] WD: "+m);}else if(type==='exception'&&!console.exception){console.error("["+type+"] WD: "+(m.stack||m));}
else{console.log("WD: "+m);}}}
wd.warn=function(m){return wd.log(m,"warn");}
wd.error=function(m){return wd.log(m,"error");}
wd.info=function(m){return wd.log(m,"info");}
wd.debug=function(m){return wd.log(m,"debug");}
var OlapSelectorComponent=BaseComponent.extend({init:function(){var olapUtilsInstance=new wd.utils.OlapUtils({url:Dashboards.getWebAppPath()+wd.helpers.olap.getServiceUrl(),catalog:this.catalog,cube:this.cube,dimension:this.dimensionName});var cToFind=this.catalog;var entry=_.find(olapUtilsInstance.getCatalogs(),function(c){return(c.schema.indexOf(cToFind)>=0);});if(entry!==false){olapUtilsInstance.setCatalog(entry.name);}
this.model=new OlapSelectorModel({olapUtils:olapUtilsInstance,title:this.title,multiselect:this.multiSelect,parameters:this.getParamValues(this.parameters),preselected:this.getPreSelValue(this.parameter)});this.view=new OlapSelectorView({model:this.model,el:$("#"+this.htmlObject).get(0)})},update:function(){if(!this.isInitialized){this.init();this.isInitialized=true;}
var myself=this;this.model.on("change:collapsed",function(m,v){if(v){Dashboards.processChange(myself.name);}})
this.view.render();myself.parameters=myself.getParamValues(myself.parameters);myself.model.set("parameters",myself.parameters);},getValue:function(){return _(this.model.get("values").where({selected:true})).map(function(m){return m.get("qualifiedName");});},getParamValues:function(overrides){params=(overrides instanceof Array)?Dashboards.propertiesArrayToObject(overrides):(overrides||{});paramValues={};_.each(params,function(value,name){value=Dashboards.getParameterValue(value);if(_.isObject(value)){value=JSON.stringify(value);}
if(typeof value=='function'){value=value();}
paramValues[name]=value;paramValues.length=overrides.length;});return paramValues;},getPreSelValue:function(param){var paramValue=Dashboards.getParameterValue(param),values=[];if(typeof paramValue!=='undefined'){values=JSON.parse(paramValue);if(!this.multiSelect){values=new Array(values[0]);}}
return values}});
var wd=wd||{}
wd.cdf=wd.cdf||{};wd.cdf.views=wd.cdf.views||{};var templates=templates||{};templates.dashboardViews=templates.dashboardViews||{};wd.cdf.views.getUrl=function(){return wd.helpers.views.getUrl(this.solution,this.path,this.file,this.name);};wd.cdf.views.DashboardView=Backbone.Model.extend({defaults:{"id":"","name":"","description":"","key":null,"params":{},"unbound":[],"user":"","solution":"","path":"","file":"","url":wd.cdf.views.getUrl,"timestamp":0},isSynced:function(){var modelParams=this.get("parameters"),dashboardParams=Dashboards.getViewParameters();if(Object.keys(modelParams).length!==Object.keys(dashboardParams).length){return false;}
for(p in modelParams)if(modelParams.hasOwnProperty(p)){if(!dashboardParams.hasOwnProperty(p)||dashboardParams[p]!==modelParams[p]){return false;}}
return true;},syncWithDashboard:function(){this.set("parameters",Dashboards.getViewParameters());}});wd.cdf.views.Report=Backbone.Model.extend({defaults:{"name":"","label":"","dashboardView":null,"params":{},"user":"","timestamp":0}});wd.cdf.views.newDashboardView=function(name,description){var m={id:name,name:name,description:description,params:Dashboards.getViewParameters(),unbound:Dashboards.getUnboundParameters(),user:Dashboards.context.user,solution:Dashboards.context.solution,path:Dashboards.context.path,file:Dashboards.context.file,timestamp:(new Date()).getTime()};return new wd.cdf.views.DashboardView(m);};wd.cdf.views.ViewManager=Backbone.Model.extend({defaults:{"currentView":"Unsaved View","views":null,"viewCount":0},initViews:function(views){if(Dashboards.view){this.set("currentView",Dashboards.view.name,{silent:true});}
var viewCollection=new Backbone.Collection();viewCollection.model=wd.cdf.views.DashboardView;viewCollection.reset(views);this.set("views",viewCollection,{silent:true});this.set("viewCount",viewCollection.size(),{silent:true});this.change();}});wd.cdf.views.ViewManagerView=Backbone.View.extend({events:{'click .tab':"clickTab",'click .manage-views, .save-panel .cancel':"toggleViewManager",'click .view-item .delete':"deleteView",'click .save-panel .save':"save"},tabs:[{label:"List",selector:".list-panel",template:"viewListPanel"},{label:"Save",selector:".save-panel",template:"viewSavePanel"}],initialize:function(){this.configureListeners();},clickTab:function(evt){var $tgt=$(evt.target),selector=$tgt.data('target');this.$(".tab").removeClass("selected");$tgt.addClass("selected");this.$('.panel').hide();this.$(selector).show();},configureListeners:function(){this.model.on("change",this.render,this);},renderTabs:function(){var tabs=this.$(".tabs").empty(),tabContents=this.$(".tab-contents").empty();_(this.tabs).each(function(t){tabs.append(templates.viewManagerTab(t));tabContents.append(templates[t.template](this.model.toJSON()));},this);tabs.children().slice(0,1).addClass('selected');tabContents.children().slice(1).hide();},renderViewList:function(){var $views=this.$(".list-panel .views").empty();this.model.get("views").each(function(e){var $view=$(templates.viewListItem(e.toJSON()));$view.data("model",e);$views.append($view);});},toggleViewManager:function(){this.$('.manage-views').toggleClass("active");this.$('.view-manager').toggle();},render:function(){this.$el.html(templates.viewManager(this.model.toJSON()));this.renderTabs();this.renderViewList();this.$(".view-manager").hide();},save:function(){var name=this.$(".save-properties .name").val(),desc=this.$(".save-properties .description").val(),view=wd.cdf.views.newDashboardView(name,desc).toJSON(),args;view.params=Base64.encode(JSON.stringify(view.params)),old=this.model.get("views").filter(function(m){return m.get("name")==name})[0];if(old){view.key=old.get("key");}
args={view:JSON.stringify(view)};var myself=this;$.post(webAppPath+wd.helpers.views.getSaveViewsEndpoint(),$.param(args),function(){Dashboards.view=view;myself.model.set("currentView",name);myself.model.trigger("update");});},deleteView:function(evt){var view=$(evt.target).parent().data("model"),args={name:view.get("name")};var myself=this;$.post(webAppPath+wd.helpers.views.getDeleteViewsEndpoint(),$.param(args),function(){myself.model.get("views").remove(view);myself.model.trigger("update");});}});templates.viewManager=Mustache.compile("<div class='view-manager-component'>"+" <div class='current-view'>"+"   <span class='label'>Current View: </span>"+"   <span class='value'>{{currentView}}</span>"+" </div>"+" <div class='big-button manage-views'>Manage Views</div>"+" <div class='view-manager'>"+"   <div class='tabs'></div>"+"   <div class='tab-contents'></div>"+" </div>"+"</div>");templates.viewManagerTab=Mustache.compile("<div class='tab' data-target='{{selector}}'>"+"{{label}}"+"</div>");templates.viewListPanel=Mustache.compile("<div class='list-panel panel'>"+" <div class='total-views'>"+"   <span class='label'>Total Views: </span>"+"   <span class='value'>{{viewCount}}</span>"+" </div>"+" <div class='views'></div>"+" <div class='view-all'>"+"   <span class='label'>View All</span>"+"   <span class='description'>(go to View Manager)</span>"+" </div>"+"</div>");templates.viewListItem=Mustache.compile("<div class='view-item'>"+" <a class='name' href='{{url}}'>{{name}}</a>"+" <span class='delete'></span>"+"</div>");templates.viewSubscriptionPanel=Mustache.compile("<div class='subscrition-panel panel'>"+" <div class='current-view'>"+"   <span class='label'>Current View:</span>"+"   <span class='value'></span>"+" </div>"+" <div class='unsaved'>"+"   <div>Your current view is not saved. To subscribe,"+"     you must first save it. Do you wish to proceed?"+"   </div>"+"   <div class='button save'>Save</div>"+"   <div class='button cancel'>Cancel</div>"+" </div>"+" <div class='subscription-properties'>"+"   <span class='label'></span>"+"   <input type='radio'>"+" </div>"+"</div>");templates.viewSavePanel=Mustache.compile("<div class='save-panel panel'>"+" <div class='current-view'>"+"   <span class='label'>Current View:</span>"+"   <span class='value'>{{currentView}}</span>"+" </div>"+" <div class='save-properties'>"+"   <div><span class='label'>Title</span><input type='text' class='name' value='{{currentView}}'></div>"+"   <div><span class='label'>Description</span><textarea class='description' placeholder='Enter a description'>{{description}}</textarea></div>"+" </div>"+" <div class='save-actions'>"+"   <div class='big-button active save'>Save</div>"+"   <div class='big-button cancel'>Cancel</div>"+" </div>"+"</div>");
var viewManagerComponent=BaseComponent.extend({update:function(){function fetchData(){$.ajax({url:webAppPath+wd.helpers.views.getListViewsEndpoint(),dataType:'json',success:function(response){myself.model.initViews(response.views);myself.view.render();},cache:false});};this.ph=$("#"+this.htmlObject);this.model=new wd.cdf.views.ViewManager();this.view=new wd.cdf.views.ViewManagerView({el:this.ph.get(0),model:this.model});var myself=this;fetchData();this.model.on("update",fetchData,this);}});
var loadGoogleMapsOverlay=(function($){var now=$.now(),promise;return function(){if(promise){return promise;}
var deferred=$.Deferred(),resolve=function(){deferred.resolve(window.google&&google.maps?google.maps:false);},callbackName="loadGoogleMapsOverlay_"+(now++),params;if(window.google&&google.maps){resolve();}else if(window.google&&google.load){google.load("maps","3.exp",{"other_params":"sensor=false&libraries=places","callback":resolve});}else{params={'v':'3.exp','sensor':false,'libraries':'places','callback':callbackName};window[callbackName]=function(){resolve();setTimeout(function(){try{delete window[callbackName];}catch(e){}},20);};$.ajax({dataType:'script',data:params,url:'http://maps.googleapis.com/maps/api/js'});}
promise=deferred.promise();return promise;};}(jQuery));
function submitGeocode(input){return function(e){var keyCode;if(window.event){keyCode=window.event.keyCode;}
if(keyCode==13){geocoder.geocode({address:input.value},function(results,status){if(status==google.maps.GeocoderStatus.OK){map.fitBounds(results[0].geometry.viewport);}else{alert("The location entered could not be found");}});}}}
var gMapsOverlayComponent=UnmanagedComponent.extend({mapEngineOpts:undefined,colormap:[[0,102,0,255],[255,255,0,255],[255,0,0,255]],getColorLegend:function(value,legendRanges){var qtd=Object.keys(legendRanges.ranges).length;for(var j=0;j<qtd;j++){if((isNaN(legendRanges.ranges[j].min)&&value<=legendRanges.ranges[j].max)||(isNaN(legendRanges.ranges[j].max)&&value>=legendRanges.ranges[j].min)||(value>=legendRanges.ranges[j].min&&value<=legendRanges.ranges[j].max)){return legendRanges.ranges[j].color;}}},getColorMap:function(){var interpolate=function(a,b,n){var c=[],d=[];var k,kk,step;for(k=0;k<a.length;k++){c[k]=[];for(kk=0,step=(b[k]-a[k])/n;kk<n;kk++){c[k][kk]=a[k]+kk*step;}}
for(k=0;k<c[0].length;k++){d[k]=[];for(kk=0;kk<c.length;kk++){d[k][kk]=Math.round(c[kk][k]);}}
return d;};var cmap=[];for(k=1;k<this.colormap.length;k++)
{cmap=cmap.concat(interpolate(this.colormap[k-1],this.colormap[k],512));}
return _.map(cmap,function(v){return'rgba('+v.join(',')+')';});},_getMapDefinition:function(myself,callback){if(!!myself.mapName&!myself.mapDefinition){$.getJSON(wd.helpers.repository.getRsourceUrl()+wd.helpers.repository.getBaseSolutionPluginRoot()+"cde/components/gmapsoverlay/map-def/"+myself.mapName+".js",function(json,callback){if(json){myself.mapDefinition=json;}});}
callback(myself);},postProcessData:function(values,myself){var defaultFillOpacity=0.6;var defaultStrokeWeight=0.5;myself.queryResult={};myself.isContinuousMapColor=$.isEmptyObject(myself.legend);var nrCols=values.metadata.length;for(i in values.resultset){var item=values.resultset[i];var value;if(nrCols<3)
{value=parseFloat(item[1]);color="";myself.isColorDefinedInDS=false;}
else
{value=item[1];color=item[2];myself.isColorDefinedInDS=true;}
myself.queryResult[item[0]]={'value':value,'color':color};if(item.length>2){myself.queryResult[item[0]].payload=item.slice(2);}}
myself._parseLegend(myself.isContinuousMapColor);if(myself.isContinuousMapColor)
{var colormap=myself.getColorMap();var qvalues=_.map(myself.queryResult,function(q){return q.value;});var minValue=_.min(qvalues),maxValue=_.max(qvalues);var n=colormap.length;_.each(myself.queryResult,function(v,key){var level=(v.value-minValue)/(maxValue-minValue);myself.queryResult[key]=_.extend({level:level,fillColor:colormap[Math.floor(level*(n-1))],fillOpacity:defaultFillOpacity,strokeWeight:defaultStrokeWeight},myself.queryResult[key]);});}
else
{_.each(myself.queryResult,function(v,key){var color;if(myself.isColorDefinedInDS){color=v.color;}
else
{color=myself.getColorLegend(v.value,myself.legendRanges);}
myself.queryResult[key]=_.extend({fillColor:color,fillOpacity:defaultFillOpacity,strokeWeight:defaultStrokeWeight},myself.queryResult[key]);});}},_parseLegend:function(isContinuousMapColor){this.legendRanges=new Object;this.legendRanges.ranges=new Object;this.legendRanges.text=((!this.legendText)?"":this.legendText);this.legendRanges.source=((!this.sourceText)?" ":this.sourceText);if(!isContinuousMapColor){for(var i=0;i<this.legend.length;i++){var opts=this.legend[i][1].split(";");this.legendRanges.ranges[i]=new Object;this.legendRanges.ranges[i].min=parseFloat(opts[0]);this.legendRanges.ranges[i].max=parseFloat(opts[1]);this.legendRanges.ranges[i].color=opts[2];this.legendRanges.ranges[i].desc=this.legend[i][0];}}},update:function(){myself=this;if($.isEmptyObject(myself.queryDefinition)){Dashboards.error("GMaps - Datasource not defined.");return}
if(!myself.mapName){Dashboards.error("GMaps - Map Name not defined.");return}
if(!myself.mapHeight||!myself.mapWidth){Dashboards.error("GMaps - Map Height and/or Width not defined.");return}
myself._getMapDefinition(myself,function(myself){myself.triggerQuery(myself.queryDefinition,function(values){myself.postProcessData(values,myself);myself._initialize();});});},_initialize:function(){this.mapEngine=new GMapEngine();this.mapEngine.opts=$.extend(true,this.mapEngine.opts,this.mapEngineOpts);if(this.clickCallback){this.mapEngine.clickCallback=this.clickCallback;}
this.mapEngine.init(this);},draw:function(){var myself=this;this.ph=$("#"+this.htmlObject);this.ph.empty();this.mapEngine.createMap(this.ph[0],this.centerLongitude,this.centerLatitude,this.defaultZoomLevel,this.mapHeight,this.mapWidth);this.mapEngine.renderMap(this.mapDefinition,this.queryResult,((!this.defaultColor)?"#EAEAEA":this.defaultColor),myself.legendRanges);this.mapEngine.resetButton(this.ph[0].id,this.defaultZoomLevel,this.centerLongitude,this.centerLatitude);if(this.search==true){this.mapEngine.searchBox(this.ph[0].id);}
this.mapEngine.renderLegend(this.ph[0].id,this.mapDefinition,this.queryResult,this.getColorMap(),[0,0.5,1],myself.legendRanges,myself.isContinuousMapColor,myself.isColorDefinedInDS);}});var GMapEngine=Base.extend({map:undefined,opts:{mapOptions:{styles:[{featureType:"administrative",stylers:[{"visibility":"off"}]}],disableDefaultUI:false,mapTypeControl:false,streetViewControl:false}},opened_info:undefined,centered:false,overlays:[],init:function(mapComponent){$.when(loadGoogleMapsOverlay()).then(function(status){mapComponent.draw();});},createMap:function(target,centerLongitude,centerLatitude,defaultZoomLevel,mapHeight,mapWidth){var mapOptions=$.extend(true,{zoom:parseInt(defaultZoomLevel),center:new google.maps.LatLng(centerLatitude,centerLongitude),mapTypeId:google.maps.MapTypeId.TERRAIN},this.opts.mapOptions);this.map=new google.maps.Map(target,mapOptions);this.opened_info=new google.maps.InfoWindow();$(target).css("height",mapHeight+"px");$(target).css("width",mapWidth+"px");},renderMap:function(mapDefinition,queryResult,defaultColor,legend){if(!mapDefinition){return;}
var myself=this;for(var c in mapDefinition){var coods=mapDefinition[c],polyPath=[];for(var k=0;k<coods.length;k++){polyPath.push(new google.maps.LatLng(coods[k][0],coods[k][1]));}
var shapeinfo={fillColor:!!queryResult[c]?queryResult[c].fillColor:defaultColor,fillOpacity:!!queryResult[c]?queryResult[c].fillOpacity:0,strokeWeight:!!queryResult[c]?queryResult[c].strokeWeight:0,strokeColor:'#8c8c8c'};var shape=new google.maps.Polygon(_.extend({paths:polyPath},shapeinfo));var shapeValue=queryResult[c]?queryResult[c].value:null;shape.infowindow=new google.maps.InfoWindow({content:myself.tooltipMessage(c,shapeValue),pixelOffset:{width:0,height:-3}});shape.infowindow.dataPayload=_.extend({name:c,value:shapeValue,level:queryResult[c]?queryResult[c].level:0},shapeinfo);if(!!queryResult[c]){queryResult[c].shape=shape;}
shape.setMap(myself.map);google.maps.event.addListener(shape,'click',function(event){myself.clickCallback(this.infowindow,event);myself.displayCoordinates(event.latLng);});google.maps.event.addListener(shape,'click',function(event){this.fillOpacity=1;this.strokeColor="#000000";this.setVisible(false);this.setVisible(true);this.infowindow.setOptions({maxWidth:500});this.infowindow.setPosition(event.latLng);if(!this.infowindow.getMap())
this.infowindow.open(myself.map);myself.opened_info=this.infowindow;});google.maps.event.addListener(shape,'mouseout',function(event){myself.opened_info.close();this.fillOpacity=0.6;this.strokeColor="#8c8c8c";this.setVisible(false);this.setVisible(true);});}},tooltipMessage:function(shapeName,shapeValue){var message=shapeName+"</br>"+(shapeValue?shapeValue:'-');return'<div class="gmapsoverlay-tooltip">'+message+'</div>';},clickCallback:function(shape,event){Dashboards.log(shape.dataPayload.name+':'+shape.dataPayload.value+':'+shape.dataPayload.level*100+'%');},displayCoordinates:function(pnt){var lat=pnt.lat();lat=lat.toFixed(4);var lng=pnt.lng();lng=lng.toFixed(4);Dashboards.log("Lat: "+lat+"  Lng: "+lng);},showInfo:function(event,mapEngine,infowindow){mapEngine.opened_info.close();infowindow.setPosition(event.latLng);infowindow.open(mapEngine.map);mapEngine.opened_info=infowindow;},resetButton:function(id,zoom,centerLongitude,centerLatitude){var myself=this;var controlReset=document.createElement('div');var linkReset=document.createElement('a');controlReset.appendChild(linkReset);controlReset.setAttribute('id','controlReset_'+id);linkReset.setAttribute('id','linkReset_'+id);linkReset.href="javascript:void(0)";linkReset.className='gmapsoverlay-button';linkReset.onclick=(function(){myself.map.setZoom(zoom);myself.map.setCenter(new google.maps.LatLng(centerLatitude,centerLongitude));});linkReset.innerHTML='Reset';myself.map.controls[google.maps.ControlPosition.TOP_LEFT].push(controlReset);},searchBox:function(id){var myself=this;var control=document.createElement('div');var input=document.createElement('input');control.appendChild(input);control.setAttribute('id','locationField_'+id);input.style.width='250px';input.style.height='100%';input.style.margin='0px';input.style.border='1px solid #A9BBDF';input.style.borderRadius='2px';input.setAttribute('id','locationInput_'+id);myself.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(control);var ac=new google.maps.places.Autocomplete(input,{types:['geocode']});google.maps.event.addListener(ac,'place_changed',function(){var place=ac.getPlace();if(place.geometry.viewport){myself.map.fitBounds(place.geometry.viewport);}else{myself.map.setCenter(place.geometry.location);myself.map.setZoom(17);}});google.maps.event.addListener(myself.map,'bounds_changed',function(){input.blur();input.value='';});input.onkeyup=submitGeocode(input);},renderLegend:function(id,mapDefinition,queryResult,colormap,ticks,legendRanges,isContinuousMapColor,isColorDefinedInDS){if(isContinuousMapColor)
{var sigFigs=function(num,sig){if(num==0)
return 0;if(Math.round(num)==num)
return num;var digits=Math.round((-Math.log(Math.abs(num))/Math.LN10)+(sig||2));if(digits<0)
digits=0;return num.toFixed(digits);};if(queryResult&&mapDefinition){var values=_.map(queryResult,function(q){return q.value;});var minValue=_.min(values),maxValue=_.max(values);var n=colormap.length;var rounding=1;if(maxValue<-5){rounding=((maxValue-minValue)/5).toString().split('.');rounding=rounding.length>1?Math.pow(10,Math.max(rounding[1].length,3)):1;}
var legend=_.map(ticks,function(level){var value=(minValue+level*(maxValue-minValue)*rounding)/rounding;return{value:sigFigs(value,1),level:level,fillColor:colormap[Math.floor(level*n-1)]};});}
this.legend=legend;}
var controlDiv=document.createElement('DIV');controlDiv.style.padding='5px';controlDiv.setAttribute('id','legendDiv_'+id);var controlUI=document.createElement('DIV');controlUI.setAttribute('id','legendUI_'+id);controlUI.title='Legend';controlDiv.appendChild(controlUI);var controlText=document.createElement('DIV');controlText.setAttribute('id','legendText_'+id);controlText.style.fontFamily='Arial,sans-serif';controlText.style.fontSize='12px';controlText.style.paddingLeft='4px';controlText.style.paddingRight='4px';if(isContinuousMapColor)
{var legendTable='';_.each(legend,function(el){var left=(el.level!=0)?el.level*100+'%':'-1px';legendTable+="<div class='gmapsoverlay-legend-label' style='left:"+left+";position:absolute;'><div>"+el.value+"</div></div>";});controlText.innerHTML=""+"<div class='gmapsoverlay-legend'>"+"  <div class='gmapsoverlay-legend-title'>"+legendRanges.text+"</div>"+"  <div class='gmapsoverlay-legend-scale'>"+"    <div class='gmapsoverlay-legend-labels'>"+
legendTable+"    </div>"+"  </div>"+"<div class='gmapsoverlay-legend-source'>"+legendRanges.source+"</div>"+"</div>";}
else
{var legendTable="";var qtd=Object.keys(legendRanges.ranges).length;for(var j=0;j<qtd;j++){if(isColorDefinedInDS)
{legendTable+="<li><span style='background:"+legendRanges.ranges[j].color+";'></span>"+legendRanges.ranges[j].desc+"</li>";}
else if(isNaN(legendRanges.ranges[j].min))
{legendTable+="<li><span style='background:"+legendRanges.ranges[j].color+";'><= "+legendRanges.ranges[j].max+"</span>"+legendRanges.ranges[j].desc+"</li>";}
else if(isNaN(legendRanges.ranges[j].max))
{legendTable+="<li><span style='background:"+legendRanges.ranges[j].color+";'>>= "+legendRanges.ranges[j].min+"</span>"+legendRanges.ranges[j].desc+"</li>";}
else
{legendTable+="<li><span style='background:"+legendRanges.ranges[j].color+";'>"+legendRanges.ranges[j].max+"</span>"+legendRanges.ranges[j].desc+"</li>";}}
controlText.innerHTML=""+"<div class='gmapsoverlay-legend' style='width: auto'>"+"<div class='gmapsoverlay-legend-title'>"+legendRanges.text+"</div>"+"<div class='gmapsoverlay-legend-scale-range'>"+"  <ul class='gmapsoverlay-legend-labels-range'>"+
legendTable+"  </ul>"+"</div>"+"<div class='gmapsoverlay-legend-source'>"+legendRanges.source+"</div>"+"</div>";}
controlUI.appendChild(controlText);this.map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(controlDiv);},showPopup:function(data,mapElement,popupHeight,popupWidth,contents,popupContentDiv,borderColor){var overlay=new OurMapOverlay(mapElement.getPosition(),popupWidth,popupHeight,contents,popupContentDiv,this.map,borderColor);$(this.overlays).each(function(i,elt){elt.setMap(null);});this.overlays.push(overlay);}});
var RelatedContentComponent=BaseComponent.extend({update:function(){if(typeof(this.relatedContent)!="undefined"){var placeHolder=$("#"+this.htmlObject);placeHolder.empty();var contentString='<div id="relatedContentMainDiv"><p>Related content</p><ul>';for(key in this.relatedContent){if(this.relatedContent.hasOwnProperty(key)&&key!=null&&key!=undefined){contentString=contentString+'<li><a href=\''+this.relatedContent[key][1]+'\'">'+this.relatedContent[key][0]+'</a></li>';}}
contentString=contentString+'</ul></div>';placeHolder.append(contentString);}}});
var MobileNavComponent=BaseComponent.extend({update:function(){}});
var views=views||{};views.pagingSelector={};var models=models||{};models.pagingSelector={};models.pagingSelector.SelectorModel=Backbone.Model.extend({defaults:{"title":"","search":true,"advancedSearch":false,"multiselect":true,"searchterm":"","collapsed":true,"values":null,"pageStart":0,"pageSize":Infinity,"totalRecords":0},initialize:function(values){this.set("values",new Backbone.Collection());var values=this.get("values");values.comparator=function(val){return val.get("idx");};values.model=models.pagingSelector.OptionModel;values.on("change:selected",this.updateSelection,this);this.on("change:searchterm",this.updateSearch,this);this.updateValues(values);},addPage:function(newValues){var v,newValue,values=this.get("values");for(v=0;v<newValues.length;v++){var newValue=newValues[v],found=values.detect(function(model){return model.get("idx")==newValue.idx;});if(!found){values.add(newValues[v],{silent:true});}}
values.trigger("add");},nextPage:function(){var start=this.get("pageStart"),size=this.get("pageSize"),total=this.get("totalRecords"),requestedPage=start+size,lastPage=total-total%size;this.set("pageStart",Math.min(requestedPage,lastPage));},prevPage:function(){var start=this.get("pageStart"),size=this.get("pageSize");this.set("pageStart",Math.max(0,start-size));},firstPage:function(){this.set("pageStart",0);},lastPage:function(){var total=this.get("totalRecords"),size=this.get("pageSize");this.set("pageStart",total-total%size);},goToPage:function(page){var total=this.get("totalRecords"),size=this.get("pageSize"),requestedPage=page*size,lastPage=total-total%size;this.set("pageStart",Math.min(requestedPage,lastPage));},updateValues:function(values){this.get("values").reset(values);},updateSelection:function(m,selected){if(selected&&!this.get("multiselect")){_(this.get("values").without(m)).each(function(other){other.set("selected",false);});}},clearSelection:function(){this.get("values").each(function(m){m.set("selected",false);})},toggleCollapsed:function(){this.set("collapsed",!this.get("collapsed"));},selectedValues:function(){return _(this.get("values").where({selected:true})).map(function(m){return m.get("value")});},updateSearch:function(){var term=this.get("searchterm");var pattern=new RegExp(term);this.get("values").each(function(m){var match=pattern.test(m.get('label'))||(this.get("advancedSearch")&&pattern.test(m.get("value")));m.set("visible",match);},this);}});models.pagingSelector.OptionModel=Backbone.Model.extend({defaults:{"idx":0,"label":"","value":null,"visible":true,"selected":false,"new":false},toggleSelected:function(){this.set("selected",!this.get("selected"));}});views.pagingSelector.SelectorView=Backbone.View.extend({events:{"click .title":"toggleCollapsed","click .first":"firstPage","click .prev":"prevPage","click .next":"nextPage","click .last":"lastPage","click .pages span":"goToPage","change .search input":"updateSearch","keydown .search input":"testChange","click .validate":"toggleCollapsed"},initialize:function(){this.initializeOptions();this.configureListeners();},configureListeners:function(){this.model.on("change",this.render,this);this.model.on("change:collapsed",this.updateCollapsed,this);this.model.on("change:pageStart",this.renderPages,this);var values=this.model.get("values");values.on("change:selected",this.toggleSelected,this);values.on("add remove reset",this.updateOptions,this)},initializeOptions:function(){this._selectedViews=[];this._optionViews=[];this.model.get("values").each(function(m){this._optionViews.push(new views.pagingSelector.OptionView({model:m}));if(m.get("selected")){this._selectedViews.push(new views.pagingSelector.SelectionView({model:m}));}},this);},updateSearch:function(evt){this.model.set("searchterm",evt.target.value);evt.stopPropagation();},testChange:function(evt){if(evt.which==13){this.updateSearch(evt);}},render:function(){this.$el.html(templates.pagingSelector.main(this.model.toJSON()));this.updateCollapsed();this.renderOptions();this.renderPages();},renderPages:function(){var m=this.model,currPage=Math.ceil(m.get("pageStart")/m.get("pageSize")),maxPages=Math.ceil(m.get("totalRecords")/m.get("pageSize")),$pages=this.$el.find(".pages"),i,preSkip=false,postSkip=false;$pages.empty();for(i=0;i<maxPages;i++){if(i<5||maxPages-i<5||Math.abs(currPage-i)<2){$pages.append($("<span class='page'>"+(i+1)+"</span>").attr("data-page",i).addClass(i==currPage?"current":""));}else{if(!preSkip&&i<currPage){$pages.append("&hellip;");preSkip=true;}else if(!postSkip&&i>currPage){$pages.append("&hellip;");postSkip=true;}}}},renderOptions:function(){var optionContainer=this.$el.find(".options").empty(),selectionContainer=this.$el.find(".selection").empty(),minIdx=this.model.get('pageStart'),maxIdx=this.model.get('pageStart')+this.model.get('pageSize');_(this._optionViews).each(function(v){var idx=v.model.get("idx");if(idx<maxIdx&&idx>=minIdx){optionContainer.append(v.render().el);}});_(this._selectedViews).each(function(v){selectionContainer.append(v.render().el);});},updateOptions:function(){this.initializeOptions();this.renderOptions();},toggleSelected:function(m,selected){var v;if(selected){v=new views.pagingSelector.SelectionView({model:m});this.$el.find(".selection").append(v.render().el);this._selectedViews.push(v);}else{v=_(this._selectedViews).find(function(v){return v.model===m});v.remove();this._selectedViews=_(this._selectedViews).without(v);}},toggleCollapsed:function(){this.model.toggleCollapsed();},updateCollapsed:function(){$('.selectorComponent').addClass('collapsed').removeClass('expanded');if(this.model.get("collapsed")){this.$el.find('.selectorComponent').addClass('collapsed').removeClass('expanded');}else{$(".datepicker-title").removeClass("datepicker-title-visible");$(".datepicker-outerbox").hide();$(".manage-views.active").click();this.$el.find('.selectorComponent').removeClass('collapsed').addClass('expanded');var optionList=this.$el.find(".optionList"),minimumMargin=10,topEdge=optionList.offset().top,bottomEdge=topEdge+optionList.outerHeight(),topLimit=$(window).scrollTop(),bottomLimit=topLimit+$(window).height(),offset=bottomEdge<=bottomLimit?0:bottomLimit-bottomEdge-minimumMargin;offset=topEdge-offset>=topLimit?offset:topLimit-topEdge+minimumMargin;optionList.css("top",(optionList.position().top+offset)+"px");}},nextPage:function(){this.model.nextPage();},prevPage:function(){this.model.prevPage();},firstPage:function(){this.model.firstPage();},lastPage:function(){this.model.lastPage();},goToPage:function(evt){var page=$(evt.target).attr("data-page");this.model.goToPage(page);}});views.pagingSelector.OptionView=Backbone.View.extend({tagName:"span",events:{"click .target":"toggleSelection"},initialize:function(){this.model.on("change:selected",this.updateSelectionDisplay,this);this.model.on("change:visible",this.updateVisibility,this);},render:function(){this.$el.html(templates.pagingSelector.option(this.model.toJSON()));this.$el.addClass('item');this.updateSelectionDisplay();this.updateVisibility();this.delegateEvents();return this;},toggleSelection:function(){this.model.toggleSelected();},updateVisibility:function(){if(this.model.get('visible')){this.$el.show();}else{this.$el.hide();}},updateSelectionDisplay:function(){if(this.model.get('selected')){this.$el.addClass('selected');}else{this.$el.removeClass('selected');}}});views.pagingSelector.SelectionView=Backbone.View.extend({tagName:"li",events:{"click .remove":"unselect"},render:function(){this.$el.html(templates.pagingSelector.picked(this.model.toJSON()));this.$el.addClass('item');this.delegateEvents();return this;},unselect:function(){this.model.set("selected",false);}});var templates=templates||{};templates.pagingSelector={};templates.pagingSelector.main=Mustache.compile("<div class='selectorComponent'>"+"  <div class='pulldown'>"+"    <div class='title'>{{title}}</div>"+"      <div class='optionList'>"+"        <div class='search'>"+"          <input type='text' placeholder='Search...' value='{{searchterm}}'/>"+"          <div class='cancel'>&nbsp;</div>"+"        </div>"+"        <div class='options'></div>"+"        <div class='paginationContainer'>"+"          <div class='pagination'>"+"            <div class='first paginateButton'><div class='arrow'>&nbsp;</div></div>"+"            <div class='prev paginateButton'><div class='arrow'>&nbsp;</div></div>"+"            <div class='pages'></div>"+"            <div class='next paginateButton'><div class='arrow'>&nbsp;</div></div>"+"            <div class='last paginateButton'><div class='arrow'>&nbsp;</div></div>"+"          </div>"+"          <div class='validate'><div class='image'>&nbsp;</div></div>"+"        </div>"+"      </div>"+"  </div>"+"  <div class='selection'></div>"+"</div>");templates.pagingSelector.option=Mustache.compile("<div class='target'>"+"  <span class='name' title='{{label}}'>{{label}}</span>"+"  <span class='check'>&nbsp;</span>"+"  {{#new}}<span class='new'>&nbsp;</span>{{/new}}"+"</div>");templates.pagingSelector.picked=Mustache.compile("<div class='target'>"+"  <span class='name' title='{{label}}'>{{label}}</span>"+"  <div class='remove'>&nbsp;</div>"+"</div>");
var NewSelectorComponent=UnmanagedComponent.extend({pageStart:0,pageSize:54,update:function(){$.extend(this.options,this);this.ph=$("#"+this.htmlObject).empty();var redraw=_.bind(this.redraw,this);if(typeof this.valuesArray!="undefined"&&this.valuesArray.length>0){this.synchronous(redraw,this.valuesArray);}else{var params=Dashboards.propertiesArrayToObject(this.parameters);var pattern=(this.selectorModel)?this.selectorModel.get("searchterm"):"";params[this.searchParam]="'"+pattern+"'";this.parameters=Dashboards.objectToPropertiesArray(params);this.triggerQuery(this.chartDefinition,redraw,{pageSize:this.pageSize});}},values:function(results){var data=results.resultset,idx=(results.queryInfo)?results.queryInfo.pageStart:0,currentValues=Dashboards.getParameterValue(this.parameter),vid=this.chartDefinition.valueAsId,values=[];if(!_.isArray(currentValues))currentValues=[currentValues];_.each(data,function(row){var value=row[vid?1:0],v={idx:idx++,value:value,label:row[1],selected:!!(1+currentValues.indexOf(value)),"new":!!row[2]};values.push(v);},this);return values;},redraw:function(data){var values=this.values(data),modelOptions={title:this.title,pageSize:this.pageSize,pageStart:this.pageStart,totalRecords:(data.queryInfo)?data.queryInfo.totalRows:0,multiselect:this.multiselect},v,p;v=_.pluck(values,"value"),p=Dashboards.getParameterValue(this.parameter);p=_.filter(p,function(val){return _.include(v,val);});Dashboards.setParameter(this.parameter,p);if(!this.selectorModel){this.selectorModel=new models.pagingSelector.SelectorModel(modelOptions);}else{this.selectorModel.set(modelOptions);}
this.selectorModel.updateValues(values);if(!this.selectorView){this.selectorView=new views.pagingSelector.SelectorView({model:this.selectorModel,el:this.ph.get(0)});}
this.selectorView.render();this.selectorModel.off('change:searchterm',this.update);this.selectorModel.on('change:searchterm',this.update,this);this.selectorModel.off('change:pageSize',this.pagingHandler);this.selectorModel.on('change:pageSize',this.pagingHandler,this);this.selectorModel.off('change:pageStart',this.pagingHandler);this.selectorModel.on('change:pageStart',this.pagingHandler,this);this.selectorModel.off("change:collapsed",this.handleCollapse);this.selectorModel.on("change:collapsed",this.handleCollapse,this);this.timeout=0;var values=this.selectorModel.get("values");values.off("change:selected",this.handleSelectionChange);values.on("change:selected",this.handleSelectionChange,this);},handleCollapse:function(evt){if(evt.changed.collapsed)Dashboards.processChange(this.name);},handleSelectionChange:function(evt){if(!evt.changed.selected&&this.selectorModel.get("collapsed")){if(this.timeout!==0){clearTimeout(this.timetimeout);};var myself=this;this.timeout=setTimeout(function(){Dashboards.processChange(myself.name);timeout=0;},1500);}},pagingHandler:function(){var redraw=this.getSuccessHandler(_.bind(function(data){var values=this.values(data);this.selectorModel.addPage(values);},this));this.queryState.pageStartingAt(this.selectorModel.get("pageStart"),redraw);},getValue:function(){return this.selectorModel.selectedValues();}});
var ExportButtonComponent=BaseComponent.extend({ph:undefined,tc:undefined,queryObjectNames:{queryState:null,query:null},update:function(){var myself=this;$.extend(this.options,this);myself.ph=$("#"+myself.htmlObject);myself.ph.empty();var bar=$('<span class="exportButton"></span>').appendTo(myself.ph);var componentName=(myself.componentName.indexOf("render_")==0?"":"render_")+myself.componentName;var comp=Dashboards.getComponentByName(componentName);var overrideParameters=Dashboards.propertiesArrayToObject(myself.parameters);bar.text(myself.label).click(function(){var foundQuery=false;for(n in myself.queryObjectNames){if(comp[n]){comp[n].exportData(myself.outputType,overrideParameters,myself.getFilterSettings(comp));foundQuery=true;break;}}
if(!foundQuery){Dashboards.log(myself.name+": could not find a query object on "+myself.compName);}});},getFilterSettings:function(component){var extraSettings={};if(component.type=="Table"){var dtOptions=component.ph.dataTableSettings[0];if(dtOptions.oFeatures.bFilter){var searchInput=component.ph.find('input');if(searchInput){extraSettings.dtFilter=searchInput.val();if(dtOptions.aoColumns){var idxs=[];for(var i=0;i<dtOptions.aoColumns.length;i++){if(dtOptions.aoColumns[i].bSearchable){idxs.push(i);}}
extraSettings.dtSearchableColumns=idxs.join(',');}}}}
return extraSettings;}});
(function(glob){var version="0.2.4",has="hasOwnProperty",separator=/[\.\/]/,wildcard="*",fun=function(){},numsort=function(a,b){return a-b;},current_event,events={n:{}},eve=function(name,scope){var e=events,args=Array.prototype.slice.call(arguments,2),listeners=eve.listeners(name),z=0,f=false,l,indexed=[],queue={},errors=[];current_event=name;for(var i=0,ii=listeners.length;i<ii;i++)if("zIndex"in listeners[i]){indexed.push(listeners[i].zIndex);if(listeners[i].zIndex<0){queue[listeners[i].zIndex]=listeners[i];}}
indexed.sort(numsort);while(indexed[z]<0){l=queue[indexed[z++]];if(l.apply(scope,args)===f){return f;}}
for(i=0;i<ii;i++){l=listeners[i];if("zIndex"in l){if(l.zIndex==indexed[z]){if(l.apply(scope,args)===f){return f;}
do{z++;l=queue[indexed[z]];if(l&&l.apply(scope,args)===f){return f;}}while(l)}else{queue[l.zIndex]=l;}}else{if(l.apply(scope,args)===f){return f;}}}};eve.listeners=function(name){var names=name.split(separator),e=events,item,items,k,i,ii,j,jj,nes,es=[e],out=[];for(i=0,ii=names.length;i<ii;i++){nes=[];for(j=0,jj=es.length;j<jj;j++){e=es[j].n;items=[e[names[i]],e[wildcard]];k=2;while(k--){item=items[k];if(item){nes.push(item);out=out.concat(item.f||[]);}}}
es=nes;}
return out;};eve.on=function(name,f){var names=name.split(separator),e=events;for(var i=0,ii=names.length;i<ii;i++){e=e.n;!e[names[i]]&&(e[names[i]]={n:{}});e=e[names[i]];}
e.f=e.f||[];for(i=0,ii=e.f.length;i<ii;i++)if(e.f[i]==f){return fun;}
e.f.push(f);return function(zIndex){if(+zIndex==+zIndex){f.zIndex=+zIndex;}};};eve.nt=function(subname){if(subname){return new RegExp("(?:\\.|\\/|^)"+subname+"(?:\\.|\\/|$)").test(current_event);}
return current_event;};eve.unbind=function(name,f){var names=name.split(separator),e,key,splice,cur=[events];for(var i=0,ii=names.length;i<ii;i++){for(var j=0;j<cur.length;j+=splice.length-2){splice=[j,1];e=cur[j].n;if(names[i]!=wildcard){if(e[names[i]]){splice.push(e[names[i]]);}}else{for(key in e)if(e[has](key)){splice.push(e[key]);}}
cur.splice.apply(cur,splice);}}
for(i=0,ii=cur.length;i<ii;i++){e=cur[i];while(e.n){if(f){if(e.f){for(i=0,ii=e.f.length;i<ii;i++)if(e.f[i]==f){e.f.splice(i,1);break;}!e.f.length&&delete e.f;}
for(key in e.n)if(e.n[has](key)&&e.n[key].f){var funcs=e.n[key].f;for(i=0,ii=funcs.length;i<ii;i++)if(funcs[i]==f){funcs.splice(i,1);break;}!funcs.length&&delete e.n[key].f;}}else{delete e.f;for(key in e.n)if(e.n[has](key)&&e.n[key].f){delete e.n[key].f;}}
e=e.n;}}};eve.version=version;eve.toString=function(){return"You are running Eve "+version;};(typeof module!="undefined"&&module.exports)?(module.exports=eve):(glob.eve=eve);})(this);
(function(glob){var version="0.4.2",has="hasOwnProperty",separator=/[\.\/]/,wildcard="*",fun=function(){},numsort=function(a,b){return a-b;},current_event,stop,events={n:{}},eve=function(name,scope){name=String(name);var e=events,oldstop=stop,args=Array.prototype.slice.call(arguments,2),listeners=eve.listeners(name),z=0,f=false,l,indexed=[],queue={},out=[],ce=current_event,errors=[];current_event=name;stop=0;for(var i=0,ii=listeners.length;i<ii;i++)if("zIndex"in listeners[i]){indexed.push(listeners[i].zIndex);if(listeners[i].zIndex<0){queue[listeners[i].zIndex]=listeners[i];}}
indexed.sort(numsort);while(indexed[z]<0){l=queue[indexed[z++]];out.push(l.apply(scope,args));if(stop){stop=oldstop;return out;}}
for(i=0;i<ii;i++){l=listeners[i];if("zIndex"in l){if(l.zIndex==indexed[z]){out.push(l.apply(scope,args));if(stop){break;}
do{z++;l=queue[indexed[z]];l&&out.push(l.apply(scope,args));if(stop){break;}}while(l)}else{queue[l.zIndex]=l;}}else{out.push(l.apply(scope,args));if(stop){break;}}}
stop=oldstop;current_event=ce;return out.length?out:null;};eve._events=events;eve.listeners=function(name){var names=name.split(separator),e=events,item,items,k,i,ii,j,jj,nes,es=[e],out=[];for(i=0,ii=names.length;i<ii;i++){nes=[];for(j=0,jj=es.length;j<jj;j++){e=es[j].n;items=[e[names[i]],e[wildcard]];k=2;while(k--){item=items[k];if(item){nes.push(item);out=out.concat(item.f||[]);}}}
es=nes;}
return out;};eve.on=function(name,f){name=String(name);if(typeof f!="function"){return function(){};}
var names=name.split(separator),e=events;for(var i=0,ii=names.length;i<ii;i++){e=e.n;e=e.hasOwnProperty(names[i])&&e[names[i]]||(e[names[i]]={n:{}});}
e.f=e.f||[];for(i=0,ii=e.f.length;i<ii;i++)if(e.f[i]==f){return fun;}
e.f.push(f);return function(zIndex){if(+zIndex==+zIndex){f.zIndex=+zIndex;}};};eve.f=function(event){var attrs=[].slice.call(arguments,1);return function(){eve.apply(null,[event,null].concat(attrs).concat([].slice.call(arguments,0)));};};eve.stop=function(){stop=1;};eve.nt=function(subname){if(subname){return new RegExp("(?:\\.|\\/|^)"+subname+"(?:\\.|\\/|$)").test(current_event);}
return current_event;};eve.nts=function(){return current_event.split(separator);};eve.off=eve.unbind=function(name,f){if(!name){eve._events=events={n:{}};return;}
var names=name.split(separator),e,key,splice,i,ii,j,jj,cur=[events];for(i=0,ii=names.length;i<ii;i++){for(j=0;j<cur.length;j+=splice.length-2){splice=[j,1];e=cur[j].n;if(names[i]!=wildcard){if(e[names[i]]){splice.push(e[names[i]]);}}else{for(key in e)if(e[has](key)){splice.push(e[key]);}}
cur.splice.apply(cur,splice);}}
for(i=0,ii=cur.length;i<ii;i++){e=cur[i];while(e.n){if(f){if(e.f){for(j=0,jj=e.f.length;j<jj;j++)if(e.f[j]==f){e.f.splice(j,1);break;}!e.f.length&&delete e.f;}
for(key in e.n)if(e.n[has](key)&&e.n[key].f){var funcs=e.n[key].f;for(j=0,jj=funcs.length;j<jj;j++)if(funcs[j]==f){funcs.splice(j,1);break;}!funcs.length&&delete e.n[key].f;}}else{delete e.f;for(key in e.n)if(e.n[has](key)&&e.n[key].f){delete e.n[key].f;}}
e=e.n;}}};eve.once=function(name,f){var f2=function(){eve.unbind(name,f2);return f.apply(this,arguments);};return eve.on(name,f2);};eve.version=version;eve.toString=function(){return"You are running Eve "+version;};(typeof module!="undefined"&&module.exports)?(module.exports=eve):(typeof define!="undefined"?(define("eve",[],function(){return eve;})):(glob.eve=eve));})(window||this);(function(glob,factory){if(typeof define==="function"&&define.amd){define(["eve"],function(eve){return factory(glob,eve);});}else{factory(glob,glob.eve);}}(this,function(window,eve){function R(first){if(R.is(first,"function")){return loaded?first():eve.on("raphael.DOMload",first);}else if(R.is(first,array)){return R._engine.create[apply](R,first.splice(0,3+R.is(first[0],nu))).add(first);}else{var args=Array.prototype.slice.call(arguments,0);if(R.is(args[args.length-1],"function")){var f=args.pop();return loaded?f.call(R._engine.create[apply](R,args)):eve.on("raphael.DOMload",function(){f.call(R._engine.create[apply](R,args));});}else{return R._engine.create[apply](R,arguments);}}}
R.version="2.1.2";R.eve=eve;var loaded,separator=/[, ]+/,elements={circle:1,rect:1,path:1,ellipse:1,text:1,image:1},formatrg=/\{(\d+)\}/g,proto="prototype",has="hasOwnProperty",g={doc:document,win:window},oldRaphael={was:Object.prototype[has].call(g.win,"Raphael"),is:g.win.Raphael},Paper=function(){this.ca=this.customAttributes={};},paperproto,appendChild="appendChild",apply="apply",concat="concat",supportsTouch=('ontouchstart'in g.win)||g.win.DocumentTouch&&g.doc instanceof DocumentTouch,E="",S=" ",Str=String,split="split",events="click dblclick mousedown mousemove mouseout mouseover mouseup touchstart touchmove touchend touchcancel"[split](S),touchMap={mousedown:"touchstart",mousemove:"touchmove",mouseup:"touchend"},lowerCase=Str.prototype.toLowerCase,math=Math,mmax=math.max,mmin=math.min,abs=math.abs,pow=math.pow,PI=math.PI,nu="number",string="string",array="array",toString="toString",fillString="fill",objectToString=Object.prototype.toString,paper={},push="push",ISURL=R._ISURL=/^url\(['"]?([^\)]+?)['"]?\)$/i,colourRegExp=/^\s*((#[a-f\d]{6})|(#[a-f\d]{3})|rgba?\(\s*([\d\.]+%?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+%?(?:\s*,\s*[\d\.]+%?)?)\s*\)|hsba?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\)|hsla?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\))\s*$/i,isnan={"NaN":1,"Infinity":1,"-Infinity":1},bezierrg=/^(?:cubic-)?bezier\(([^,]+),([^,]+),([^,]+),([^\)]+)\)/,round=math.round,setAttribute="setAttribute",toFloat=parseFloat,toInt=parseInt,upperCase=Str.prototype.toUpperCase,availableAttrs=R._availableAttrs={"arrow-end":"none","arrow-start":"none",blur:0,"clip-rect":"0 0 1e9 1e9",cursor:"default",cx:0,cy:0,fill:"#fff","fill-opacity":1,font:'10px "Arial"',"font-family":'"Arial"',"font-size":"10","font-style":"normal","font-weight":400,gradient:0,height:0,href:"http://raphaeljs.com/","letter-spacing":0,opacity:1,path:"M0,0",r:0,rx:0,ry:0,src:"",stroke:"#000","stroke-dasharray":"","stroke-linecap":"butt","stroke-linejoin":"butt","stroke-miterlimit":0,"stroke-opacity":1,"stroke-width":1,target:"_blank","text-anchor":"middle",title:"Raphael",transform:"",width:0,x:0,y:0},availableAnimAttrs=R._availableAnimAttrs={blur:nu,"clip-rect":"csv",cx:nu,cy:nu,fill:"colour","fill-opacity":nu,"font-size":nu,height:nu,opacity:nu,path:"path",r:nu,rx:nu,ry:nu,stroke:"colour","stroke-opacity":nu,"stroke-width":nu,transform:"transform",width:nu,x:nu,y:nu},whitespace=/[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]/g,commaSpaces=/[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/,hsrg={hs:1,rg:1},p2s=/,?([achlmqrstvxz]),?/gi,pathCommand=/([achlmrqstvz])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/ig,tCommand=/([rstm])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/ig,pathValues=/(-?\d*\.?\d*(?:e[\-+]?\d+)?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/ig,radial_gradient=R._radial_gradient=/^r(?:\(([^,]+?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*([^\)]+?)\))?/,eldata={},sortByKey=function(a,b){return a.key-b.key;},sortByNumber=function(a,b){return toFloat(a)-toFloat(b);},fun=function(){},pipe=function(x){return x;},rectPath=R._rectPath=function(x,y,w,h,r){if(r){return[["M",x+r,y],["l",w-r*2,0],["a",r,r,0,0,1,r,r],["l",0,h-r*2],["a",r,r,0,0,1,-r,r],["l",r*2-w,0],["a",r,r,0,0,1,-r,-r],["l",0,r*2-h],["a",r,r,0,0,1,r,-r],["z"]];}
return[["M",x,y],["l",w,0],["l",0,h],["l",-w,0],["z"]];},ellipsePath=function(x,y,rx,ry){if(ry==null){ry=rx;}
return[["M",x,y],["m",0,-ry],["a",rx,ry,0,1,1,0,2*ry],["a",rx,ry,0,1,1,0,-2*ry],["z"]];},getPath=R._getPath={path:function(el){return el.attr("path");},circle:function(el){var a=el.attrs;return ellipsePath(a.cx,a.cy,a.r);},ellipse:function(el){var a=el.attrs;return ellipsePath(a.cx,a.cy,a.rx,a.ry);},rect:function(el){var a=el.attrs;return rectPath(a.x,a.y,a.width,a.height,a.r);},image:function(el){var a=el.attrs;return rectPath(a.x,a.y,a.width,a.height);},text:function(el){var bbox=el._getBBox();return rectPath(bbox.x,bbox.y,bbox.width,bbox.height);},set:function(el){var bbox=el._getBBox();return rectPath(bbox.x,bbox.y,bbox.width,bbox.height);}},mapPath=R.mapPath=function(path,matrix){if(!matrix){return path;}
var x,y,i,j,ii,jj,pathi;path=path2curve(path);for(i=0,ii=path.length;i<ii;i++){pathi=path[i];for(j=1,jj=pathi.length;j<jj;j+=2){x=matrix.x(pathi[j],pathi[j+1]);y=matrix.y(pathi[j],pathi[j+1]);pathi[j]=x;pathi[j+1]=y;}}
return path;};R._g=g;R.type=(g.win.SVGAngle||g.doc.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")?"SVG":"VML");if(R.type=="VML"){var d=g.doc.createElement("div"),b;d.innerHTML='<v:shape adj="1"/>';b=d.firstChild;b.style.behavior="url(#default#VML)";if(!(b&&typeof b.adj=="object")){return(R.type=E);}
d=null;}
R.svg=!(R.vml=R.type=="VML");R._Paper=Paper;R.fn=paperproto=Paper.prototype=R.prototype;R._id=0;R._oid=0;R.is=function(o,type){type=lowerCase.call(type);if(type=="finite"){return!isnan[has](+o);}
if(type=="array"){return o instanceof Array;}
return(type=="null"&&o===null)||(type==typeof o&&o!==null)||(type=="object"&&o===Object(o))||(type=="array"&&Array.isArray&&Array.isArray(o))||objectToString.call(o).slice(8,-1).toLowerCase()==type;};function clone(obj){if(typeof obj=="function"||Object(obj)!==obj){return obj;}
var res=new obj.constructor;for(var key in obj)if(obj[has](key)){res[key]=clone(obj[key]);}
return res;}
R.angle=function(x1,y1,x2,y2,x3,y3){if(x3==null){var x=x1-x2,y=y1-y2;if(!x&&!y){return 0;}
return(180+math.atan2(-y,-x)*180/PI+360)%360;}else{return R.angle(x1,y1,x3,y3)-R.angle(x2,y2,x3,y3);}};R.rad=function(deg){return deg%360*PI/180;};R.deg=function(rad){return rad*180/PI%360;};R.snapTo=function(values,value,tolerance){tolerance=R.is(tolerance,"finite")?tolerance:10;if(R.is(values,array)){var i=values.length;while(i--)if(abs(values[i]-value)<=tolerance){return values[i];}}else{values=+values;var rem=value%values;if(rem<tolerance){return value-rem;}
if(rem>values-tolerance){return value-rem+values;}}
return value;};var createUUID=R.createUUID=(function(uuidRegEx,uuidReplacer){return function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(uuidRegEx,uuidReplacer).toUpperCase();};})(/[xy]/g,function(c){var r=math.random()*16|0,v=c=="x"?r:(r&3|8);return v.toString(16);});R.setWindow=function(newwin){eve("raphael.setWindow",R,g.win,newwin);g.win=newwin;g.doc=g.win.document;if(R._engine.initWin){R._engine.initWin(g.win);}};var toHex=function(color){if(R.vml){var trim=/^\s+|\s+$/g;var bod;try{var docum=new ActiveXObject("htmlfile");docum.write("<body>");docum.close();bod=docum.body;}catch(e){bod=createPopup().document.body;}
var range=bod.createTextRange();toHex=cacher(function(color){try{bod.style.color=Str(color).replace(trim,E);var value=range.queryCommandValue("ForeColor");value=((value&255)<<16)|(value&65280)|((value&16711680)>>>16);return"#"+("000000"+value.toString(16)).slice(-6);}catch(e){return"none";}});}else{var i=g.doc.createElement("i");i.title="Rapha\xebl Colour Picker";i.style.display="none";g.doc.body.appendChild(i);toHex=cacher(function(color){i.style.color=color;return g.doc.defaultView.getComputedStyle(i,E).getPropertyValue("color");});}
return toHex(color);},hsbtoString=function(){return"hsb("+[this.h,this.s,this.b]+")";},hsltoString=function(){return"hsl("+[this.h,this.s,this.l]+")";},rgbtoString=function(){return this.hex;},prepareRGB=function(r,g,b){if(g==null&&R.is(r,"object")&&"r"in r&&"g"in r&&"b"in r){b=r.b;g=r.g;r=r.r;}
if(g==null&&R.is(r,string)){var clr=R.getRGB(r);r=clr.r;g=clr.g;b=clr.b;}
if(r>1||g>1||b>1){r/=255;g/=255;b/=255;}
return[r,g,b];},packageRGB=function(r,g,b,o){r*=255;g*=255;b*=255;var rgb={r:r,g:g,b:b,hex:R.rgb(r,g,b),toString:rgbtoString};R.is(o,"finite")&&(rgb.opacity=o);return rgb;};R.color=function(clr){var rgb;if(R.is(clr,"object")&&"h"in clr&&"s"in clr&&"b"in clr){rgb=R.hsb2rgb(clr);clr.r=rgb.r;clr.g=rgb.g;clr.b=rgb.b;clr.hex=rgb.hex;}else if(R.is(clr,"object")&&"h"in clr&&"s"in clr&&"l"in clr){rgb=R.hsl2rgb(clr);clr.r=rgb.r;clr.g=rgb.g;clr.b=rgb.b;clr.hex=rgb.hex;}else{if(R.is(clr,"string")){clr=R.getRGB(clr);}
if(R.is(clr,"object")&&"r"in clr&&"g"in clr&&"b"in clr){rgb=R.rgb2hsl(clr);clr.h=rgb.h;clr.s=rgb.s;clr.l=rgb.l;rgb=R.rgb2hsb(clr);clr.v=rgb.b;}else{clr={hex:"none"};clr.r=clr.g=clr.b=clr.h=clr.s=clr.v=clr.l=-1;}}
clr.toString=rgbtoString;return clr;};R.hsb2rgb=function(h,s,v,o){if(this.is(h,"object")&&"h"in h&&"s"in h&&"b"in h){v=h.b;s=h.s;h=h.h;o=h.o;}
h*=360;var R,G,B,X,C;h=(h%360)/60;C=v*s;X=C*(1-abs(h%2-1));R=G=B=v-C;h=~~h;R+=[C,X,0,0,X,C][h];G+=[X,C,C,X,0,0][h];B+=[0,0,X,C,C,X][h];return packageRGB(R,G,B,o);};R.hsl2rgb=function(h,s,l,o){if(this.is(h,"object")&&"h"in h&&"s"in h&&"l"in h){l=h.l;s=h.s;h=h.h;}
if(h>1||s>1||l>1){h/=360;s/=100;l/=100;}
h*=360;var R,G,B,X,C;h=(h%360)/60;C=2*s*(l<.5?l:1-l);X=C*(1-abs(h%2-1));R=G=B=l-C/2;h=~~h;R+=[C,X,0,0,X,C][h];G+=[X,C,C,X,0,0][h];B+=[0,0,X,C,C,X][h];return packageRGB(R,G,B,o);};R.rgb2hsb=function(r,g,b){b=prepareRGB(r,g,b);r=b[0];g=b[1];b=b[2];var H,S,V,C;V=mmax(r,g,b);C=V-mmin(r,g,b);H=(C==0?null:V==r?(g-b)/C:V==g?(b-r)/C+2:(r-g)/C+4);H=((H+360)%6)*60/360;S=C==0?0:C/V;return{h:H,s:S,b:V,toString:hsbtoString};};R.rgb2hsl=function(r,g,b){b=prepareRGB(r,g,b);r=b[0];g=b[1];b=b[2];var H,S,L,M,m,C;M=mmax(r,g,b);m=mmin(r,g,b);C=M-m;H=(C==0?null:M==r?(g-b)/C:M==g?(b-r)/C+2:(r-g)/C+4);H=((H+360)%6)*60/360;L=(M+m)/2;S=(C==0?0:L<.5?C/(2*L):C/(2-2*L));return{h:H,s:S,l:L,toString:hsltoString};};R._path2string=function(){return this.join(",").replace(p2s,"$1");};function repush(array,item){for(var i=0,ii=array.length;i<ii;i++)if(array[i]===item){return array.push(array.splice(i,1)[0]);}}
function cacher(f,scope,postprocessor){function newf(){var arg=Array.prototype.slice.call(arguments,0),args=arg.join("\u2400"),cache=newf.cache=newf.cache||{},count=newf.count=newf.count||[];if(cache[has](args)){repush(count,args);return postprocessor?postprocessor(cache[args]):cache[args];}
count.length>=1e3&&delete cache[count.shift()];count.push(args);cache[args]=f[apply](scope,arg);return postprocessor?postprocessor(cache[args]):cache[args];}
return newf;}
var preload=R._preload=function(src,f){var img=g.doc.createElement("img");img.style.cssText="position:absolute;left:-9999em;top:-9999em";img.onload=function(){f.call(this);this.onload=null;g.doc.body.removeChild(this);};img.onerror=function(){g.doc.body.removeChild(this);};g.doc.body.appendChild(img);img.src=src;};function clrToString(){return this.hex;}
R.getRGB=cacher(function(colour){if(!colour||!!((colour=Str(colour)).indexOf("-")+1)){return{r:-1,g:-1,b:-1,hex:"none",error:1,toString:clrToString};}
if(colour=="none"){return{r:-1,g:-1,b:-1,hex:"none",toString:clrToString};}!(hsrg[has](colour.toLowerCase().substring(0,2))||colour.charAt()=="#")&&(colour=toHex(colour));var res,red,green,blue,opacity,t,values,rgb=colour.match(colourRegExp);if(rgb){if(rgb[2]){blue=toInt(rgb[2].substring(5),16);green=toInt(rgb[2].substring(3,5),16);red=toInt(rgb[2].substring(1,3),16);}
if(rgb[3]){blue=toInt((t=rgb[3].charAt(3))+t,16);green=toInt((t=rgb[3].charAt(2))+t,16);red=toInt((t=rgb[3].charAt(1))+t,16);}
if(rgb[4]){values=rgb[4][split](commaSpaces);red=toFloat(values[0]);values[0].slice(-1)=="%"&&(red*=2.55);green=toFloat(values[1]);values[1].slice(-1)=="%"&&(green*=2.55);blue=toFloat(values[2]);values[2].slice(-1)=="%"&&(blue*=2.55);rgb[1].toLowerCase().slice(0,4)=="rgba"&&(opacity=toFloat(values[3]));values[3]&&values[3].slice(-1)=="%"&&(opacity/=100);}
if(rgb[5]){values=rgb[5][split](commaSpaces);red=toFloat(values[0]);values[0].slice(-1)=="%"&&(red*=2.55);green=toFloat(values[1]);values[1].slice(-1)=="%"&&(green*=2.55);blue=toFloat(values[2]);values[2].slice(-1)=="%"&&(blue*=2.55);(values[0].slice(-3)=="deg"||values[0].slice(-1)=="\xb0")&&(red/=360);rgb[1].toLowerCase().slice(0,4)=="hsba"&&(opacity=toFloat(values[3]));values[3]&&values[3].slice(-1)=="%"&&(opacity/=100);return R.hsb2rgb(red,green,blue,opacity);}
if(rgb[6]){values=rgb[6][split](commaSpaces);red=toFloat(values[0]);values[0].slice(-1)=="%"&&(red*=2.55);green=toFloat(values[1]);values[1].slice(-1)=="%"&&(green*=2.55);blue=toFloat(values[2]);values[2].slice(-1)=="%"&&(blue*=2.55);(values[0].slice(-3)=="deg"||values[0].slice(-1)=="\xb0")&&(red/=360);rgb[1].toLowerCase().slice(0,4)=="hsla"&&(opacity=toFloat(values[3]));values[3]&&values[3].slice(-1)=="%"&&(opacity/=100);return R.hsl2rgb(red,green,blue,opacity);}
rgb={r:red,g:green,b:blue,toString:clrToString};rgb.hex="#"+(16777216|blue|(green<<8)|(red<<16)).toString(16).slice(1);R.is(opacity,"finite")&&(rgb.opacity=opacity);return rgb;}
return{r:-1,g:-1,b:-1,hex:"none",error:1,toString:clrToString};},R);R.hsb=cacher(function(h,s,b){return R.hsb2rgb(h,s,b).hex;});R.hsl=cacher(function(h,s,l){return R.hsl2rgb(h,s,l).hex;});R.rgb=cacher(function(r,g,b){return"#"+(16777216|b|(g<<8)|(r<<16)).toString(16).slice(1);});R.getColor=function(value){var start=this.getColor.start=this.getColor.start||{h:0,s:1,b:value||.75},rgb=this.hsb2rgb(start.h,start.s,start.b);start.h+=.075;if(start.h>1){start.h=0;start.s-=.2;start.s<=0&&(this.getColor.start={h:0,s:1,b:start.b});}
return rgb.hex;};R.getColor.reset=function(){delete this.start;};function catmullRom2bezier(crp,z){var d=[];for(var i=0,iLen=crp.length;iLen-2*!z>i;i+=2){var p=[{x:+crp[i-2],y:+crp[i-1]},{x:+crp[i],y:+crp[i+1]},{x:+crp[i+2],y:+crp[i+3]},{x:+crp[i+4],y:+crp[i+5]}];if(z){if(!i){p[0]={x:+crp[iLen-2],y:+crp[iLen-1]};}else if(iLen-4==i){p[3]={x:+crp[0],y:+crp[1]};}else if(iLen-2==i){p[2]={x:+crp[0],y:+crp[1]};p[3]={x:+crp[2],y:+crp[3]};}}else{if(iLen-4==i){p[3]=p[2];}else if(!i){p[0]={x:+crp[i],y:+crp[i+1]};}}
d.push(["C",(-p[0].x+6*p[1].x+p[2].x)/6,(-p[0].y+6*p[1].y+p[2].y)/6,(p[1].x+6*p[2].x-p[3].x)/6,(p[1].y+6*p[2].y-p[3].y)/6,p[2].x,p[2].y]);}
return d;}
R.parsePathString=function(pathString){if(!pathString){return null;}
var pth=paths(pathString);if(pth.arr){return pathClone(pth.arr);}
var paramCounts={a:7,c:6,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,z:0},data=[];if(R.is(pathString,array)&&R.is(pathString[0],array)){data=pathClone(pathString);}
if(!data.length){Str(pathString).replace(pathCommand,function(a,b,c){var params=[],name=b.toLowerCase();c.replace(pathValues,function(a,b){b&&params.push(+b);});if(name=="m"&&params.length>2){data.push([b][concat](params.splice(0,2)));name="l";b=b=="m"?"l":"L";}
if(name=="r"){data.push([b][concat](params));}else while(params.length>=paramCounts[name]){data.push([b][concat](params.splice(0,paramCounts[name])));if(!paramCounts[name]){break;}}});}
data.toString=R._path2string;pth.arr=pathClone(data);return data;};R.parseTransformString=cacher(function(TString){if(!TString){return null;}
var paramCounts={r:3,s:4,t:2,m:6},data=[];if(R.is(TString,array)&&R.is(TString[0],array)){data=pathClone(TString);}
if(!data.length){Str(TString).replace(tCommand,function(a,b,c){var params=[],name=lowerCase.call(b);c.replace(pathValues,function(a,b){b&&params.push(+b);});data.push([b][concat](params));});}
data.toString=R._path2string;return data;});var paths=function(ps){var p=paths.ps=paths.ps||{};if(p[ps]){p[ps].sleep=100;}else{p[ps]={sleep:100};}
setTimeout(function(){for(var key in p)if(p[has](key)&&key!=ps){p[key].sleep--;!p[key].sleep&&delete p[key];}});return p[ps];};R.findDotsAtSegment=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t){var t1=1-t,t13=pow(t1,3),t12=pow(t1,2),t2=t*t,t3=t2*t,x=t13*p1x+t12*3*t*c1x+t1*3*t*t*c2x+t3*p2x,y=t13*p1y+t12*3*t*c1y+t1*3*t*t*c2y+t3*p2y,mx=p1x+2*t*(c1x-p1x)+t2*(c2x-2*c1x+p1x),my=p1y+2*t*(c1y-p1y)+t2*(c2y-2*c1y+p1y),nx=c1x+2*t*(c2x-c1x)+t2*(p2x-2*c2x+c1x),ny=c1y+2*t*(c2y-c1y)+t2*(p2y-2*c2y+c1y),ax=t1*p1x+t*c1x,ay=t1*p1y+t*c1y,cx=t1*c2x+t*p2x,cy=t1*c2y+t*p2y,alpha=(90-math.atan2(mx-nx,my-ny)*180/PI);(mx>nx||my<ny)&&(alpha+=180);return{x:x,y:y,m:{x:mx,y:my},n:{x:nx,y:ny},start:{x:ax,y:ay},end:{x:cx,y:cy},alpha:alpha};};R.bezierBBox=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y){if(!R.is(p1x,"array")){p1x=[p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y];}
var bbox=curveDim.apply(null,p1x);return{x:bbox.min.x,y:bbox.min.y,x2:bbox.max.x,y2:bbox.max.y,width:bbox.max.x-bbox.min.x,height:bbox.max.y-bbox.min.y};};R.isPointInsideBBox=function(bbox,x,y){return x>=bbox.x&&x<=bbox.x2&&y>=bbox.y&&y<=bbox.y2;};R.isBBoxIntersect=function(bbox1,bbox2){var i=R.isPointInsideBBox;return i(bbox2,bbox1.x,bbox1.y)||i(bbox2,bbox1.x2,bbox1.y)||i(bbox2,bbox1.x,bbox1.y2)||i(bbox2,bbox1.x2,bbox1.y2)||i(bbox1,bbox2.x,bbox2.y)||i(bbox1,bbox2.x2,bbox2.y)||i(bbox1,bbox2.x,bbox2.y2)||i(bbox1,bbox2.x2,bbox2.y2)||(bbox1.x<bbox2.x2&&bbox1.x>bbox2.x||bbox2.x<bbox1.x2&&bbox2.x>bbox1.x)&&(bbox1.y<bbox2.y2&&bbox1.y>bbox2.y||bbox2.y<bbox1.y2&&bbox2.y>bbox1.y);};function base3(t,p1,p2,p3,p4){var t1=-3*p1+9*p2-9*p3+3*p4,t2=t*t1+6*p1-12*p2+6*p3;return t*t2-3*p1+3*p2;}
function bezlen(x1,y1,x2,y2,x3,y3,x4,y4,z){if(z==null){z=1;}
z=z>1?1:z<0?0:z;var z2=z/2,n=12,Tvalues=[-0.1252,0.1252,-0.3678,0.3678,-0.5873,0.5873,-0.7699,0.7699,-0.9041,0.9041,-0.9816,0.9816],Cvalues=[0.2491,0.2491,0.2335,0.2335,0.2032,0.2032,0.1601,0.1601,0.1069,0.1069,0.0472,0.0472],sum=0;for(var i=0;i<n;i++){var ct=z2*Tvalues[i]+z2,xbase=base3(ct,x1,x2,x3,x4),ybase=base3(ct,y1,y2,y3,y4),comb=xbase*xbase+ybase*ybase;sum+=Cvalues[i]*math.sqrt(comb);}
return z2*sum;}
function getTatLen(x1,y1,x2,y2,x3,y3,x4,y4,ll){if(ll<0||bezlen(x1,y1,x2,y2,x3,y3,x4,y4)<ll){return;}
var t=1,step=t/2,t2=t-step,l,e=.01;l=bezlen(x1,y1,x2,y2,x3,y3,x4,y4,t2);while(abs(l-ll)>e){step/=2;t2+=(l<ll?1:-1)*step;l=bezlen(x1,y1,x2,y2,x3,y3,x4,y4,t2);}
return t2;}
function intersect(x1,y1,x2,y2,x3,y3,x4,y4){if(mmax(x1,x2)<mmin(x3,x4)||mmin(x1,x2)>mmax(x3,x4)||mmax(y1,y2)<mmin(y3,y4)||mmin(y1,y2)>mmax(y3,y4)){return;}
var nx=(x1*y2-y1*x2)*(x3-x4)-(x1-x2)*(x3*y4-y3*x4),ny=(x1*y2-y1*x2)*(y3-y4)-(y1-y2)*(x3*y4-y3*x4),denominator=(x1-x2)*(y3-y4)-(y1-y2)*(x3-x4);if(!denominator){return;}
var px=nx/denominator,py=ny/denominator,px2=+px.toFixed(2),py2=+py.toFixed(2);if(px2<+mmin(x1,x2).toFixed(2)||px2>+mmax(x1,x2).toFixed(2)||px2<+mmin(x3,x4).toFixed(2)||px2>+mmax(x3,x4).toFixed(2)||py2<+mmin(y1,y2).toFixed(2)||py2>+mmax(y1,y2).toFixed(2)||py2<+mmin(y3,y4).toFixed(2)||py2>+mmax(y3,y4).toFixed(2)){return;}
return{x:px,y:py};}
function inter(bez1,bez2){return interHelper(bez1,bez2);}
function interCount(bez1,bez2){return interHelper(bez1,bez2,1);}
function interHelper(bez1,bez2,justCount){var bbox1=R.bezierBBox(bez1),bbox2=R.bezierBBox(bez2);if(!R.isBBoxIntersect(bbox1,bbox2)){return justCount?0:[];}
var l1=bezlen.apply(0,bez1),l2=bezlen.apply(0,bez2),n1=mmax(~~(l1/5),1),n2=mmax(~~(l2/5),1),dots1=[],dots2=[],xy={},res=justCount?0:[];for(var i=0;i<n1+1;i++){var p=R.findDotsAtSegment.apply(R,bez1.concat(i/n1));dots1.push({x:p.x,y:p.y,t:i/n1});}
for(i=0;i<n2+1;i++){p=R.findDotsAtSegment.apply(R,bez2.concat(i/n2));dots2.push({x:p.x,y:p.y,t:i/n2});}
for(i=0;i<n1;i++){for(var j=0;j<n2;j++){var di=dots1[i],di1=dots1[i+1],dj=dots2[j],dj1=dots2[j+1],ci=abs(di1.x-di.x)<.001?"y":"x",cj=abs(dj1.x-dj.x)<.001?"y":"x",is=intersect(di.x,di.y,di1.x,di1.y,dj.x,dj.y,dj1.x,dj1.y);if(is){if(xy[is.x.toFixed(4)]==is.y.toFixed(4)){continue;}
xy[is.x.toFixed(4)]=is.y.toFixed(4);var t1=di.t+abs((is[ci]-di[ci])/(di1[ci]-di[ci]))*(di1.t-di.t),t2=dj.t+abs((is[cj]-dj[cj])/(dj1[cj]-dj[cj]))*(dj1.t-dj.t);if(t1>=0&&t1<=1.001&&t2>=0&&t2<=1.001){if(justCount){res++;}else{res.push({x:is.x,y:is.y,t1:mmin(t1,1),t2:mmin(t2,1)});}}}}}
return res;}
R.pathIntersection=function(path1,path2){return interPathHelper(path1,path2);};R.pathIntersectionNumber=function(path1,path2){return interPathHelper(path1,path2,1);};function interPathHelper(path1,path2,justCount){path1=R._path2curve(path1);path2=R._path2curve(path2);var x1,y1,x2,y2,x1m,y1m,x2m,y2m,bez1,bez2,res=justCount?0:[];for(var i=0,ii=path1.length;i<ii;i++){var pi=path1[i];if(pi[0]=="M"){x1=x1m=pi[1];y1=y1m=pi[2];}else{if(pi[0]=="C"){bez1=[x1,y1].concat(pi.slice(1));x1=bez1[6];y1=bez1[7];}else{bez1=[x1,y1,x1,y1,x1m,y1m,x1m,y1m];x1=x1m;y1=y1m;}
for(var j=0,jj=path2.length;j<jj;j++){var pj=path2[j];if(pj[0]=="M"){x2=x2m=pj[1];y2=y2m=pj[2];}else{if(pj[0]=="C"){bez2=[x2,y2].concat(pj.slice(1));x2=bez2[6];y2=bez2[7];}else{bez2=[x2,y2,x2,y2,x2m,y2m,x2m,y2m];x2=x2m;y2=y2m;}
var intr=interHelper(bez1,bez2,justCount);if(justCount){res+=intr;}else{for(var k=0,kk=intr.length;k<kk;k++){intr[k].segment1=i;intr[k].segment2=j;intr[k].bez1=bez1;intr[k].bez2=bez2;}
res=res.concat(intr);}}}}}
return res;}
R.isPointInsidePath=function(path,x,y){var bbox=R.pathBBox(path);return R.isPointInsideBBox(bbox,x,y)&&interPathHelper(path,[["M",x,y],["H",bbox.x2+10]],1)%2==1;};R._removedFactory=function(methodname){return function(){eve("raphael.log",null,"Rapha\xebl: you are calling to method \u201c"+methodname+"\u201d of removed object",methodname);};};var pathDimensions=R.pathBBox=function(path){var pth=paths(path);if(pth.bbox){return clone(pth.bbox);}
if(!path){return{x:0,y:0,width:0,height:0,x2:0,y2:0};}
path=path2curve(path);var x=0,y=0,X=[],Y=[],p;for(var i=0,ii=path.length;i<ii;i++){p=path[i];if(p[0]=="M"){x=p[1];y=p[2];X.push(x);Y.push(y);}else{var dim=curveDim(x,y,p[1],p[2],p[3],p[4],p[5],p[6]);X=X[concat](dim.min.x,dim.max.x);Y=Y[concat](dim.min.y,dim.max.y);x=p[5];y=p[6];}}
var xmin=mmin[apply](0,X),ymin=mmin[apply](0,Y),xmax=mmax[apply](0,X),ymax=mmax[apply](0,Y),width=xmax-xmin,height=ymax-ymin,bb={x:xmin,y:ymin,x2:xmax,y2:ymax,width:width,height:height,cx:xmin+width/2,cy:ymin+height/2};pth.bbox=clone(bb);return bb;},pathClone=function(pathArray){var res=clone(pathArray);res.toString=R._path2string;return res;},pathToRelative=R._pathToRelative=function(pathArray){var pth=paths(pathArray);if(pth.rel){return pathClone(pth.rel);}
if(!R.is(pathArray,array)||!R.is(pathArray&&pathArray[0],array)){pathArray=R.parsePathString(pathArray);}
var res=[],x=0,y=0,mx=0,my=0,start=0;if(pathArray[0][0]=="M"){x=pathArray[0][1];y=pathArray[0][2];mx=x;my=y;start++;res.push(["M",x,y]);}
for(var i=start,ii=pathArray.length;i<ii;i++){var r=res[i]=[],pa=pathArray[i];if(pa[0]!=lowerCase.call(pa[0])){r[0]=lowerCase.call(pa[0]);switch(r[0]){case"a":r[1]=pa[1];r[2]=pa[2];r[3]=pa[3];r[4]=pa[4];r[5]=pa[5];r[6]=+(pa[6]-x).toFixed(3);r[7]=+(pa[7]-y).toFixed(3);break;case"v":r[1]=+(pa[1]-y).toFixed(3);break;case"m":mx=pa[1];my=pa[2];default:for(var j=1,jj=pa.length;j<jj;j++){r[j]=+(pa[j]-((j%2)?x:y)).toFixed(3);}}}else{r=res[i]=[];if(pa[0]=="m"){mx=pa[1]+x;my=pa[2]+y;}
for(var k=0,kk=pa.length;k<kk;k++){res[i][k]=pa[k];}}
var len=res[i].length;switch(res[i][0]){case"z":x=mx;y=my;break;case"h":x+=+res[i][len-1];break;case"v":y+=+res[i][len-1];break;default:x+=+res[i][len-2];y+=+res[i][len-1];}}
res.toString=R._path2string;pth.rel=pathClone(res);return res;},pathToAbsolute=R._pathToAbsolute=function(pathArray){var pth=paths(pathArray);if(pth.abs){return pathClone(pth.abs);}
if(!R.is(pathArray,array)||!R.is(pathArray&&pathArray[0],array)){pathArray=R.parsePathString(pathArray);}
if(!pathArray||!pathArray.length){return[["M",0,0]];}
var res=[],x=0,y=0,mx=0,my=0,start=0;if(pathArray[0][0]=="M"){x=+pathArray[0][1];y=+pathArray[0][2];mx=x;my=y;start++;res[0]=["M",x,y];}
var crz=pathArray.length==3&&pathArray[0][0]=="M"&&pathArray[1][0].toUpperCase()=="R"&&pathArray[2][0].toUpperCase()=="Z";for(var r,pa,i=start,ii=pathArray.length;i<ii;i++){res.push(r=[]);pa=pathArray[i];if(pa[0]!=upperCase.call(pa[0])){r[0]=upperCase.call(pa[0]);switch(r[0]){case"A":r[1]=pa[1];r[2]=pa[2];r[3]=pa[3];r[4]=pa[4];r[5]=pa[5];r[6]=+(pa[6]+x);r[7]=+(pa[7]+y);break;case"V":r[1]=+pa[1]+y;break;case"H":r[1]=+pa[1]+x;break;case"R":var dots=[x,y][concat](pa.slice(1));for(var j=2,jj=dots.length;j<jj;j++){dots[j]=+dots[j]+x;dots[++j]=+dots[j]+y;}
res.pop();res=res[concat](catmullRom2bezier(dots,crz));break;case"M":mx=+pa[1]+x;my=+pa[2]+y;default:for(j=1,jj=pa.length;j<jj;j++){r[j]=+pa[j]+((j%2)?x:y);}}}else if(pa[0]=="R"){dots=[x,y][concat](pa.slice(1));res.pop();res=res[concat](catmullRom2bezier(dots,crz));r=["R"][concat](pa.slice(-2));}else{for(var k=0,kk=pa.length;k<kk;k++){r[k]=pa[k];}}
switch(r[0]){case"Z":x=mx;y=my;break;case"H":x=r[1];break;case"V":y=r[1];break;case"M":mx=r[r.length-2];my=r[r.length-1];default:x=r[r.length-2];y=r[r.length-1];}}
res.toString=R._path2string;pth.abs=pathClone(res);return res;},l2c=function(x1,y1,x2,y2){return[x1,y1,x2,y2,x2,y2];},q2c=function(x1,y1,ax,ay,x2,y2){var _13=1/3,_23=2/3;return[_13*x1+_23*ax,_13*y1+_23*ay,_13*x2+_23*ax,_13*y2+_23*ay,x2,y2];},a2c=function(x1,y1,rx,ry,angle,large_arc_flag,sweep_flag,x2,y2,recursive){var _120=PI*120/180,rad=PI/180*(+angle||0),res=[],xy,rotate=cacher(function(x,y,rad){var X=x*math.cos(rad)-y*math.sin(rad),Y=x*math.sin(rad)+y*math.cos(rad);return{x:X,y:Y};});if(!recursive){xy=rotate(x1,y1,-rad);x1=xy.x;y1=xy.y;xy=rotate(x2,y2,-rad);x2=xy.x;y2=xy.y;var cos=math.cos(PI/180*angle),sin=math.sin(PI/180*angle),x=(x1-x2)/2,y=(y1-y2)/2;var h=(x*x)/(rx*rx)+(y*y)/(ry*ry);if(h>1){h=math.sqrt(h);rx=h*rx;ry=h*ry;}
var rx2=rx*rx,ry2=ry*ry,k=(large_arc_flag==sweep_flag?-1:1)*math.sqrt(abs((rx2*ry2-rx2*y*y-ry2*x*x)/(rx2*y*y+ry2*x*x))),cx=k*rx*y/ry+(x1+x2)/2,cy=k*-ry*x/rx+(y1+y2)/2,f1=math.asin(((y1-cy)/ry).toFixed(9)),f2=math.asin(((y2-cy)/ry).toFixed(9));f1=x1<cx?PI-f1:f1;f2=x2<cx?PI-f2:f2;f1<0&&(f1=PI*2+f1);f2<0&&(f2=PI*2+f2);if(sweep_flag&&f1>f2){f1=f1-PI*2;}
if(!sweep_flag&&f2>f1){f2=f2-PI*2;}}else{f1=recursive[0];f2=recursive[1];cx=recursive[2];cy=recursive[3];}
var df=f2-f1;if(abs(df)>_120){var f2old=f2,x2old=x2,y2old=y2;f2=f1+_120*(sweep_flag&&f2>f1?1:-1);x2=cx+rx*math.cos(f2);y2=cy+ry*math.sin(f2);res=a2c(x2,y2,rx,ry,angle,0,sweep_flag,x2old,y2old,[f2,f2old,cx,cy]);}
df=f2-f1;var c1=math.cos(f1),s1=math.sin(f1),c2=math.cos(f2),s2=math.sin(f2),t=math.tan(df/4),hx=4/3*rx*t,hy=4/3*ry*t,m1=[x1,y1],m2=[x1+hx*s1,y1-hy*c1],m3=[x2+hx*s2,y2-hy*c2],m4=[x2,y2];m2[0]=2*m1[0]-m2[0];m2[1]=2*m1[1]-m2[1];if(recursive){return[m2,m3,m4][concat](res);}else{res=[m2,m3,m4][concat](res).join()[split](",");var newres=[];for(var i=0,ii=res.length;i<ii;i++){newres[i]=i%2?rotate(res[i-1],res[i],rad).y:rotate(res[i],res[i+1],rad).x;}
return newres;}},findDotAtSegment=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t){var t1=1-t;return{x:pow(t1,3)*p1x+pow(t1,2)*3*t*c1x+t1*3*t*t*c2x+pow(t,3)*p2x,y:pow(t1,3)*p1y+pow(t1,2)*3*t*c1y+t1*3*t*t*c2y+pow(t,3)*p2y};},curveDim=cacher(function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y){var a=(c2x-2*c1x+p1x)-(p2x-2*c2x+c1x),b=2*(c1x-p1x)-2*(c2x-c1x),c=p1x-c1x,t1=(-b+math.sqrt(b*b-4*a*c))/2/a,t2=(-b-math.sqrt(b*b-4*a*c))/2/a,y=[p1y,p2y],x=[p1x,p2x],dot;abs(t1)>"1e12"&&(t1=.5);abs(t2)>"1e12"&&(t2=.5);if(t1>0&&t1<1){dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t1);x.push(dot.x);y.push(dot.y);}
if(t2>0&&t2<1){dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t2);x.push(dot.x);y.push(dot.y);}
a=(c2y-2*c1y+p1y)-(p2y-2*c2y+c1y);b=2*(c1y-p1y)-2*(c2y-c1y);c=p1y-c1y;t1=(-b+math.sqrt(b*b-4*a*c))/2/a;t2=(-b-math.sqrt(b*b-4*a*c))/2/a;abs(t1)>"1e12"&&(t1=.5);abs(t2)>"1e12"&&(t2=.5);if(t1>0&&t1<1){dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t1);x.push(dot.x);y.push(dot.y);}
if(t2>0&&t2<1){dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t2);x.push(dot.x);y.push(dot.y);}
return{min:{x:mmin[apply](0,x),y:mmin[apply](0,y)},max:{x:mmax[apply](0,x),y:mmax[apply](0,y)}};}),path2curve=R._path2curve=cacher(function(path,path2){var pth=!path2&&paths(path);if(!path2&&pth.curve){return pathClone(pth.curve);}
var p=pathToAbsolute(path),p2=path2&&pathToAbsolute(path2),attrs={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},attrs2={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},processPath=function(path,d,pcom){var nx,ny,tq={T:1,Q:1};if(!path){return["C",d.x,d.y,d.x,d.y,d.x,d.y];}!(path[0]in tq)&&(d.qx=d.qy=null);switch(path[0]){case"M":d.X=path[1];d.Y=path[2];break;case"A":path=["C"][concat](a2c[apply](0,[d.x,d.y][concat](path.slice(1))));break;case"S":if(pcom=="C"||pcom=="S"){nx=d.x*2-d.bx;ny=d.y*2-d.by;}
else{nx=d.x;ny=d.y;}
path=["C",nx,ny][concat](path.slice(1));break;case"T":if(pcom=="Q"||pcom=="T"){d.qx=d.x*2-d.qx;d.qy=d.y*2-d.qy;}
else{d.qx=d.x;d.qy=d.y;}
path=["C"][concat](q2c(d.x,d.y,d.qx,d.qy,path[1],path[2]));break;case"Q":d.qx=path[1];d.qy=path[2];path=["C"][concat](q2c(d.x,d.y,path[1],path[2],path[3],path[4]));break;case"L":path=["C"][concat](l2c(d.x,d.y,path[1],path[2]));break;case"H":path=["C"][concat](l2c(d.x,d.y,path[1],d.y));break;case"V":path=["C"][concat](l2c(d.x,d.y,d.x,path[1]));break;case"Z":path=["C"][concat](l2c(d.x,d.y,d.X,d.Y));break;}
return path;},fixArc=function(pp,i){if(pp[i].length>7){pp[i].shift();var pi=pp[i];while(pi.length){pp.splice(i++,0,["C"][concat](pi.splice(0,6)));}
pp.splice(i,1);ii=mmax(p.length,p2&&p2.length||0);}},fixM=function(path1,path2,a1,a2,i){if(path1&&path2&&path1[i][0]=="M"&&path2[i][0]!="M"){path2.splice(i,0,["M",a2.x,a2.y]);a1.bx=0;a1.by=0;a1.x=path1[i][1];a1.y=path1[i][2];ii=mmax(p.length,p2&&p2.length||0);}};for(var i=0,ii=mmax(p.length,p2&&p2.length||0);i<ii;i++){p[i]=processPath(p[i],attrs);fixArc(p,i);p2&&(p2[i]=processPath(p2[i],attrs2));p2&&fixArc(p2,i);fixM(p,p2,attrs,attrs2,i);fixM(p2,p,attrs2,attrs,i);var seg=p[i],seg2=p2&&p2[i],seglen=seg.length,seg2len=p2&&seg2.length;attrs.x=seg[seglen-2];attrs.y=seg[seglen-1];attrs.bx=toFloat(seg[seglen-4])||attrs.x;attrs.by=toFloat(seg[seglen-3])||attrs.y;attrs2.bx=p2&&(toFloat(seg2[seg2len-4])||attrs2.x);attrs2.by=p2&&(toFloat(seg2[seg2len-3])||attrs2.y);attrs2.x=p2&&seg2[seg2len-2];attrs2.y=p2&&seg2[seg2len-1];}
if(!p2){pth.curve=pathClone(p);}
return p2?[p,p2]:p;},null,pathClone),parseDots=R._parseDots=cacher(function(gradient){var dots=[];for(var i=0,ii=gradient.length;i<ii;i++){var dot={},par=gradient[i].match(/^([^:]*):?([\d\.]*)/);dot.color=R.getRGB(par[1]);if(dot.color.error){return null;}
dot.color=dot.color.hex;par[2]&&(dot.offset=par[2]+"%");dots.push(dot);}
for(i=1,ii=dots.length-1;i<ii;i++){if(!dots[i].offset){var start=toFloat(dots[i-1].offset||0),end=0;for(var j=i+1;j<ii;j++){if(dots[j].offset){end=dots[j].offset;break;}}
if(!end){end=100;j=ii;}
end=toFloat(end);var d=(end-start)/(j-i+1);for(;i<j;i++){start+=d;dots[i].offset=start+"%";}}}
return dots;}),tear=R._tear=function(el,paper){el==paper.top&&(paper.top=el.prev);el==paper.bottom&&(paper.bottom=el.next);el.next&&(el.next.prev=el.prev);el.prev&&(el.prev.next=el.next);},tofront=R._tofront=function(el,paper){if(paper.top===el){return;}
tear(el,paper);el.next=null;el.prev=paper.top;paper.top.next=el;paper.top=el;},toback=R._toback=function(el,paper){if(paper.bottom===el){return;}
tear(el,paper);el.next=paper.bottom;el.prev=null;paper.bottom.prev=el;paper.bottom=el;},insertafter=R._insertafter=function(el,el2,paper){tear(el,paper);el2==paper.top&&(paper.top=el);el2.next&&(el2.next.prev=el);el.next=el2.next;el.prev=el2;el2.next=el;},insertbefore=R._insertbefore=function(el,el2,paper){tear(el,paper);el2==paper.bottom&&(paper.bottom=el);el2.prev&&(el2.prev.next=el);el.prev=el2.prev;el2.prev=el;el.next=el2;},toMatrix=R.toMatrix=function(path,transform){var bb=pathDimensions(path),el={_:{transform:E},getBBox:function(){return bb;}};extractTransform(el,transform);return el.matrix;},transformPath=R.transformPath=function(path,transform){return mapPath(path,toMatrix(path,transform));},extractTransform=R._extractTransform=function(el,tstr){if(tstr==null){return el._.transform;}
tstr=Str(tstr).replace(/\.{3}|\u2026/g,el._.transform||E);var tdata=R.parseTransformString(tstr),deg=0,dx=0,dy=0,sx=1,sy=1,_=el._,m=new Matrix;_.transform=tdata||[];if(tdata){for(var i=0,ii=tdata.length;i<ii;i++){var t=tdata[i],tlen=t.length,command=Str(t[0]).toLowerCase(),absolute=t[0]!=command,inver=absolute?m.invert():0,x1,y1,x2,y2,bb;if(command=="t"&&tlen==3){if(absolute){x1=inver.x(0,0);y1=inver.y(0,0);x2=inver.x(t[1],t[2]);y2=inver.y(t[1],t[2]);m.translate(x2-x1,y2-y1);}else{m.translate(t[1],t[2]);}}else if(command=="r"){if(tlen==2){bb=bb||el.getBBox(1);m.rotate(t[1],bb.x+bb.width/2,bb.y+bb.height/2);deg+=t[1];}else if(tlen==4){if(absolute){x2=inver.x(t[2],t[3]);y2=inver.y(t[2],t[3]);m.rotate(t[1],x2,y2);}else{m.rotate(t[1],t[2],t[3]);}
deg+=t[1];}}else if(command=="s"){if(tlen==2||tlen==3){bb=bb||el.getBBox(1);m.scale(t[1],t[tlen-1],bb.x+bb.width/2,bb.y+bb.height/2);sx*=t[1];sy*=t[tlen-1];}else if(tlen==5){if(absolute){x2=inver.x(t[3],t[4]);y2=inver.y(t[3],t[4]);m.scale(t[1],t[2],x2,y2);}else{m.scale(t[1],t[2],t[3],t[4]);}
sx*=t[1];sy*=t[2];}}else if(command=="m"&&tlen==7){m.add(t[1],t[2],t[3],t[4],t[5],t[6]);}
_.dirtyT=1;el.matrix=m;}}
el.matrix=m;_.sx=sx;_.sy=sy;_.deg=deg;_.dx=dx=m.e;_.dy=dy=m.f;if(sx==1&&sy==1&&!deg&&_.bbox){_.bbox.x+=+dx;_.bbox.y+=+dy;}else{_.dirtyT=1;}},getEmpty=function(item){var l=item[0];switch(l.toLowerCase()){case"t":return[l,0,0];case"m":return[l,1,0,0,1,0,0];case"r":if(item.length==4){return[l,0,item[2],item[3]];}else{return[l,0];}
case"s":if(item.length==5){return[l,1,1,item[3],item[4]];}else if(item.length==3){return[l,1,1];}else{return[l,1];}}},equaliseTransform=R._equaliseTransform=function(t1,t2){t2=Str(t2).replace(/\.{3}|\u2026/g,t1);t1=R.parseTransformString(t1)||[];t2=R.parseTransformString(t2)||[];var maxlength=mmax(t1.length,t2.length),from=[],to=[],i=0,j,jj,tt1,tt2;for(;i<maxlength;i++){tt1=t1[i]||getEmpty(t2[i]);tt2=t2[i]||getEmpty(tt1);if((tt1[0]!=tt2[0])||(tt1[0].toLowerCase()=="r"&&(tt1[2]!=tt2[2]||tt1[3]!=tt2[3]))||(tt1[0].toLowerCase()=="s"&&(tt1[3]!=tt2[3]||tt1[4]!=tt2[4]))){return;}
from[i]=[];to[i]=[];for(j=0,jj=mmax(tt1.length,tt2.length);j<jj;j++){j in tt1&&(from[i][j]=tt1[j]);j in tt2&&(to[i][j]=tt2[j]);}}
return{from:from,to:to};};R._getContainer=function(x,y,w,h){var container;container=h==null&&!R.is(x,"object")?g.doc.getElementById(x):x;if(container==null){return;}
if(container.tagName){if(y==null){return{container:container,width:container.style.pixelWidth||container.offsetWidth,height:container.style.pixelHeight||container.offsetHeight};}else{return{container:container,width:y,height:w};}}
return{container:1,x:x,y:y,width:w,height:h};};R.pathToRelative=pathToRelative;R._engine={};R.path2curve=path2curve;R.matrix=function(a,b,c,d,e,f){return new Matrix(a,b,c,d,e,f);};function Matrix(a,b,c,d,e,f){if(a!=null){this.a=+a;this.b=+b;this.c=+c;this.d=+d;this.e=+e;this.f=+f;}else{this.a=1;this.b=0;this.c=0;this.d=1;this.e=0;this.f=0;}}
(function(matrixproto){matrixproto.add=function(a,b,c,d,e,f){var out=[[],[],[]],m=[[this.a,this.c,this.e],[this.b,this.d,this.f],[0,0,1]],matrix=[[a,c,e],[b,d,f],[0,0,1]],x,y,z,res;if(a&&a instanceof Matrix){matrix=[[a.a,a.c,a.e],[a.b,a.d,a.f],[0,0,1]];}
for(x=0;x<3;x++){for(y=0;y<3;y++){res=0;for(z=0;z<3;z++){res+=m[x][z]*matrix[z][y];}
out[x][y]=res;}}
this.a=out[0][0];this.b=out[1][0];this.c=out[0][1];this.d=out[1][1];this.e=out[0][2];this.f=out[1][2];};matrixproto.invert=function(){var me=this,x=me.a*me.d-me.b*me.c;return new Matrix(me.d/x,-me.b/x,-me.c/x,me.a/x,(me.c*me.f-me.d*me.e)/x,(me.b*me.e-me.a*me.f)/x);};matrixproto.clone=function(){return new Matrix(this.a,this.b,this.c,this.d,this.e,this.f);};matrixproto.translate=function(x,y){this.add(1,0,0,1,x,y);};matrixproto.scale=function(x,y,cx,cy){y==null&&(y=x);(cx||cy)&&this.add(1,0,0,1,cx,cy);this.add(x,0,0,y,0,0);(cx||cy)&&this.add(1,0,0,1,-cx,-cy);};matrixproto.rotate=function(a,x,y){a=R.rad(a);x=x||0;y=y||0;var cos=+math.cos(a).toFixed(9),sin=+math.sin(a).toFixed(9);this.add(cos,sin,-sin,cos,x,y);this.add(1,0,0,1,-x,-y);};matrixproto.x=function(x,y){return x*this.a+y*this.c+this.e;};matrixproto.y=function(x,y){return x*this.b+y*this.d+this.f;};matrixproto.get=function(i){return+this[Str.fromCharCode(97+i)].toFixed(4);};matrixproto.toString=function(){return R.svg?"matrix("+[this.get(0),this.get(1),this.get(2),this.get(3),this.get(4),this.get(5)].join()+")":[this.get(0),this.get(2),this.get(1),this.get(3),0,0].join();};matrixproto.toFilter=function(){return"progid:DXImageTransform.Microsoft.Matrix(M11="+this.get(0)+", M12="+this.get(2)+", M21="+this.get(1)+", M22="+this.get(3)+", Dx="+this.get(4)+", Dy="+this.get(5)+", sizingmethod='auto expand')";};matrixproto.offset=function(){return[this.e.toFixed(4),this.f.toFixed(4)];};function norm(a){return a[0]*a[0]+a[1]*a[1];}
function normalize(a){var mag=math.sqrt(norm(a));a[0]&&(a[0]/=mag);a[1]&&(a[1]/=mag);}
matrixproto.split=function(){var out={};out.dx=this.e;out.dy=this.f;var row=[[this.a,this.c],[this.b,this.d]];out.scalex=math.sqrt(norm(row[0]));normalize(row[0]);out.shear=row[0][0]*row[1][0]+row[0][1]*row[1][1];row[1]=[row[1][0]-row[0][0]*out.shear,row[1][1]-row[0][1]*out.shear];out.scaley=math.sqrt(norm(row[1]));normalize(row[1]);out.shear/=out.scaley;var sin=-row[0][1],cos=row[1][1];if(cos<0){out.rotate=R.deg(math.acos(cos));if(sin<0){out.rotate=360-out.rotate;}}else{out.rotate=R.deg(math.asin(sin));}
out.isSimple=!+out.shear.toFixed(9)&&(out.scalex.toFixed(9)==out.scaley.toFixed(9)||!out.rotate);out.isSuperSimple=!+out.shear.toFixed(9)&&out.scalex.toFixed(9)==out.scaley.toFixed(9)&&!out.rotate;out.noRotation=!+out.shear.toFixed(9)&&!out.rotate;return out;};matrixproto.toTransformString=function(shorter){var s=shorter||this[split]();if(s.isSimple){s.scalex=+s.scalex.toFixed(4);s.scaley=+s.scaley.toFixed(4);s.rotate=+s.rotate.toFixed(4);return(s.dx||s.dy?"t"+[s.dx,s.dy]:E)+
(s.scalex!=1||s.scaley!=1?"s"+[s.scalex,s.scaley,0,0]:E)+
(s.rotate?"r"+[s.rotate,0,0]:E);}else{return"m"+[this.get(0),this.get(1),this.get(2),this.get(3),this.get(4),this.get(5)];}};})(Matrix.prototype);var version=navigator.userAgent.match(/Version\/(.*?)\s/)||navigator.userAgent.match(/Chrome\/(\d+)/);if((navigator.vendor=="Apple Computer, Inc.")&&(version&&version[1]<4||navigator.platform.slice(0,2)=="iP")||(navigator.vendor=="Google Inc."&&version&&version[1]<8)){paperproto.safari=function(){var rect=this.rect(-99,-99,this.width+99,this.height+99).attr({stroke:"none"});setTimeout(function(){rect.remove();});};}else{paperproto.safari=fun;}
var preventDefault=function(){this.returnValue=false;},preventTouch=function(){return this.originalEvent.preventDefault();},stopPropagation=function(){this.cancelBubble=true;},stopTouch=function(){return this.originalEvent.stopPropagation();},getEventPosition=function(e){var scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft;return{x:e.clientX+scrollX,y:e.clientY+scrollY};},addEvent=(function(){if(g.doc.addEventListener){return function(obj,type,fn,element){var f=function(e){var pos=getEventPosition(e);return fn.call(element,e,pos.x,pos.y);};obj.addEventListener(type,f,false);if(supportsTouch&&touchMap[type]){var _f=function(e){var pos=getEventPosition(e),olde=e;for(var i=0,ii=e.targetTouches&&e.targetTouches.length;i<ii;i++){if(e.targetTouches[i].target==obj){e=e.targetTouches[i];e.originalEvent=olde;e.preventDefault=preventTouch;e.stopPropagation=stopTouch;break;}}
return fn.call(element,e,pos.x,pos.y);};obj.addEventListener(touchMap[type],_f,false);}
return function(){obj.removeEventListener(type,f,false);if(supportsTouch&&touchMap[type])
obj.removeEventListener(touchMap[type],f,false);return true;};};}else if(g.doc.attachEvent){return function(obj,type,fn,element){var f=function(e){e=e||g.win.event;var scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft,x=e.clientX+scrollX,y=e.clientY+scrollY;e.preventDefault=e.preventDefault||preventDefault;e.stopPropagation=e.stopPropagation||stopPropagation;return fn.call(element,e,x,y);};obj.attachEvent("on"+type,f);var detacher=function(){obj.detachEvent("on"+type,f);return true;};return detacher;};}})(),drag=[],dragMove=function(e){var x=e.clientX,y=e.clientY,scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft,dragi,j=drag.length;while(j--){dragi=drag[j];if(supportsTouch&&e.touches){var i=e.touches.length,touch;while(i--){touch=e.touches[i];if(touch.identifier==dragi.el._drag.id){x=touch.clientX;y=touch.clientY;(e.originalEvent?e.originalEvent:e).preventDefault();break;}}}else{e.preventDefault();}
var node=dragi.el.node,o,next=node.nextSibling,parent=node.parentNode,display=node.style.display;g.win.opera&&parent.removeChild(node);node.style.display="none";o=dragi.el.paper.getElementByPoint(x,y);node.style.display=display;g.win.opera&&(next?parent.insertBefore(node,next):parent.appendChild(node));o&&eve("raphael.drag.over."+dragi.el.id,dragi.el,o);x+=scrollX;y+=scrollY;eve("raphael.drag.move."+dragi.el.id,dragi.move_scope||dragi.el,x-dragi.el._drag.x,y-dragi.el._drag.y,x,y,e);}},dragUp=function(e){R.unmousemove(dragMove).unmouseup(dragUp);var i=drag.length,dragi;while(i--){dragi=drag[i];dragi.el._drag={};eve("raphael.drag.end."+dragi.el.id,dragi.end_scope||dragi.start_scope||dragi.move_scope||dragi.el,e);}
drag=[];},elproto=R.el={};for(var i=events.length;i--;){(function(eventName){R[eventName]=elproto[eventName]=function(fn,scope){if(R.is(fn,"function")){this.events=this.events||[];this.events.push({name:eventName,f:fn,unbind:addEvent(this.shape||this.node||g.doc,eventName,fn,scope||this)});}
return this;};R["un"+eventName]=elproto["un"+eventName]=function(fn){var events=this.events||[],l=events.length;while(l--){if(events[l].name==eventName&&(R.is(fn,"undefined")||events[l].f==fn)){events[l].unbind();events.splice(l,1);!events.length&&delete this.events;}}
return this;};})(events[i]);}
elproto.data=function(key,value){var data=eldata[this.id]=eldata[this.id]||{};if(arguments.length==0){return data;}
if(arguments.length==1){if(R.is(key,"object")){for(var i in key)if(key[has](i)){this.data(i,key[i]);}
return this;}
eve("raphael.data.get."+this.id,this,data[key],key);return data[key];}
data[key]=value;eve("raphael.data.set."+this.id,this,value,key);return this;};elproto.removeData=function(key){if(key==null){eldata[this.id]={};}else{eldata[this.id]&&delete eldata[this.id][key];}
return this;};elproto.getData=function(){return clone(eldata[this.id]||{});};elproto.hover=function(f_in,f_out,scope_in,scope_out){return this.mouseover(f_in,scope_in).mouseout(f_out,scope_out||scope_in);};elproto.unhover=function(f_in,f_out){return this.unmouseover(f_in).unmouseout(f_out);};var draggable=[];elproto.drag=function(onmove,onstart,onend,move_scope,start_scope,end_scope){function start(e){(e.originalEvent||e).preventDefault();var x=e.clientX,y=e.clientY,scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft;this._drag.id=e.identifier;if(supportsTouch&&e.touches){var i=e.touches.length,touch;while(i--){touch=e.touches[i];this._drag.id=touch.identifier;if(touch.identifier==this._drag.id){x=touch.clientX;y=touch.clientY;break;}}}
this._drag.x=x+scrollX;this._drag.y=y+scrollY;!drag.length&&R.mousemove(dragMove).mouseup(dragUp);drag.push({el:this,move_scope:move_scope,start_scope:start_scope,end_scope:end_scope});onstart&&eve.on("raphael.drag.start."+this.id,onstart);onmove&&eve.on("raphael.drag.move."+this.id,onmove);onend&&eve.on("raphael.drag.end."+this.id,onend);eve("raphael.drag.start."+this.id,start_scope||move_scope||this,e.clientX+scrollX,e.clientY+scrollY,e);}
this._drag={};draggable.push({el:this,start:start});this.mousedown(start);return this;};elproto.onDragOver=function(f){f?eve.on("raphael.drag.over."+this.id,f):eve.unbind("raphael.drag.over."+this.id);};elproto.undrag=function(){var i=draggable.length;while(i--)if(draggable[i].el==this){this.unmousedown(draggable[i].start);draggable.splice(i,1);eve.unbind("raphael.drag.*."+this.id);}!draggable.length&&R.unmousemove(dragMove).unmouseup(dragUp);drag=[];};paperproto.circle=function(x,y,r){var out=R._engine.circle(this,x||0,y||0,r||0);this.__set__&&this.__set__.push(out);return out;};paperproto.rect=function(x,y,w,h,r){var out=R._engine.rect(this,x||0,y||0,w||0,h||0,r||0);this.__set__&&this.__set__.push(out);return out;};paperproto.ellipse=function(x,y,rx,ry){var out=R._engine.ellipse(this,x||0,y||0,rx||0,ry||0);this.__set__&&this.__set__.push(out);return out;};paperproto.path=function(pathString){pathString&&!R.is(pathString,string)&&!R.is(pathString[0],array)&&(pathString+=E);var out=R._engine.path(R.format[apply](R,arguments),this);this.__set__&&this.__set__.push(out);return out;};paperproto.image=function(src,x,y,w,h){var out=R._engine.image(this,src||"about:blank",x||0,y||0,w||0,h||0);this.__set__&&this.__set__.push(out);return out;};paperproto.text=function(x,y,text){var out=R._engine.text(this,x||0,y||0,Str(text));this.__set__&&this.__set__.push(out);return out;};paperproto.set=function(itemsArray){!R.is(itemsArray,"array")&&(itemsArray=Array.prototype.splice.call(arguments,0,arguments.length));var out=new Set(itemsArray);this.__set__&&this.__set__.push(out);out["paper"]=this;out["type"]="set";return out;};paperproto.setStart=function(set){this.__set__=set||this.set();};paperproto.setFinish=function(set){var out=this.__set__;delete this.__set__;return out;};paperproto.setSize=function(width,height){return R._engine.setSize.call(this,width,height);};paperproto.setViewBox=function(x,y,w,h,fit){return R._engine.setViewBox.call(this,x,y,w,h,fit);};paperproto.top=paperproto.bottom=null;paperproto.raphael=R;var getOffset=function(elem){var box=elem.getBoundingClientRect(),doc=elem.ownerDocument,body=doc.body,docElem=doc.documentElement,clientTop=docElem.clientTop||body.clientTop||0,clientLeft=docElem.clientLeft||body.clientLeft||0,top=box.top+(g.win.pageYOffset||docElem.scrollTop||body.scrollTop)-clientTop,left=box.left+(g.win.pageXOffset||docElem.scrollLeft||body.scrollLeft)-clientLeft;return{y:top,x:left};};paperproto.getElementByPoint=function(x,y){var paper=this,svg=paper.canvas,target=g.doc.elementFromPoint(x,y);if(g.win.opera&&target.tagName=="svg"){var so=getOffset(svg),sr=svg.createSVGRect();sr.x=x-so.x;sr.y=y-so.y;sr.width=sr.height=1;var hits=svg.getIntersectionList(sr,null);if(hits.length){target=hits[hits.length-1];}}
if(!target){return null;}
while(target.parentNode&&target!=svg.parentNode&&!target.raphael){target=target.parentNode;}
target==paper.canvas.parentNode&&(target=svg);target=target&&target.raphael?paper.getById(target.raphaelid):null;return target;};paperproto.getElementsByBBox=function(bbox){var set=this.set();this.forEach(function(el){if(R.isBBoxIntersect(el.getBBox(),bbox)){set.push(el);}});return set;};paperproto.getById=function(id){var bot=this.bottom;while(bot){if(bot.id==id){return bot;}
bot=bot.next;}
return null;};paperproto.forEach=function(callback,thisArg){var bot=this.bottom;while(bot){if(callback.call(thisArg,bot)===false){return this;}
bot=bot.next;}
return this;};paperproto.getElementsByPoint=function(x,y){var set=this.set();this.forEach(function(el){if(el.isPointInside(x,y)){set.push(el);}});return set;};function x_y(){return this.x+S+this.y;}
function x_y_w_h(){return this.x+S+this.y+S+this.width+" \xd7 "+this.height;}
elproto.isPointInside=function(x,y){var rp=this.realPath=getPath[this.type](this);if(this.attr('transform')&&this.attr('transform').length){rp=R.transformPath(rp,this.attr('transform'));}
return R.isPointInsidePath(rp,x,y);};elproto.getBBox=function(isWithoutTransform){if(this.removed){return{};}
var _=this._;if(isWithoutTransform){if(_.dirty||!_.bboxwt){this.realPath=getPath[this.type](this);_.bboxwt=pathDimensions(this.realPath);_.bboxwt.toString=x_y_w_h;_.dirty=0;}
return _.bboxwt;}
if(_.dirty||_.dirtyT||!_.bbox){if(_.dirty||!this.realPath){_.bboxwt=0;this.realPath=getPath[this.type](this);}
_.bbox=pathDimensions(mapPath(this.realPath,this.matrix));_.bbox.toString=x_y_w_h;_.dirty=_.dirtyT=0;}
return _.bbox;};elproto.clone=function(){if(this.removed){return null;}
var out=this.paper[this.type]().attr(this.attr());this.__set__&&this.__set__.push(out);return out;};elproto.glow=function(glow){if(this.type=="text"){return null;}
glow=glow||{};var s={width:(glow.width||10)+(+this.attr("stroke-width")||1),fill:glow.fill||false,opacity:glow.opacity||.5,offsetx:glow.offsetx||0,offsety:glow.offsety||0,color:glow.color||"#000"},c=s.width/2,r=this.paper,out=r.set(),path=this.realPath||getPath[this.type](this);path=this.matrix?mapPath(path,this.matrix):path;for(var i=1;i<c+1;i++){out.push(r.path(path).attr({stroke:s.color,fill:s.fill?s.color:"none","stroke-linejoin":"round","stroke-linecap":"round","stroke-width":+(s.width/c*i).toFixed(3),opacity:+(s.opacity/c).toFixed(3)}));}
return out.insertBefore(this).translate(s.offsetx,s.offsety);};var curveslengths={},getPointAtSegmentLength=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,length){if(length==null){return bezlen(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y);}else{return R.findDotsAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,getTatLen(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,length));}},getLengthFactory=function(istotal,subpath){return function(path,length,onlystart){path=path2curve(path);var x,y,p,l,sp="",subpaths={},point,len=0;for(var i=0,ii=path.length;i<ii;i++){p=path[i];if(p[0]=="M"){x=+p[1];y=+p[2];}else{l=getPointAtSegmentLength(x,y,p[1],p[2],p[3],p[4],p[5],p[6]);if(len+l>length){if(subpath&&!subpaths.start){point=getPointAtSegmentLength(x,y,p[1],p[2],p[3],p[4],p[5],p[6],length-len);sp+=["C"+point.start.x,point.start.y,point.m.x,point.m.y,point.x,point.y];if(onlystart){return sp;}
subpaths.start=sp;sp=["M"+point.x,point.y+"C"+point.n.x,point.n.y,point.end.x,point.end.y,p[5],p[6]].join();len+=l;x=+p[5];y=+p[6];continue;}
if(!istotal&&!subpath){point=getPointAtSegmentLength(x,y,p[1],p[2],p[3],p[4],p[5],p[6],length-len);return{x:point.x,y:point.y,alpha:point.alpha};}}
len+=l;x=+p[5];y=+p[6];}
sp+=p.shift()+p;}
subpaths.end=sp;point=istotal?len:subpath?subpaths:R.findDotsAtSegment(x,y,p[0],p[1],p[2],p[3],p[4],p[5],1);point.alpha&&(point={x:point.x,y:point.y,alpha:point.alpha});return point;};};var getTotalLength=getLengthFactory(1),getPointAtLength=getLengthFactory(),getSubpathsAtLength=getLengthFactory(0,1);R.getTotalLength=getTotalLength;R.getPointAtLength=getPointAtLength;R.getSubpath=function(path,from,to){if(this.getTotalLength(path)-to<1e-6){return getSubpathsAtLength(path,from).end;}
var a=getSubpathsAtLength(path,to,1);return from?getSubpathsAtLength(a,from).end:a;};elproto.getTotalLength=function(){var path=this.getPath();if(!path){return;}
if(this.node.getTotalLength){return this.node.getTotalLength();}
return getTotalLength(path);};elproto.getPointAtLength=function(length){var path=this.getPath();if(!path){return;}
return getPointAtLength(path,length);};elproto.getPath=function(){var path,getPath=R._getPath[this.type];if(this.type=="text"||this.type=="set"){return;}
if(getPath){path=getPath(this);}
return path;};elproto.getSubpath=function(from,to){var path=this.getPath();if(!path){return;}
return R.getSubpath(path,from,to);};var ef=R.easing_formulas={linear:function(n){return n;},"<":function(n){return pow(n,1.7);},">":function(n){return pow(n,.48);},"<>":function(n){var q=.48-n/1.04,Q=math.sqrt(.1734+q*q),x=Q-q,X=pow(abs(x),1/3)*(x<0?-1:1),y=-Q-q,Y=pow(abs(y),1/3)*(y<0?-1:1),t=X+Y+.5;return(1-t)*3*t*t+t*t*t;},backIn:function(n){var s=1.70158;return n*n*((s+1)*n-s);},backOut:function(n){n=n-1;var s=1.70158;return n*n*((s+1)*n+s)+1;},elastic:function(n){if(n==!!n){return n;}
return pow(2,-10*n)*math.sin((n-.075)*(2*PI)/.3)+1;},bounce:function(n){var s=7.5625,p=2.75,l;if(n<(1/p)){l=s*n*n;}else{if(n<(2/p)){n-=(1.5/p);l=s*n*n+.75;}else{if(n<(2.5/p)){n-=(2.25/p);l=s*n*n+.9375;}else{n-=(2.625/p);l=s*n*n+.984375;}}}
return l;}};ef.easeIn=ef["ease-in"]=ef["<"];ef.easeOut=ef["ease-out"]=ef[">"];ef.easeInOut=ef["ease-in-out"]=ef["<>"];ef["back-in"]=ef.backIn;ef["back-out"]=ef.backOut;var animationElements=[],requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){setTimeout(callback,16);},animation=function(){var Now=+new Date,l=0;for(;l<animationElements.length;l++){var e=animationElements[l];if(e.el.removed||e.paused){continue;}
var time=Now-e.start,ms=e.ms,easing=e.easing,from=e.from,diff=e.diff,to=e.to,t=e.t,that=e.el,set={},now,init={},key;if(e.initstatus){time=(e.initstatus*e.anim.top-e.prev)/(e.percent-e.prev)*ms;e.status=e.initstatus;delete e.initstatus;e.stop&&animationElements.splice(l--,1);}else{e.status=(e.prev+(e.percent-e.prev)*(time/ms))/e.anim.top;}
if(time<0){continue;}
if(time<ms){var pos=easing(time/ms);for(var attr in from)if(from[has](attr)){switch(availableAnimAttrs[attr]){case nu:now=+from[attr]+pos*ms*diff[attr];break;case"colour":now="rgb("+[upto255(round(from[attr].r+pos*ms*diff[attr].r)),upto255(round(from[attr].g+pos*ms*diff[attr].g)),upto255(round(from[attr].b+pos*ms*diff[attr].b))].join(",")+")";break;case"path":now=[];for(var i=0,ii=from[attr].length;i<ii;i++){now[i]=[from[attr][i][0]];for(var j=1,jj=from[attr][i].length;j<jj;j++){now[i][j]=+from[attr][i][j]+pos*ms*diff[attr][i][j];}
now[i]=now[i].join(S);}
now=now.join(S);break;case"transform":if(diff[attr].real){now=[];for(i=0,ii=from[attr].length;i<ii;i++){now[i]=[from[attr][i][0]];for(j=1,jj=from[attr][i].length;j<jj;j++){now[i][j]=from[attr][i][j]+pos*ms*diff[attr][i][j];}}}else{var get=function(i){return+from[attr][i]+pos*ms*diff[attr][i];};now=[["m",get(0),get(1),get(2),get(3),get(4),get(5)]];}
break;case"csv":if(attr=="clip-rect"){now=[];i=4;while(i--){now[i]=+from[attr][i]+pos*ms*diff[attr][i];}}
break;default:var from2=[][concat](from[attr]);now=[];i=that.paper.customAttributes[attr].length;while(i--){now[i]=+from2[i]+pos*ms*diff[attr][i];}
break;}
set[attr]=now;}
that.attr(set);(function(id,that,anim){setTimeout(function(){eve("raphael.anim.frame."+id,that,anim);});})(that.id,that,e.anim);}else{(function(f,el,a){setTimeout(function(){eve("raphael.anim.frame."+el.id,el,a);eve("raphael.anim.finish."+el.id,el,a);R.is(f,"function")&&f.call(el);});})(e.callback,that,e.anim);that.attr(to);animationElements.splice(l--,1);if(e.repeat>1&&!e.next){for(key in to)if(to[has](key)){init[key]=e.totalOrigin[key];}
e.el.attr(init);runAnimation(e.anim,e.el,e.anim.percents[0],null,e.totalOrigin,e.repeat-1);}
if(e.next&&!e.stop){runAnimation(e.anim,e.el,e.next,null,e.totalOrigin,e.repeat);}}}
R.svg&&that&&that.paper&&that.paper.safari();animationElements.length&&requestAnimFrame(animation);},upto255=function(color){return color>255?255:color<0?0:color;};elproto.animateWith=function(el,anim,params,ms,easing,callback){var element=this;if(element.removed){callback&&callback.call(element);return element;}
var a=params instanceof Animation?params:R.animation(params,ms,easing,callback),x,y;runAnimation(a,element,a.percents[0],null,element.attr());for(var i=0,ii=animationElements.length;i<ii;i++){if(animationElements[i].anim==anim&&animationElements[i].el==el){animationElements[ii-1].start=animationElements[i].start;break;}}
return element;};function CubicBezierAtTime(t,p1x,p1y,p2x,p2y,duration){var cx=3*p1x,bx=3*(p2x-p1x)-cx,ax=1-cx-bx,cy=3*p1y,by=3*(p2y-p1y)-cy,ay=1-cy-by;function sampleCurveX(t){return((ax*t+bx)*t+cx)*t;}
function solve(x,epsilon){var t=solveCurveX(x,epsilon);return((ay*t+by)*t+cy)*t;}
function solveCurveX(x,epsilon){var t0,t1,t2,x2,d2,i;for(t2=x,i=0;i<8;i++){x2=sampleCurveX(t2)-x;if(abs(x2)<epsilon){return t2;}
d2=(3*ax*t2+2*bx)*t2+cx;if(abs(d2)<1e-6){break;}
t2=t2-x2/d2;}
t0=0;t1=1;t2=x;if(t2<t0){return t0;}
if(t2>t1){return t1;}
while(t0<t1){x2=sampleCurveX(t2);if(abs(x2-x)<epsilon){return t2;}
if(x>x2){t0=t2;}else{t1=t2;}
t2=(t1-t0)/2+t0;}
return t2;}
return solve(t,1/(200*duration));}
elproto.onAnimation=function(f){f?eve.on("raphael.anim.frame."+this.id,f):eve.unbind("raphael.anim.frame."+this.id);return this;};function Animation(anim,ms){var percents=[],newAnim={};this.ms=ms;this.times=1;if(anim){for(var attr in anim)if(anim[has](attr)){newAnim[toFloat(attr)]=anim[attr];percents.push(toFloat(attr));}
percents.sort(sortByNumber);}
this.anim=newAnim;this.top=percents[percents.length-1];this.percents=percents;}
Animation.prototype.delay=function(delay){var a=new Animation(this.anim,this.ms);a.times=this.times;a.del=+delay||0;return a;};Animation.prototype.repeat=function(times){var a=new Animation(this.anim,this.ms);a.del=this.del;a.times=math.floor(mmax(times,0))||1;return a;};function runAnimation(anim,element,percent,status,totalOrigin,times){percent=toFloat(percent);var params,isInAnim,isInAnimSet,percents=[],next,prev,timestamp,ms=anim.ms,from={},to={},diff={};if(status){for(i=0,ii=animationElements.length;i<ii;i++){var e=animationElements[i];if(e.el.id==element.id&&e.anim==anim){if(e.percent!=percent){animationElements.splice(i,1);isInAnimSet=1;}else{isInAnim=e;}
element.attr(e.totalOrigin);break;}}}else{status=+to;}
for(var i=0,ii=anim.percents.length;i<ii;i++){if(anim.percents[i]==percent||anim.percents[i]>status*anim.top){percent=anim.percents[i];prev=anim.percents[i-1]||0;ms=ms/anim.top*(percent-prev);next=anim.percents[i+1];params=anim.anim[percent];break;}else if(status){element.attr(anim.anim[anim.percents[i]]);}}
if(!params){return;}
if(!isInAnim){for(var attr in params)if(params[has](attr)){if(availableAnimAttrs[has](attr)||element.paper.customAttributes[has](attr)){from[attr]=element.attr(attr);(from[attr]==null)&&(from[attr]=availableAttrs[attr]);to[attr]=params[attr];switch(availableAnimAttrs[attr]){case nu:diff[attr]=(to[attr]-from[attr])/ms;break;case"colour":from[attr]=R.getRGB(from[attr]);var toColour=R.getRGB(to[attr]);diff[attr]={r:(toColour.r-from[attr].r)/ms,g:(toColour.g-from[attr].g)/ms,b:(toColour.b-from[attr].b)/ms};break;case"path":var pathes=path2curve(from[attr],to[attr]),toPath=pathes[1];from[attr]=pathes[0];diff[attr]=[];for(i=0,ii=from[attr].length;i<ii;i++){diff[attr][i]=[0];for(var j=1,jj=from[attr][i].length;j<jj;j++){diff[attr][i][j]=(toPath[i][j]-from[attr][i][j])/ms;}}
break;case"transform":var _=element._,eq=equaliseTransform(_[attr],to[attr]);if(eq){from[attr]=eq.from;to[attr]=eq.to;diff[attr]=[];diff[attr].real=true;for(i=0,ii=from[attr].length;i<ii;i++){diff[attr][i]=[from[attr][i][0]];for(j=1,jj=from[attr][i].length;j<jj;j++){diff[attr][i][j]=(to[attr][i][j]-from[attr][i][j])/ms;}}}else{var m=(element.matrix||new Matrix),to2={_:{transform:_.transform},getBBox:function(){return element.getBBox(1);}};from[attr]=[m.a,m.b,m.c,m.d,m.e,m.f];extractTransform(to2,to[attr]);to[attr]=to2._.transform;diff[attr]=[(to2.matrix.a-m.a)/ms,(to2.matrix.b-m.b)/ms,(to2.matrix.c-m.c)/ms,(to2.matrix.d-m.d)/ms,(to2.matrix.e-m.e)/ms,(to2.matrix.f-m.f)/ms];}
break;case"csv":var values=Str(params[attr])[split](separator),from2=Str(from[attr])[split](separator);if(attr=="clip-rect"){from[attr]=from2;diff[attr]=[];i=from2.length;while(i--){diff[attr][i]=(values[i]-from[attr][i])/ms;}}
to[attr]=values;break;default:values=[][concat](params[attr]);from2=[][concat](from[attr]);diff[attr]=[];i=element.paper.customAttributes[attr].length;while(i--){diff[attr][i]=((values[i]||0)-(from2[i]||0))/ms;}
break;}}}
var easing=params.easing,easyeasy=R.easing_formulas[easing];if(!easyeasy){easyeasy=Str(easing).match(bezierrg);if(easyeasy&&easyeasy.length==5){var curve=easyeasy;easyeasy=function(t){return CubicBezierAtTime(t,+curve[1],+curve[2],+curve[3],+curve[4],ms);};}else{easyeasy=pipe;}}
timestamp=params.start||anim.start||+new Date;e={anim:anim,percent:percent,timestamp:timestamp,start:timestamp+(anim.del||0),status:0,initstatus:status||0,stop:false,ms:ms,easing:easyeasy,from:from,diff:diff,to:to,el:element,callback:params.callback,prev:prev,next:next,repeat:times||anim.times,origin:element.attr(),totalOrigin:totalOrigin};animationElements.push(e);if(status&&!isInAnim&&!isInAnimSet){e.stop=true;e.start=new Date-ms*status;if(animationElements.length==1){return animation();}}
if(isInAnimSet){e.start=new Date-e.ms*status;}
animationElements.length==1&&requestAnimFrame(animation);}else{isInAnim.initstatus=status;isInAnim.start=new Date-isInAnim.ms*status;}
eve("raphael.anim.start."+element.id,element,anim);}
R.animation=function(params,ms,easing,callback){if(params instanceof Animation){return params;}
if(R.is(easing,"function")||!easing){callback=callback||easing||null;easing=null;}
params=Object(params);ms=+ms||0;var p={},json,attr;for(attr in params)if(params[has](attr)&&toFloat(attr)!=attr&&toFloat(attr)+"%"!=attr){json=true;p[attr]=params[attr];}
if(!json){return new Animation(params,ms);}else{easing&&(p.easing=easing);callback&&(p.callback=callback);return new Animation({100:p},ms);}};elproto.animate=function(params,ms,easing,callback){var element=this;if(element.removed){callback&&callback.call(element);return element;}
var anim=params instanceof Animation?params:R.animation(params,ms,easing,callback);runAnimation(anim,element,anim.percents[0],null,element.attr());return element;};elproto.setTime=function(anim,value){if(anim&&value!=null){this.status(anim,mmin(value,anim.ms)/anim.ms);}
return this;};elproto.status=function(anim,value){var out=[],i=0,len,e;if(value!=null){runAnimation(anim,this,-1,mmin(value,1));return this;}else{len=animationElements.length;for(;i<len;i++){e=animationElements[i];if(e.el.id==this.id&&(!anim||e.anim==anim)){if(anim){return e.status;}
out.push({anim:e.anim,status:e.status});}}
if(anim){return 0;}
return out;}};elproto.pause=function(anim){for(var i=0;i<animationElements.length;i++)if(animationElements[i].el.id==this.id&&(!anim||animationElements[i].anim==anim)){if(eve("raphael.anim.pause."+this.id,this,animationElements[i].anim)!==false){animationElements[i].paused=true;}}
return this;};elproto.resume=function(anim){for(var i=0;i<animationElements.length;i++)if(animationElements[i].el.id==this.id&&(!anim||animationElements[i].anim==anim)){var e=animationElements[i];if(eve("raphael.anim.resume."+this.id,this,e.anim)!==false){delete e.paused;this.status(e.anim,e.status);}}
return this;};elproto.stop=function(anim){for(var i=0;i<animationElements.length;i++)if(animationElements[i].el.id==this.id&&(!anim||animationElements[i].anim==anim)){if(eve("raphael.anim.stop."+this.id,this,animationElements[i].anim)!==false){animationElements.splice(i--,1);}}
return this;};function stopAnimation(paper){for(var i=0;i<animationElements.length;i++)if(animationElements[i].el.paper==paper){animationElements.splice(i--,1);}}
eve.on("raphael.remove",stopAnimation);eve.on("raphael.clear",stopAnimation);elproto.toString=function(){return"Rapha\xebl\u2019s object";};var Set=function(items){this.items=[];this.length=0;this.type="set";if(items){for(var i=0,ii=items.length;i<ii;i++){if(items[i]&&(items[i].constructor==elproto.constructor||items[i].constructor==Set)){this[this.items.length]=this.items[this.items.length]=items[i];this.length++;}}}},setproto=Set.prototype;setproto.push=function(){var item,len;for(var i=0,ii=arguments.length;i<ii;i++){item=arguments[i];if(item&&(item.constructor==elproto.constructor||item.constructor==Set)){len=this.items.length;this[len]=this.items[len]=item;this.length++;}}
return this;};setproto.pop=function(){this.length&&delete this[this.length--];return this.items.pop();};setproto.forEach=function(callback,thisArg){for(var i=0,ii=this.items.length;i<ii;i++){if(callback.call(thisArg,this.items[i],i)===false){return this;}}
return this;};for(var method in elproto)if(elproto[has](method)){setproto[method]=(function(methodname){return function(){var arg=arguments;return this.forEach(function(el){el[methodname][apply](el,arg);});};})(method);}
setproto.attr=function(name,value){if(name&&R.is(name,array)&&R.is(name[0],"object")){for(var j=0,jj=name.length;j<jj;j++){this.items[j].attr(name[j]);}}else{for(var i=0,ii=this.items.length;i<ii;i++){this.items[i].attr(name,value);}}
return this;};setproto.clear=function(){while(this.length){this.pop();}};setproto.splice=function(index,count,insertion){index=index<0?mmax(this.length+index,0):index;count=mmax(0,mmin(this.length-index,count));var tail=[],todel=[],args=[],i;for(i=2;i<arguments.length;i++){args.push(arguments[i]);}
for(i=0;i<count;i++){todel.push(this[index+i]);}
for(;i<this.length-index;i++){tail.push(this[index+i]);}
var arglen=args.length;for(i=0;i<arglen+tail.length;i++){this.items[index+i]=this[index+i]=i<arglen?args[i]:tail[i-arglen];}
i=this.items.length=this.length-=count-arglen;while(this[i]){delete this[i++];}
return new Set(todel);};setproto.exclude=function(el){for(var i=0,ii=this.length;i<ii;i++)if(this[i]==el){this.splice(i,1);return true;}};setproto.animate=function(params,ms,easing,callback){(R.is(easing,"function")||!easing)&&(callback=easing||null);var len=this.items.length,i=len,item,set=this,collector;if(!len){return this;}
callback&&(collector=function(){!--len&&callback.call(set);});easing=R.is(easing,string)?easing:collector;var anim=R.animation(params,ms,easing,collector);item=this.items[--i].animate(anim);while(i--){this.items[i]&&!this.items[i].removed&&this.items[i].animateWith(item,anim,anim);(this.items[i]&&!this.items[i].removed)||len--;}
return this;};setproto.insertAfter=function(el){var i=this.items.length;while(i--){this.items[i].insertAfter(el);}
return this;};setproto.getBBox=function(){var x=[],y=[],x2=[],y2=[];for(var i=this.items.length;i--;)if(!this.items[i].removed){var box=this.items[i].getBBox();x.push(box.x);y.push(box.y);x2.push(box.x+box.width);y2.push(box.y+box.height);}
x=mmin[apply](0,x);y=mmin[apply](0,y);x2=mmax[apply](0,x2);y2=mmax[apply](0,y2);return{x:x,y:y,x2:x2,y2:y2,width:x2-x,height:y2-y};};setproto.clone=function(s){s=this.paper.set();for(var i=0,ii=this.items.length;i<ii;i++){s.push(this.items[i].clone());}
return s;};setproto.toString=function(){return"Rapha\xebl\u2018s set";};setproto.glow=function(glowConfig){var ret=this.paper.set();this.forEach(function(shape,index){var g=shape.glow(glowConfig);if(g!=null){g.forEach(function(shape2,index2){ret.push(shape2);});}});return ret;};setproto.isPointInside=function(x,y){var isPointInside=false;this.forEach(function(el){if(el.isPointInside(x,y)){isPointInside=true;return false;}});return isPointInside;};R.registerFont=function(font){if(!font.face){return font;}
this.fonts=this.fonts||{};var fontcopy={w:font.w,face:{},glyphs:{}},family=font.face["font-family"];for(var prop in font.face)if(font.face[has](prop)){fontcopy.face[prop]=font.face[prop];}
if(this.fonts[family]){this.fonts[family].push(fontcopy);}else{this.fonts[family]=[fontcopy];}
if(!font.svg){fontcopy.face["units-per-em"]=toInt(font.face["units-per-em"],10);for(var glyph in font.glyphs)if(font.glyphs[has](glyph)){var path=font.glyphs[glyph];fontcopy.glyphs[glyph]={w:path.w,k:{},d:path.d&&"M"+path.d.replace(/[mlcxtrv]/g,function(command){return{l:"L",c:"C",x:"z",t:"m",r:"l",v:"c"}[command]||"M";})+"z"};if(path.k){for(var k in path.k)if(path[has](k)){fontcopy.glyphs[glyph].k[k]=path.k[k];}}}}
return font;};paperproto.getFont=function(family,weight,style,stretch){stretch=stretch||"normal";style=style||"normal";weight=+weight||{normal:400,bold:700,lighter:300,bolder:800}[weight]||400;if(!R.fonts){return;}
var font=R.fonts[family];if(!font){var name=new RegExp("(^|\\s)"+family.replace(/[^\w\d\s+!~.:_-]/g,E)+"(\\s|$)","i");for(var fontName in R.fonts)if(R.fonts[has](fontName)){if(name.test(fontName)){font=R.fonts[fontName];break;}}}
var thefont;if(font){for(var i=0,ii=font.length;i<ii;i++){thefont=font[i];if(thefont.face["font-weight"]==weight&&(thefont.face["font-style"]==style||!thefont.face["font-style"])&&thefont.face["font-stretch"]==stretch){break;}}}
return thefont;};paperproto.print=function(x,y,string,font,size,origin,letter_spacing,line_spacing){origin=origin||"middle";letter_spacing=mmax(mmin(letter_spacing||0,1),-1);line_spacing=mmax(mmin(line_spacing||1,3),1);var letters=Str(string)[split](E),shift=0,notfirst=0,path=E,scale;R.is(font,"string")&&(font=this.getFont(font));if(font){scale=(size||16)/font.face["units-per-em"];var bb=font.face.bbox[split](separator),top=+bb[0],lineHeight=bb[3]-bb[1],shifty=0,height=+bb[1]+(origin=="baseline"?lineHeight+(+font.face.descent):lineHeight/2);for(var i=0,ii=letters.length;i<ii;i++){if(letters[i]=="\n"){shift=0;curr=0;notfirst=0;shifty+=lineHeight*line_spacing;}else{var prev=notfirst&&font.glyphs[letters[i-1]]||{},curr=font.glyphs[letters[i]];shift+=notfirst?(prev.w||font.w)+(prev.k&&prev.k[letters[i]]||0)+(font.w*letter_spacing):0;notfirst=1;}
if(curr&&curr.d){path+=R.transformPath(curr.d,["t",shift*scale,shifty*scale,"s",scale,scale,top,height,"t",(x-top)/scale,(y-height)/scale]);}}}
return this.path(path).attr({fill:"#000",stroke:"none"});};paperproto.add=function(json){if(R.is(json,"array")){var res=this.set(),i=0,ii=json.length,j;for(;i<ii;i++){j=json[i]||{};elements[has](j.type)&&res.push(this[j.type]().attr(j));}}
return res;};R.format=function(token,params){var args=R.is(params,array)?[0][concat](params):arguments;token&&R.is(token,string)&&args.length-1&&(token=token.replace(formatrg,function(str,i){return args[++i]==null?E:args[i];}));return token||E;};R.fullfill=(function(){var tokenRegex=/\{([^\}]+)\}/g,objNotationRegex=/(?:(?:^|\.)(.+?)(?=\[|\.|$|\()|\[('|")(.+?)\2\])(\(\))?/g,replacer=function(all,key,obj){var res=obj;key.replace(objNotationRegex,function(all,name,quote,quotedName,isFunc){name=name||quotedName;if(res){if(name in res){res=res[name];}
typeof res=="function"&&isFunc&&(res=res());}});res=(res==null||res==obj?all:res)+"";return res;};return function(str,obj){return String(str).replace(tokenRegex,function(all,key){return replacer(all,key,obj);});};})();R.ninja=function(){oldRaphael.was?(g.win.Raphael=oldRaphael.is):delete Raphael;return R;};R.st=setproto;(function(doc,loaded,f){if(doc.readyState==null&&doc.addEventListener){doc.addEventListener(loaded,f=function(){doc.removeEventListener(loaded,f,false);doc.readyState="complete";},false);doc.readyState="loading";}
function isLoaded(){(/in/).test(doc.readyState)?setTimeout(isLoaded,9):R.eve("raphael.DOMload");}
isLoaded();})(document,"DOMContentLoaded");eve.on("raphael.DOMload",function(){loaded=true;});(function(){if(!R.svg){return;}
var has="hasOwnProperty",Str=String,toFloat=parseFloat,toInt=parseInt,math=Math,mmax=math.max,abs=math.abs,pow=math.pow,separator=/[, ]+/,eve=R.eve,E="",S=" ";var xlink="http://www.w3.org/1999/xlink",markers={block:"M5,0 0,2.5 5,5z",classic:"M5,0 0,2.5 5,5 3.5,3 3.5,2z",diamond:"M2.5,0 5,2.5 2.5,5 0,2.5z",open:"M6,1 1,3.5 6,6",oval:"M2.5,0A2.5,2.5,0,0,1,2.5,5 2.5,2.5,0,0,1,2.5,0z"},markerCounter={};R.toString=function(){return"Your browser supports SVG.\nYou are running Rapha\xebl "+this.version;};var $=function(el,attr){if(attr){if(typeof el=="string"){el=$(el);}
for(var key in attr)if(attr[has](key)){if(key.substring(0,6)=="xlink:"){el.setAttributeNS(xlink,key.substring(6),Str(attr[key]));}else{el.setAttribute(key,Str(attr[key]));}}}else{el=R._g.doc.createElementNS("http://www.w3.org/2000/svg",el);el.style&&(el.style.webkitTapHighlightColor="rgba(0,0,0,0)");}
return el;},addGradientFill=function(element,gradient){var type="linear",id=element.id+gradient,fx=.5,fy=.5,o=element.node,SVG=element.paper,s=o.style,el=R._g.doc.getElementById(id);if(!el){gradient=Str(gradient).replace(R._radial_gradient,function(all,_fx,_fy){type="radial";if(_fx&&_fy){fx=toFloat(_fx);fy=toFloat(_fy);var dir=((fy>.5)*2-1);pow(fx-.5,2)+pow(fy-.5,2)>.25&&(fy=math.sqrt(.25-pow(fx-.5,2))*dir+.5)&&fy!=.5&&(fy=fy.toFixed(5)-1e-5*dir);}
return E;});gradient=gradient.split(/\s*\-\s*/);if(type=="linear"){var angle=gradient.shift();angle=-toFloat(angle);if(isNaN(angle)){return null;}
var vector=[0,0,math.cos(R.rad(angle)),math.sin(R.rad(angle))],max=1/(mmax(abs(vector[2]),abs(vector[3]))||1);vector[2]*=max;vector[3]*=max;if(vector[2]<0){vector[0]=-vector[2];vector[2]=0;}
if(vector[3]<0){vector[1]=-vector[3];vector[3]=0;}}
var dots=R._parseDots(gradient);if(!dots){return null;}
id=id.replace(/[\(\)\s,\xb0#]/g,"_");if(element.gradient&&id!=element.gradient.id){SVG.defs.removeChild(element.gradient);delete element.gradient;}
if(!element.gradient){el=$(type+"Gradient",{id:id});element.gradient=el;$(el,type=="radial"?{fx:fx,fy:fy}:{x1:vector[0],y1:vector[1],x2:vector[2],y2:vector[3],gradientTransform:element.matrix.invert()});SVG.defs.appendChild(el);for(var i=0,ii=dots.length;i<ii;i++){el.appendChild($("stop",{offset:dots[i].offset?dots[i].offset:i?"100%":"0%","stop-color":dots[i].color||"#fff"}));}}}
$(o,{fill:"url(#"+id+")",opacity:1,"fill-opacity":1});s.fill=E;s.opacity=1;s.fillOpacity=1;return 1;},updatePosition=function(o){var bbox=o.getBBox(1);$(o.pattern,{patternTransform:o.matrix.invert()+" translate("+bbox.x+","+bbox.y+")"});},addArrow=function(o,value,isEnd){if(o.type=="path"){var values=Str(value).toLowerCase().split("-"),p=o.paper,se=isEnd?"end":"start",node=o.node,attrs=o.attrs,stroke=attrs["stroke-width"],i=values.length,type="classic",from,to,dx,refX,attr,w=3,h=3,t=5;while(i--){switch(values[i]){case"block":case"classic":case"oval":case"diamond":case"open":case"none":type=values[i];break;case"wide":h=5;break;case"narrow":h=2;break;case"long":w=5;break;case"short":w=2;break;}}
if(type=="open"){w+=2;h+=2;t+=2;dx=1;refX=isEnd?4:1;attr={fill:"none",stroke:attrs.stroke};}else{refX=dx=w/2;attr={fill:attrs.stroke,stroke:"none"};}
if(o._.arrows){if(isEnd){o._.arrows.endPath&&markerCounter[o._.arrows.endPath]--;o._.arrows.endMarker&&markerCounter[o._.arrows.endMarker]--;}else{o._.arrows.startPath&&markerCounter[o._.arrows.startPath]--;o._.arrows.startMarker&&markerCounter[o._.arrows.startMarker]--;}}else{o._.arrows={};}
if(type!="none"){var pathId="raphael-marker-"+type,markerId="raphael-marker-"+se+type+w+h;if(!R._g.doc.getElementById(pathId)){p.defs.appendChild($($("path"),{"stroke-linecap":"round",d:markers[type],id:pathId}));markerCounter[pathId]=1;}else{markerCounter[pathId]++;}
var marker=R._g.doc.getElementById(markerId),use;if(!marker){marker=$($("marker"),{id:markerId,markerHeight:h,markerWidth:w,orient:"auto",refX:refX,refY:h/2});use=$($("use"),{"xlink:href":"#"+pathId,transform:(isEnd?"rotate(180 "+w/2+" "+h/2+") ":E)+"scale("+w/t+","+h/t+")","stroke-width":(1/((w/t+h/t)/2)).toFixed(4)});marker.appendChild(use);p.defs.appendChild(marker);markerCounter[markerId]=1;}else{markerCounter[markerId]++;use=marker.getElementsByTagName("use")[0];}
$(use,attr);var delta=dx*(type!="diamond"&&type!="oval");if(isEnd){from=o._.arrows.startdx*stroke||0;to=R.getTotalLength(attrs.path)-delta*stroke;}else{from=delta*stroke;to=R.getTotalLength(attrs.path)-(o._.arrows.enddx*stroke||0);}
attr={};attr["marker-"+se]="url(#"+markerId+")";if(to||from){attr.d=R.getSubpath(attrs.path,from,to);}
$(node,attr);o._.arrows[se+"Path"]=pathId;o._.arrows[se+"Marker"]=markerId;o._.arrows[se+"dx"]=delta;o._.arrows[se+"Type"]=type;o._.arrows[se+"String"]=value;}else{if(isEnd){from=o._.arrows.startdx*stroke||0;to=R.getTotalLength(attrs.path)-from;}else{from=0;to=R.getTotalLength(attrs.path)-(o._.arrows.enddx*stroke||0);}
o._.arrows[se+"Path"]&&$(node,{d:R.getSubpath(attrs.path,from,to)});delete o._.arrows[se+"Path"];delete o._.arrows[se+"Marker"];delete o._.arrows[se+"dx"];delete o._.arrows[se+"Type"];delete o._.arrows[se+"String"];}
for(attr in markerCounter)if(markerCounter[has](attr)&&!markerCounter[attr]){var item=R._g.doc.getElementById(attr);item&&item.parentNode.removeChild(item);}}},dasharray={"":[0],"none":[0],"-":[3,1],".":[1,1],"-.":[3,1,1,1],"-..":[3,1,1,1,1,1],". ":[1,3],"- ":[4,3],"--":[8,3],"- .":[4,3,1,3],"--.":[8,3,1,3],"--..":[8,3,1,3,1,3]},addDashes=function(o,value,params){value=dasharray[Str(value).toLowerCase()];if(value){var width=o.attrs["stroke-width"]||"1",butt={round:width,square:width,butt:0}[o.attrs["stroke-linecap"]||params["stroke-linecap"]]||0,dashes=[],i=value.length;while(i--){dashes[i]=value[i]*width+((i%2)?1:-1)*butt;}
$(o.node,{"stroke-dasharray":dashes.join(",")});}},setFillAndStroke=function(o,params){var node=o.node,attrs=o.attrs,vis=node.style.visibility;node.style.visibility="hidden";for(var att in params){if(params[has](att)){if(!R._availableAttrs[has](att)){continue;}
var value=params[att];attrs[att]=value;switch(att){case"blur":o.blur(value);break;case"title":var title=node.getElementsByTagName("title");if(title.length&&(title=title[0])){title.firstChild.nodeValue=value;}else{title=$("title");var val=R._g.doc.createTextNode(value);title.appendChild(val);node.appendChild(title);}
break;case"href":case"target":var pn=node.parentNode;if(pn.tagName.toLowerCase()!="a"){var hl=$("a");pn.insertBefore(hl,node);hl.appendChild(node);pn=hl;}
if(att=="target"){pn.setAttributeNS(xlink,"show",value=="blank"?"new":value);}else{pn.setAttributeNS(xlink,att,value);}
break;case"cursor":node.style.cursor=value;break;case"transform":o.transform(value);break;case"arrow-start":addArrow(o,value);break;case"arrow-end":addArrow(o,value,1);break;case"clip-rect":var rect=Str(value).split(separator);if(rect.length==4){o.clip&&o.clip.parentNode.parentNode.removeChild(o.clip.parentNode);var el=$("clipPath"),rc=$("rect");el.id=R.createUUID();$(rc,{x:rect[0],y:rect[1],width:rect[2],height:rect[3]});el.appendChild(rc);o.paper.defs.appendChild(el);$(node,{"clip-path":"url(#"+el.id+")"});o.clip=rc;}
if(!value){var path=node.getAttribute("clip-path");if(path){var clip=R._g.doc.getElementById(path.replace(/(^url\(#|\)$)/g,E));clip&&clip.parentNode.removeChild(clip);$(node,{"clip-path":E});delete o.clip;}}
break;case"path":if(o.type=="path"){$(node,{d:value?attrs.path=R._pathToAbsolute(value):"M0,0"});o._.dirty=1;if(o._.arrows){"startString"in o._.arrows&&addArrow(o,o._.arrows.startString);"endString"in o._.arrows&&addArrow(o,o._.arrows.endString,1);}}
break;case"width":node.setAttribute(att,value);o._.dirty=1;if(attrs.fx){att="x";value=attrs.x;}else{break;}
case"x":if(attrs.fx){value=-attrs.x-(attrs.width||0);}
case"rx":if(att=="rx"&&o.type=="rect"){break;}
case"cx":node.setAttribute(att,value);o.pattern&&updatePosition(o);o._.dirty=1;break;case"height":node.setAttribute(att,value);o._.dirty=1;if(attrs.fy){att="y";value=attrs.y;}else{break;}
case"y":if(attrs.fy){value=-attrs.y-(attrs.height||0);}
case"ry":if(att=="ry"&&o.type=="rect"){break;}
case"cy":node.setAttribute(att,value);o.pattern&&updatePosition(o);o._.dirty=1;break;case"r":if(o.type=="rect"){$(node,{rx:value,ry:value});}else{node.setAttribute(att,value);}
o._.dirty=1;break;case"src":if(o.type=="image"){node.setAttributeNS(xlink,"href",value);}
break;case"stroke-width":if(o._.sx!=1||o._.sy!=1){value/=mmax(abs(o._.sx),abs(o._.sy))||1;}
if(o.paper._vbSize){value*=o.paper._vbSize;}
node.setAttribute(att,value);if(attrs["stroke-dasharray"]){addDashes(o,attrs["stroke-dasharray"],params);}
if(o._.arrows){"startString"in o._.arrows&&addArrow(o,o._.arrows.startString);"endString"in o._.arrows&&addArrow(o,o._.arrows.endString,1);}
break;case"stroke-dasharray":addDashes(o,value,params);break;case"fill":var isURL=Str(value).match(R._ISURL);if(isURL){el=$("pattern");var ig=$("image");el.id=R.createUUID();$(el,{x:0,y:0,patternUnits:"userSpaceOnUse",height:1,width:1});$(ig,{x:0,y:0,"xlink:href":isURL[1]});el.appendChild(ig);(function(el){R._preload(isURL[1],function(){var w=this.offsetWidth,h=this.offsetHeight;$(el,{width:w,height:h});$(ig,{width:w,height:h});o.paper.safari();});})(el);o.paper.defs.appendChild(el);$(node,{fill:"url(#"+el.id+")"});o.pattern=el;o.pattern&&updatePosition(o);break;}
var clr=R.getRGB(value);if(!clr.error){delete params.gradient;delete attrs.gradient;!R.is(attrs.opacity,"undefined")&&R.is(params.opacity,"undefined")&&$(node,{opacity:attrs.opacity});!R.is(attrs["fill-opacity"],"undefined")&&R.is(params["fill-opacity"],"undefined")&&$(node,{"fill-opacity":attrs["fill-opacity"]});}else if((o.type=="circle"||o.type=="ellipse"||Str(value).charAt()!="r")&&addGradientFill(o,value)){if("opacity"in attrs||"fill-opacity"in attrs){var gradient=R._g.doc.getElementById(node.getAttribute("fill").replace(/^url\(#|\)$/g,E));if(gradient){var stops=gradient.getElementsByTagName("stop");$(stops[stops.length-1],{"stop-opacity":("opacity"in attrs?attrs.opacity:1)*("fill-opacity"in attrs?attrs["fill-opacity"]:1)});}}
attrs.gradient=value;attrs.fill="none";break;}
clr[has]("opacity")&&$(node,{"fill-opacity":clr.opacity>1?clr.opacity/100:clr.opacity});case"stroke":clr=R.getRGB(value);node.setAttribute(att,clr.hex);att=="stroke"&&clr[has]("opacity")&&$(node,{"stroke-opacity":clr.opacity>1?clr.opacity/100:clr.opacity});if(att=="stroke"&&o._.arrows){"startString"in o._.arrows&&addArrow(o,o._.arrows.startString);"endString"in o._.arrows&&addArrow(o,o._.arrows.endString,1);}
break;case"gradient":(o.type=="circle"||o.type=="ellipse"||Str(value).charAt()!="r")&&addGradientFill(o,value);break;case"opacity":if(attrs.gradient&&!attrs[has]("stroke-opacity")){$(node,{"stroke-opacity":value>1?value/100:value});}
case"fill-opacity":if(attrs.gradient){gradient=R._g.doc.getElementById(node.getAttribute("fill").replace(/^url\(#|\)$/g,E));if(gradient){stops=gradient.getElementsByTagName("stop");$(stops[stops.length-1],{"stop-opacity":value});}
break;}
default:att=="font-size"&&(value=toInt(value,10)+"px");var cssrule=att.replace(/(\-.)/g,function(w){return w.substring(1).toUpperCase();});node.style[cssrule]=value;o._.dirty=1;node.setAttribute(att,value);break;}}}
tuneText(o,params);node.style.visibility=vis;},leading=1.2,tuneText=function(el,params){if(el.type!="text"||!(params[has]("text")||params[has]("font")||params[has]("font-size")||params[has]("x")||params[has]("y"))){return;}
var a=el.attrs,node=el.node,fontSize=node.firstChild?toInt(R._g.doc.defaultView.getComputedStyle(node.firstChild,E).getPropertyValue("font-size"),10):10;if(params[has]("text")){a.text=params.text;while(node.firstChild){node.removeChild(node.firstChild);}
var texts=Str(params.text).split("\n"),tspans=[],tspan;for(var i=0,ii=texts.length;i<ii;i++){tspan=$("tspan");i&&$(tspan,{dy:fontSize*leading,x:a.x});tspan.appendChild(R._g.doc.createTextNode(texts[i]));node.appendChild(tspan);tspans[i]=tspan;}}else{tspans=node.getElementsByTagName("tspan");for(i=0,ii=tspans.length;i<ii;i++)if(i){$(tspans[i],{dy:fontSize*leading,x:a.x});}else{$(tspans[0],{dy:0});}}
$(node,{x:a.x,y:a.y});el._.dirty=1;var bb=el._getBBox(),dif=a.y-(bb.y+bb.height/2);dif&&R.is(dif,"finite")&&$(tspans[0],{dy:dif});},Element=function(node,svg){var X=0,Y=0;this[0]=this.node=node;node.raphael=true;this.id=R._oid++;node.raphaelid=this.id;this.matrix=R.matrix();this.realPath=null;this.paper=svg;this.attrs=this.attrs||{};this._={transform:[],sx:1,sy:1,deg:0,dx:0,dy:0,dirty:1};!svg.bottom&&(svg.bottom=this);this.prev=svg.top;svg.top&&(svg.top.next=this);svg.top=this;this.next=null;},elproto=R.el;Element.prototype=elproto;elproto.constructor=Element;R._engine.path=function(pathString,SVG){var el=$("path");SVG.canvas&&SVG.canvas.appendChild(el);var p=new Element(el,SVG);p.type="path";setFillAndStroke(p,{fill:"none",stroke:"#000",path:pathString});return p;};elproto.rotate=function(deg,cx,cy){if(this.removed){return this;}
deg=Str(deg).split(separator);if(deg.length-1){cx=toFloat(deg[1]);cy=toFloat(deg[2]);}
deg=toFloat(deg[0]);(cy==null)&&(cx=cy);if(cx==null||cy==null){var bbox=this.getBBox(1);cx=bbox.x+bbox.width/2;cy=bbox.y+bbox.height/2;}
this.transform(this._.transform.concat([["r",deg,cx,cy]]));return this;};elproto.scale=function(sx,sy,cx,cy){if(this.removed){return this;}
sx=Str(sx).split(separator);if(sx.length-1){sy=toFloat(sx[1]);cx=toFloat(sx[2]);cy=toFloat(sx[3]);}
sx=toFloat(sx[0]);(sy==null)&&(sy=sx);(cy==null)&&(cx=cy);if(cx==null||cy==null){var bbox=this.getBBox(1);}
cx=cx==null?bbox.x+bbox.width/2:cx;cy=cy==null?bbox.y+bbox.height/2:cy;this.transform(this._.transform.concat([["s",sx,sy,cx,cy]]));return this;};elproto.translate=function(dx,dy){if(this.removed){return this;}
dx=Str(dx).split(separator);if(dx.length-1){dy=toFloat(dx[1]);}
dx=toFloat(dx[0])||0;dy=+dy||0;this.transform(this._.transform.concat([["t",dx,dy]]));return this;};elproto.transform=function(tstr){var _=this._;if(tstr==null){return _.transform;}
R._extractTransform(this,tstr);this.clip&&$(this.clip,{transform:this.matrix.invert()});this.pattern&&updatePosition(this);this.node&&$(this.node,{transform:this.matrix});if(_.sx!=1||_.sy!=1){var sw=this.attrs[has]("stroke-width")?this.attrs["stroke-width"]:1;this.attr({"stroke-width":sw});}
return this;};elproto.hide=function(){!this.removed&&this.paper.safari(this.node.style.display="none");return this;};elproto.show=function(){!this.removed&&this.paper.safari(this.node.style.display="");return this;};elproto.remove=function(){if(this.removed||!this.node.parentNode){return;}
var paper=this.paper;paper.__set__&&paper.__set__.exclude(this);eve.unbind("raphael.*.*."+this.id);if(this.gradient){paper.defs.removeChild(this.gradient);}
R._tear(this,paper);if(this.node.parentNode.tagName.toLowerCase()=="a"){this.node.parentNode.parentNode.removeChild(this.node.parentNode);}else{this.node.parentNode.removeChild(this.node);}
for(var i in this){this[i]=typeof this[i]=="function"?R._removedFactory(i):null;}
this.removed=true;};elproto._getBBox=function(){if(this.node.style.display=="none"){this.show();var hide=true;}
var bbox={};try{bbox=this.node.getBBox();}catch(e){}finally{bbox=bbox||{};}
hide&&this.hide();return bbox;};elproto.attr=function(name,value){if(this.removed){return this;}
if(name==null){var res={};for(var a in this.attrs)if(this.attrs[has](a)){res[a]=this.attrs[a];}
res.gradient&&res.fill=="none"&&(res.fill=res.gradient)&&delete res.gradient;res.transform=this._.transform;return res;}
if(value==null&&R.is(name,"string")){if(name=="fill"&&this.attrs.fill=="none"&&this.attrs.gradient){return this.attrs.gradient;}
if(name=="transform"){return this._.transform;}
var names=name.split(separator),out={};for(var i=0,ii=names.length;i<ii;i++){name=names[i];if(name in this.attrs){out[name]=this.attrs[name];}else if(R.is(this.paper.customAttributes[name],"function")){out[name]=this.paper.customAttributes[name].def;}else{out[name]=R._availableAttrs[name];}}
return ii-1?out:out[names[0]];}
if(value==null&&R.is(name,"array")){out={};for(i=0,ii=name.length;i<ii;i++){out[name[i]]=this.attr(name[i]);}
return out;}
if(value!=null){var params={};params[name]=value;}else if(name!=null&&R.is(name,"object")){params=name;}
for(var key in params){eve("raphael.attr."+key+"."+this.id,this,params[key]);}
for(key in this.paper.customAttributes)if(this.paper.customAttributes[has](key)&&params[has](key)&&R.is(this.paper.customAttributes[key],"function")){var par=this.paper.customAttributes[key].apply(this,[].concat(params[key]));this.attrs[key]=params[key];for(var subkey in par)if(par[has](subkey)){params[subkey]=par[subkey];}}
setFillAndStroke(this,params);return this;};elproto.toFront=function(){if(this.removed){return this;}
if(this.node.parentNode.tagName.toLowerCase()=="a"){this.node.parentNode.parentNode.appendChild(this.node.parentNode);}else{this.node.parentNode.appendChild(this.node);}
var svg=this.paper;svg.top!=this&&R._tofront(this,svg);return this;};elproto.toBack=function(){if(this.removed){return this;}
var parent=this.node.parentNode;if(parent.tagName.toLowerCase()=="a"){parent.parentNode.insertBefore(this.node.parentNode,this.node.parentNode.parentNode.firstChild);}else if(parent.firstChild!=this.node){parent.insertBefore(this.node,this.node.parentNode.firstChild);}
R._toback(this,this.paper);var svg=this.paper;return this;};elproto.insertAfter=function(element){if(this.removed){return this;}
var node=element.node||element[element.length-1].node;if(node.nextSibling){node.parentNode.insertBefore(this.node,node.nextSibling);}else{node.parentNode.appendChild(this.node);}
R._insertafter(this,element,this.paper);return this;};elproto.insertBefore=function(element){if(this.removed){return this;}
var node=element.node||element[0].node;node.parentNode.insertBefore(this.node,node);R._insertbefore(this,element,this.paper);return this;};elproto.blur=function(size){var t=this;if(+size!==0){var fltr=$("filter"),blur=$("feGaussianBlur");t.attrs.blur=size;fltr.id=R.createUUID();$(blur,{stdDeviation:+size||1.5});fltr.appendChild(blur);t.paper.defs.appendChild(fltr);t._blur=fltr;$(t.node,{filter:"url(#"+fltr.id+")"});}else{if(t._blur){t._blur.parentNode.removeChild(t._blur);delete t._blur;delete t.attrs.blur;}
t.node.removeAttribute("filter");}
return t;};R._engine.circle=function(svg,x,y,r){var el=$("circle");svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);res.attrs={cx:x,cy:y,r:r,fill:"none",stroke:"#000"};res.type="circle";$(el,res.attrs);return res;};R._engine.rect=function(svg,x,y,w,h,r){var el=$("rect");svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);res.attrs={x:x,y:y,width:w,height:h,r:r||0,rx:r||0,ry:r||0,fill:"none",stroke:"#000"};res.type="rect";$(el,res.attrs);return res;};R._engine.ellipse=function(svg,x,y,rx,ry){var el=$("ellipse");svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);res.attrs={cx:x,cy:y,rx:rx,ry:ry,fill:"none",stroke:"#000"};res.type="ellipse";$(el,res.attrs);return res;};R._engine.image=function(svg,src,x,y,w,h){var el=$("image");$(el,{x:x,y:y,width:w,height:h,preserveAspectRatio:"none"});el.setAttributeNS(xlink,"href",src);svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);res.attrs={x:x,y:y,width:w,height:h,src:src};res.type="image";return res;};R._engine.text=function(svg,x,y,text){var el=$("text");svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);res.attrs={x:x,y:y,"text-anchor":"middle",text:text,font:R._availableAttrs.font,stroke:"none",fill:"#000"};res.type="text";setFillAndStroke(res,res.attrs);return res;};R._engine.setSize=function(width,height){this.width=width||this.width;this.height=height||this.height;this.canvas.setAttribute("width",this.width);this.canvas.setAttribute("height",this.height);if(this._viewBox){this.setViewBox.apply(this,this._viewBox);}
return this;};R._engine.create=function(){var con=R._getContainer.apply(0,arguments),container=con&&con.container,x=con.x,y=con.y,width=con.width,height=con.height;if(!container){throw new Error("SVG container not found.");}
var cnvs=$("svg"),css="overflow:hidden;",isFloating;x=x||0;y=y||0;width=width||512;height=height||342;$(cnvs,{height:height,version:1.1,width:width,xmlns:"http://www.w3.org/2000/svg"});if(container==1){cnvs.style.cssText=css+"position:absolute;left:"+x+"px;top:"+y+"px";R._g.doc.body.appendChild(cnvs);isFloating=1;}else{cnvs.style.cssText=css+"position:relative";if(container.firstChild){container.insertBefore(cnvs,container.firstChild);}else{container.appendChild(cnvs);}}
container=new R._Paper;container.width=width;container.height=height;container.canvas=cnvs;container.clear();container._left=container._top=0;isFloating&&(container.renderfix=function(){});container.renderfix();return container;};R._engine.setViewBox=function(x,y,w,h,fit){eve("raphael.setViewBox",this,this._viewBox,[x,y,w,h,fit]);var size=mmax(w/this.width,h/this.height),top=this.top,aspectRatio=fit?"meet":"xMinYMin",vb,sw;if(x==null){if(this._vbSize){size=1;}
delete this._vbSize;vb="0 0 "+this.width+S+this.height;}else{this._vbSize=size;vb=x+S+y+S+w+S+h;}
$(this.canvas,{viewBox:vb,preserveAspectRatio:aspectRatio});while(size&&top){sw="stroke-width"in top.attrs?top.attrs["stroke-width"]:1;top.attr({"stroke-width":sw});top._.dirty=1;top._.dirtyT=1;top=top.prev;}
this._viewBox=[x,y,w,h,!!fit];return this;};R.prototype.renderfix=function(){var cnvs=this.canvas,s=cnvs.style,pos;try{pos=cnvs.getScreenCTM()||cnvs.createSVGMatrix();}catch(e){pos=cnvs.createSVGMatrix();}
var left=-pos.e%1,top=-pos.f%1;if(left||top){if(left){this._left=(this._left+left)%1;s.left=this._left+"px";}
if(top){this._top=(this._top+top)%1;s.top=this._top+"px";}}};R.prototype.clear=function(){R.eve("raphael.clear",this);var c=this.canvas;while(c.firstChild){c.removeChild(c.firstChild);}
this.bottom=this.top=null;(this.desc=$("desc")).appendChild(R._g.doc.createTextNode("Created with Rapha\xebl "+R.version));c.appendChild(this.desc);c.appendChild(this.defs=$("defs"));};R.prototype.remove=function(){eve("raphael.remove",this);this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);for(var i in this){this[i]=typeof this[i]=="function"?R._removedFactory(i):null;}};var setproto=R.st;for(var method in elproto)if(elproto[has](method)&&!setproto[has](method)){setproto[method]=(function(methodname){return function(){var arg=arguments;return this.forEach(function(el){el[methodname].apply(el,arg);});};})(method);}})();(function(){if(!R.vml){return;}
var has="hasOwnProperty",Str=String,toFloat=parseFloat,math=Math,round=math.round,mmax=math.max,mmin=math.min,abs=math.abs,fillString="fill",separator=/[, ]+/,eve=R.eve,ms=" progid:DXImageTransform.Microsoft",S=" ",E="",map={M:"m",L:"l",C:"c",Z:"x",m:"t",l:"r",c:"v",z:"x"},bites=/([clmz]),?([^clmz]*)/gi,blurregexp=/ progid:\S+Blur\([^\)]+\)/g,val=/-?[^,\s-]+/g,cssDot="position:absolute;left:0;top:0;width:1px;height:1px",zoom=21600,pathTypes={path:1,rect:1,image:1},ovalTypes={circle:1,ellipse:1},path2vml=function(path){var total=/[ahqstv]/ig,command=R._pathToAbsolute;Str(path).match(total)&&(command=R._path2curve);total=/[clmz]/g;if(command==R._pathToAbsolute&&!Str(path).match(total)){var res=Str(path).replace(bites,function(all,command,args){var vals=[],isMove=command.toLowerCase()=="m",res=map[command];args.replace(val,function(value){if(isMove&&vals.length==2){res+=vals+map[command=="m"?"l":"L"];vals=[];}
vals.push(round(value*zoom));});return res+vals;});return res;}
var pa=command(path),p,r;res=[];for(var i=0,ii=pa.length;i<ii;i++){p=pa[i];r=pa[i][0].toLowerCase();r=="z"&&(r="x");for(var j=1,jj=p.length;j<jj;j++){r+=round(p[j]*zoom)+(j!=jj-1?",":E);}
res.push(r);}
return res.join(S);},compensation=function(deg,dx,dy){var m=R.matrix();m.rotate(-deg,.5,.5);return{dx:m.x(dx,dy),dy:m.y(dx,dy)};},setCoords=function(p,sx,sy,dx,dy,deg){var _=p._,m=p.matrix,fillpos=_.fillpos,o=p.node,s=o.style,y=1,flip="",dxdy,kx=zoom/sx,ky=zoom/sy;s.visibility="hidden";if(!sx||!sy){return;}
o.coordsize=abs(kx)+S+abs(ky);s.rotation=deg*(sx*sy<0?-1:1);if(deg){var c=compensation(deg,dx,dy);dx=c.dx;dy=c.dy;}
sx<0&&(flip+="x");sy<0&&(flip+=" y")&&(y=-1);s.flip=flip;o.coordorigin=(dx*-kx)+S+(dy*-ky);if(fillpos||_.fillsize){var fill=o.getElementsByTagName(fillString);fill=fill&&fill[0];o.removeChild(fill);if(fillpos){c=compensation(deg,m.x(fillpos[0],fillpos[1]),m.y(fillpos[0],fillpos[1]));fill.position=c.dx*y+S+c.dy*y;}
if(_.fillsize){fill.size=_.fillsize[0]*abs(sx)+S+_.fillsize[1]*abs(sy);}
o.appendChild(fill);}
s.visibility="visible";};R.toString=function(){return"Your browser doesn\u2019t support SVG. Falling down to VML.\nYou are running Rapha\xebl "+this.version;};var addArrow=function(o,value,isEnd){var values=Str(value).toLowerCase().split("-"),se=isEnd?"end":"start",i=values.length,type="classic",w="medium",h="medium";while(i--){switch(values[i]){case"block":case"classic":case"oval":case"diamond":case"open":case"none":type=values[i];break;case"wide":case"narrow":h=values[i];break;case"long":case"short":w=values[i];break;}}
var stroke=o.node.getElementsByTagName("stroke")[0];stroke[se+"arrow"]=type;stroke[se+"arrowlength"]=w;stroke[se+"arrowwidth"]=h;},setFillAndStroke=function(o,params){o.attrs=o.attrs||{};var node=o.node,a=o.attrs,s=node.style,xy,newpath=pathTypes[o.type]&&(params.x!=a.x||params.y!=a.y||params.width!=a.width||params.height!=a.height||params.cx!=a.cx||params.cy!=a.cy||params.rx!=a.rx||params.ry!=a.ry||params.r!=a.r),isOval=ovalTypes[o.type]&&(a.cx!=params.cx||a.cy!=params.cy||a.r!=params.r||a.rx!=params.rx||a.ry!=params.ry),res=o;for(var par in params)if(params[has](par)){a[par]=params[par];}
if(newpath){a.path=R._getPath[o.type](o);o._.dirty=1;}
params.href&&(node.href=params.href);params.title&&(node.title=params.title);params.target&&(node.target=params.target);params.cursor&&(s.cursor=params.cursor);"blur"in params&&o.blur(params.blur);if(params.path&&o.type=="path"||newpath){node.path=path2vml(~Str(a.path).toLowerCase().indexOf("r")?R._pathToAbsolute(a.path):a.path);if(o.type=="image"){o._.fillpos=[a.x,a.y];o._.fillsize=[a.width,a.height];setCoords(o,1,1,0,0,0);}}"transform"in params&&o.transform(params.transform);if(isOval){var cx=+a.cx,cy=+a.cy,rx=+a.rx||+a.r||0,ry=+a.ry||+a.r||0;node.path=R.format("ar{0},{1},{2},{3},{4},{1},{4},{1}x",round((cx-rx)*zoom),round((cy-ry)*zoom),round((cx+rx)*zoom),round((cy+ry)*zoom),round(cx*zoom));o._.dirty=1;}
if("clip-rect"in params){var rect=Str(params["clip-rect"]).split(separator);if(rect.length==4){rect[2]=+rect[2]+(+rect[0]);rect[3]=+rect[3]+(+rect[1]);var div=node.clipRect||R._g.doc.createElement("div"),dstyle=div.style;dstyle.clip=R.format("rect({1}px {2}px {3}px {0}px)",rect);if(!node.clipRect){dstyle.position="absolute";dstyle.top=0;dstyle.left=0;dstyle.width=o.paper.width+"px";dstyle.height=o.paper.height+"px";node.parentNode.insertBefore(div,node);div.appendChild(node);node.clipRect=div;}}
if(!params["clip-rect"]){node.clipRect&&(node.clipRect.style.clip="auto");}}
if(o.textpath){var textpathStyle=o.textpath.style;params.font&&(textpathStyle.font=params.font);params["font-family"]&&(textpathStyle.fontFamily='"'+params["font-family"].split(",")[0].replace(/^['"]+|['"]+$/g,E)+'"');params["font-size"]&&(textpathStyle.fontSize=params["font-size"]);params["font-weight"]&&(textpathStyle.fontWeight=params["font-weight"]);params["font-style"]&&(textpathStyle.fontStyle=params["font-style"]);}
if("arrow-start"in params){addArrow(res,params["arrow-start"]);}
if("arrow-end"in params){addArrow(res,params["arrow-end"],1);}
if(params.opacity!=null||params["stroke-width"]!=null||params.fill!=null||params.src!=null||params.stroke!=null||params["stroke-width"]!=null||params["stroke-opacity"]!=null||params["fill-opacity"]!=null||params["stroke-dasharray"]!=null||params["stroke-miterlimit"]!=null||params["stroke-linejoin"]!=null||params["stroke-linecap"]!=null){var fill=node.getElementsByTagName(fillString),newfill=false;fill=fill&&fill[0];!fill&&(newfill=fill=createNode(fillString));if(o.type=="image"&&params.src){fill.src=params.src;}
params.fill&&(fill.on=true);if(fill.on==null||params.fill=="none"||params.fill===null){fill.on=false;}
if(fill.on&&params.fill){var isURL=Str(params.fill).match(R._ISURL);if(isURL){fill.parentNode==node&&node.removeChild(fill);fill.rotate=true;fill.src=isURL[1];fill.type="tile";var bbox=o.getBBox(1);fill.position=bbox.x+S+bbox.y;o._.fillpos=[bbox.x,bbox.y];R._preload(isURL[1],function(){o._.fillsize=[this.offsetWidth,this.offsetHeight];});}else{fill.color=R.getRGB(params.fill).hex;fill.src=E;fill.type="solid";if(R.getRGB(params.fill).error&&(res.type in{circle:1,ellipse:1}||Str(params.fill).charAt()!="r")&&addGradientFill(res,params.fill,fill)){a.fill="none";a.gradient=params.fill;fill.rotate=false;}}}
if("fill-opacity"in params||"opacity"in params){var opacity=((+a["fill-opacity"]+1||2)-1)*((+a.opacity+1||2)-1)*((+R.getRGB(params.fill).o+1||2)-1);opacity=mmin(mmax(opacity,0),1);fill.opacity=opacity;if(fill.src){fill.color="none";}}
node.appendChild(fill);var stroke=(node.getElementsByTagName("stroke")&&node.getElementsByTagName("stroke")[0]),newstroke=false;!stroke&&(newstroke=stroke=createNode("stroke"));if((params.stroke&&params.stroke!="none")||params["stroke-width"]||params["stroke-opacity"]!=null||params["stroke-dasharray"]||params["stroke-miterlimit"]||params["stroke-linejoin"]||params["stroke-linecap"]){stroke.on=true;}
(params.stroke=="none"||params.stroke===null||stroke.on==null||params.stroke==0||params["stroke-width"]==0)&&(stroke.on=false);var strokeColor=R.getRGB(params.stroke);stroke.on&&params.stroke&&(stroke.color=strokeColor.hex);opacity=((+a["stroke-opacity"]+1||2)-1)*((+a.opacity+1||2)-1)*((+strokeColor.o+1||2)-1);var width=(toFloat(params["stroke-width"])||1)*.75;opacity=mmin(mmax(opacity,0),1);params["stroke-width"]==null&&(width=a["stroke-width"]);params["stroke-width"]&&(stroke.weight=width);width&&width<1&&(opacity*=width)&&(stroke.weight=1);stroke.opacity=opacity;params["stroke-linejoin"]&&(stroke.joinstyle=params["stroke-linejoin"]||"miter");stroke.miterlimit=params["stroke-miterlimit"]||8;params["stroke-linecap"]&&(stroke.endcap=params["stroke-linecap"]=="butt"?"flat":params["stroke-linecap"]=="square"?"square":"round");if("stroke-dasharray"in params){var dasharray={"-":"shortdash",".":"shortdot","-.":"shortdashdot","-..":"shortdashdotdot",". ":"dot","- ":"dash","--":"longdash","- .":"dashdot","--.":"longdashdot","--..":"longdashdotdot"};stroke.dashstyle=dasharray[has](params["stroke-dasharray"])?dasharray[params["stroke-dasharray"]]:E;}
newstroke&&node.appendChild(stroke);}
if(res.type=="text"){res.paper.canvas.style.display=E;var span=res.paper.span,m=100,fontSize=a.font&&a.font.match(/\d+(?:\.\d*)?(?=px)/);s=span.style;a.font&&(s.font=a.font);a["font-family"]&&(s.fontFamily=a["font-family"]);a["font-weight"]&&(s.fontWeight=a["font-weight"]);a["font-style"]&&(s.fontStyle=a["font-style"]);fontSize=toFloat(a["font-size"]||fontSize&&fontSize[0])||10;s.fontSize=fontSize*m+"px";res.textpath.string&&(span.innerHTML=Str(res.textpath.string).replace(/</g,"&#60;").replace(/&/g,"&#38;").replace(/\n/g,"<br>"));var brect=span.getBoundingClientRect();res.W=a.w=(brect.right-brect.left)/m;res.H=a.h=(brect.bottom-brect.top)/m;res.X=a.x;res.Y=a.y+res.H/2;("x"in params||"y"in params)&&(res.path.v=R.format("m{0},{1}l{2},{1}",round(a.x*zoom),round(a.y*zoom),round(a.x*zoom)+1));var dirtyattrs=["x","y","text","font","font-family","font-weight","font-style","font-size"];for(var d=0,dd=dirtyattrs.length;d<dd;d++)if(dirtyattrs[d]in params){res._.dirty=1;break;}
switch(a["text-anchor"]){case"start":res.textpath.style["v-text-align"]="left";res.bbx=res.W/2;break;case"end":res.textpath.style["v-text-align"]="right";res.bbx=-res.W/2;break;default:res.textpath.style["v-text-align"]="center";res.bbx=0;break;}
res.textpath.style["v-text-kern"]=true;}},addGradientFill=function(o,gradient,fill){o.attrs=o.attrs||{};var attrs=o.attrs,pow=Math.pow,opacity,oindex,type="linear",fxfy=".5 .5";o.attrs.gradient=gradient;gradient=Str(gradient).replace(R._radial_gradient,function(all,fx,fy){type="radial";if(fx&&fy){fx=toFloat(fx);fy=toFloat(fy);pow(fx-.5,2)+pow(fy-.5,2)>.25&&(fy=math.sqrt(.25-pow(fx-.5,2))*((fy>.5)*2-1)+.5);fxfy=fx+S+fy;}
return E;});gradient=gradient.split(/\s*\-\s*/);if(type=="linear"){var angle=gradient.shift();angle=-toFloat(angle);if(isNaN(angle)){return null;}}
var dots=R._parseDots(gradient);if(!dots){return null;}
o=o.shape||o.node;if(dots.length){o.removeChild(fill);fill.on=true;fill.method="none";fill.color=dots[0].color;fill.color2=dots[dots.length-1].color;var clrs=[];for(var i=0,ii=dots.length;i<ii;i++){dots[i].offset&&clrs.push(dots[i].offset+S+dots[i].color);}
fill.colors=clrs.length?clrs.join():"0% "+fill.color;if(type=="radial"){fill.type="gradientTitle";fill.focus="100%";fill.focussize="0 0";fill.focusposition=fxfy;fill.angle=0;}else{fill.type="gradient";fill.angle=(270-angle)%360;}
o.appendChild(fill);}
return 1;},Element=function(node,vml){this[0]=this.node=node;node.raphael=true;this.id=R._oid++;node.raphaelid=this.id;this.X=0;this.Y=0;this.attrs={};this.paper=vml;this.matrix=R.matrix();this._={transform:[],sx:1,sy:1,dx:0,dy:0,deg:0,dirty:1,dirtyT:1};!vml.bottom&&(vml.bottom=this);this.prev=vml.top;vml.top&&(vml.top.next=this);vml.top=this;this.next=null;};var elproto=R.el;Element.prototype=elproto;elproto.constructor=Element;elproto.transform=function(tstr){if(tstr==null){return this._.transform;}
var vbs=this.paper._viewBoxShift,vbt=vbs?"s"+[vbs.scale,vbs.scale]+"-1-1t"+[vbs.dx,vbs.dy]:E,oldt;if(vbs){oldt=tstr=Str(tstr).replace(/\.{3}|\u2026/g,this._.transform||E);}
R._extractTransform(this,vbt+tstr);var matrix=this.matrix.clone(),skew=this.skew,o=this.node,split,isGrad=~Str(this.attrs.fill).indexOf("-"),isPatt=!Str(this.attrs.fill).indexOf("url(");matrix.translate(1,1);if(isPatt||isGrad||this.type=="image"){skew.matrix="1 0 0 1";skew.offset="0 0";split=matrix.split();if((isGrad&&split.noRotation)||!split.isSimple){o.style.filter=matrix.toFilter();var bb=this.getBBox(),bbt=this.getBBox(1),dx=bb.x-bbt.x,dy=bb.y-bbt.y;o.coordorigin=(dx*-zoom)+S+(dy*-zoom);setCoords(this,1,1,dx,dy,0);}else{o.style.filter=E;setCoords(this,split.scalex,split.scaley,split.dx,split.dy,split.rotate);}}else{o.style.filter=E;skew.matrix=Str(matrix);skew.offset=matrix.offset();}
oldt&&(this._.transform=oldt);return this;};elproto.rotate=function(deg,cx,cy){if(this.removed){return this;}
if(deg==null){return;}
deg=Str(deg).split(separator);if(deg.length-1){cx=toFloat(deg[1]);cy=toFloat(deg[2]);}
deg=toFloat(deg[0]);(cy==null)&&(cx=cy);if(cx==null||cy==null){var bbox=this.getBBox(1);cx=bbox.x+bbox.width/2;cy=bbox.y+bbox.height/2;}
this._.dirtyT=1;this.transform(this._.transform.concat([["r",deg,cx,cy]]));return this;};elproto.translate=function(dx,dy){if(this.removed){return this;}
dx=Str(dx).split(separator);if(dx.length-1){dy=toFloat(dx[1]);}
dx=toFloat(dx[0])||0;dy=+dy||0;if(this._.bbox){this._.bbox.x+=dx;this._.bbox.y+=dy;}
this.transform(this._.transform.concat([["t",dx,dy]]));return this;};elproto.scale=function(sx,sy,cx,cy){if(this.removed){return this;}
sx=Str(sx).split(separator);if(sx.length-1){sy=toFloat(sx[1]);cx=toFloat(sx[2]);cy=toFloat(sx[3]);isNaN(cx)&&(cx=null);isNaN(cy)&&(cy=null);}
sx=toFloat(sx[0]);(sy==null)&&(sy=sx);(cy==null)&&(cx=cy);if(cx==null||cy==null){var bbox=this.getBBox(1);}
cx=cx==null?bbox.x+bbox.width/2:cx;cy=cy==null?bbox.y+bbox.height/2:cy;this.transform(this._.transform.concat([["s",sx,sy,cx,cy]]));this._.dirtyT=1;return this;};elproto.hide=function(){!this.removed&&(this.node.style.display="none");return this;};elproto.show=function(){!this.removed&&(this.node.style.display=E);return this;};elproto._getBBox=function(){if(this.removed){return{};}
return{x:this.X+(this.bbx||0)-this.W/2,y:this.Y-this.H,width:this.W,height:this.H};};elproto.remove=function(){if(this.removed||!this.node.parentNode){return;}
this.paper.__set__&&this.paper.__set__.exclude(this);R.eve.unbind("raphael.*.*."+this.id);R._tear(this,this.paper);this.node.parentNode.removeChild(this.node);this.shape&&this.shape.parentNode.removeChild(this.shape);for(var i in this){this[i]=typeof this[i]=="function"?R._removedFactory(i):null;}
this.removed=true;};elproto.attr=function(name,value){if(this.removed){return this;}
if(name==null){var res={};for(var a in this.attrs)if(this.attrs[has](a)){res[a]=this.attrs[a];}
res.gradient&&res.fill=="none"&&(res.fill=res.gradient)&&delete res.gradient;res.transform=this._.transform;return res;}
if(value==null&&R.is(name,"string")){if(name==fillString&&this.attrs.fill=="none"&&this.attrs.gradient){return this.attrs.gradient;}
var names=name.split(separator),out={};for(var i=0,ii=names.length;i<ii;i++){name=names[i];if(name in this.attrs){out[name]=this.attrs[name];}else if(R.is(this.paper.customAttributes[name],"function")){out[name]=this.paper.customAttributes[name].def;}else{out[name]=R._availableAttrs[name];}}
return ii-1?out:out[names[0]];}
if(this.attrs&&value==null&&R.is(name,"array")){out={};for(i=0,ii=name.length;i<ii;i++){out[name[i]]=this.attr(name[i]);}
return out;}
var params;if(value!=null){params={};params[name]=value;}
value==null&&R.is(name,"object")&&(params=name);for(var key in params){eve("raphael.attr."+key+"."+this.id,this,params[key]);}
if(params){for(key in this.paper.customAttributes)if(this.paper.customAttributes[has](key)&&params[has](key)&&R.is(this.paper.customAttributes[key],"function")){var par=this.paper.customAttributes[key].apply(this,[].concat(params[key]));this.attrs[key]=params[key];for(var subkey in par)if(par[has](subkey)){params[subkey]=par[subkey];}}
if(params.text&&this.type=="text"){this.textpath.string=params.text;}
setFillAndStroke(this,params);}
return this;};elproto.toFront=function(){!this.removed&&this.node.parentNode.appendChild(this.node);this.paper&&this.paper.top!=this&&R._tofront(this,this.paper);return this;};elproto.toBack=function(){if(this.removed){return this;}
if(this.node.parentNode.firstChild!=this.node){this.node.parentNode.insertBefore(this.node,this.node.parentNode.firstChild);R._toback(this,this.paper);}
return this;};elproto.insertAfter=function(element){if(this.removed){return this;}
if(element.constructor==R.st.constructor){element=element[element.length-1];}
if(element.node.nextSibling){element.node.parentNode.insertBefore(this.node,element.node.nextSibling);}else{element.node.parentNode.appendChild(this.node);}
R._insertafter(this,element,this.paper);return this;};elproto.insertBefore=function(element){if(this.removed){return this;}
if(element.constructor==R.st.constructor){element=element[0];}
element.node.parentNode.insertBefore(this.node,element.node);R._insertbefore(this,element,this.paper);return this;};elproto.blur=function(size){var s=this.node.runtimeStyle,f=s.filter;f=f.replace(blurregexp,E);if(+size!==0){this.attrs.blur=size;s.filter=f+S+ms+".Blur(pixelradius="+(+size||1.5)+")";s.margin=R.format("-{0}px 0 0 -{0}px",round(+size||1.5));}else{s.filter=f;s.margin=0;delete this.attrs.blur;}
return this;};R._engine.path=function(pathString,vml){var el=createNode("shape");el.style.cssText=cssDot;el.coordsize=zoom+S+zoom;el.coordorigin=vml.coordorigin;var p=new Element(el,vml),attr={fill:"none",stroke:"#000"};pathString&&(attr.path=pathString);p.type="path";p.path=[];p.Path=E;setFillAndStroke(p,attr);vml.canvas.appendChild(el);var skew=createNode("skew");skew.on=true;el.appendChild(skew);p.skew=skew;p.transform(E);return p;};R._engine.rect=function(vml,x,y,w,h,r){var path=R._rectPath(x,y,w,h,r),res=vml.path(path),a=res.attrs;res.X=a.x=x;res.Y=a.y=y;res.W=a.width=w;res.H=a.height=h;a.r=r;a.path=path;res.type="rect";return res;};R._engine.ellipse=function(vml,x,y,rx,ry){var res=vml.path(),a=res.attrs;res.X=x-rx;res.Y=y-ry;res.W=rx*2;res.H=ry*2;res.type="ellipse";setFillAndStroke(res,{cx:x,cy:y,rx:rx,ry:ry});return res;};R._engine.circle=function(vml,x,y,r){var res=vml.path(),a=res.attrs;res.X=x-r;res.Y=y-r;res.W=res.H=r*2;res.type="circle";setFillAndStroke(res,{cx:x,cy:y,r:r});return res;};R._engine.image=function(vml,src,x,y,w,h){var path=R._rectPath(x,y,w,h),res=vml.path(path).attr({stroke:"none"}),a=res.attrs,node=res.node,fill=node.getElementsByTagName(fillString)[0];a.src=src;res.X=a.x=x;res.Y=a.y=y;res.W=a.width=w;res.H=a.height=h;a.path=path;res.type="image";fill.parentNode==node&&node.removeChild(fill);fill.rotate=true;fill.src=src;fill.type="tile";res._.fillpos=[x,y];res._.fillsize=[w,h];node.appendChild(fill);setCoords(res,1,1,0,0,0);return res;};R._engine.text=function(vml,x,y,text){var el=createNode("shape"),path=createNode("path"),o=createNode("textpath");x=x||0;y=y||0;text=text||"";path.v=R.format("m{0},{1}l{2},{1}",round(x*zoom),round(y*zoom),round(x*zoom)+1);path.textpathok=true;o.string=Str(text);o.on=true;el.style.cssText=cssDot;el.coordsize=zoom+S+zoom;el.coordorigin="0 0";var p=new Element(el,vml),attr={fill:"#000",stroke:"none",font:R._availableAttrs.font,text:text};p.shape=el;p.path=path;p.textpath=o;p.type="text";p.attrs.text=Str(text);p.attrs.x=x;p.attrs.y=y;p.attrs.w=1;p.attrs.h=1;setFillAndStroke(p,attr);el.appendChild(o);el.appendChild(path);vml.canvas.appendChild(el);var skew=createNode("skew");skew.on=true;el.appendChild(skew);p.skew=skew;p.transform(E);return p;};R._engine.setSize=function(width,height){var cs=this.canvas.style;this.width=width;this.height=height;width==+width&&(width+="px");height==+height&&(height+="px");cs.width=width;cs.height=height;cs.clip="rect(0 "+width+" "+height+" 0)";if(this._viewBox){R._engine.setViewBox.apply(this,this._viewBox);}
return this;};R._engine.setViewBox=function(x,y,w,h,fit){R.eve("raphael.setViewBox",this,this._viewBox,[x,y,w,h,fit]);var width=this.width,height=this.height,size=1/mmax(w/width,h/height),H,W;if(fit){H=height/h;W=width/w;if(w*H<width){x-=(width-w*H)/2/H;}
if(h*W<height){y-=(height-h*W)/2/W;}}
this._viewBox=[x,y,w,h,!!fit];this._viewBoxShift={dx:-x,dy:-y,scale:size};this.forEach(function(el){el.transform("...");});return this;};var createNode;R._engine.initWin=function(win){var doc=win.document;doc.createStyleSheet().addRule(".rvml","behavior:url(#default#VML)");try{!doc.namespaces.rvml&&doc.namespaces.add("rvml","urn:schemas-microsoft-com:vml");createNode=function(tagName){return doc.createElement('<rvml:'+tagName+' class="rvml">');};}catch(e){createNode=function(tagName){return doc.createElement('<'+tagName+' xmlns="urn:schemas-microsoft.com:vml" class="rvml">');};}};R._engine.initWin(R._g.win);R._engine.create=function(){var con=R._getContainer.apply(0,arguments),container=con.container,height=con.height,s,width=con.width,x=con.x,y=con.y;if(!container){throw new Error("VML container not found.");}
var res=new R._Paper,c=res.canvas=R._g.doc.createElement("div"),cs=c.style;x=x||0;y=y||0;width=width||512;height=height||342;res.width=width;res.height=height;width==+width&&(width+="px");height==+height&&(height+="px");res.coordsize=zoom*1e3+S+zoom*1e3;res.coordorigin="0 0";res.span=R._g.doc.createElement("span");res.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;";c.appendChild(res.span);cs.cssText=R.format("top:0;left:0;width:{0};height:{1};display:inline-block;position:relative;clip:rect(0 {0} {1} 0);overflow:hidden",width,height);if(container==1){R._g.doc.body.appendChild(c);cs.left=x+"px";cs.top=y+"px";cs.position="absolute";}else{if(container.firstChild){container.insertBefore(c,container.firstChild);}else{container.appendChild(c);}}
res.renderfix=function(){};return res;};R.prototype.clear=function(){R.eve("raphael.clear",this);this.canvas.innerHTML=E;this.span=R._g.doc.createElement("span");this.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;display:inline;";this.canvas.appendChild(this.span);this.bottom=this.top=null;};R.prototype.remove=function(){R.eve("raphael.remove",this);this.canvas.parentNode.removeChild(this.canvas);for(var i in this){this[i]=typeof this[i]=="function"?R._removedFactory(i):null;}
return true;};var setproto=R.st;for(var method in elproto)if(elproto[has](method)&&!setproto[has](method)){setproto[method]=(function(methodname){return function(){var arg=arguments;return this.forEach(function(el){el[methodname].apply(el,arg);});};})(method);}})();oldRaphael.was?(g.win.Raphael=R):(Raphael=R);return R;}));
var RaphaelComponent=BaseComponent.extend({update:function(){var myself=this;this.customfunction.apply(myself,this.parameters?this.parameters:[]);}});
var SiteMapComponent=BaseComponent.extend({ph:undefined,selected:"UNUSEDPARAM!@#$",templates:{list:Mustache.compile("<ul class='siteMap siteMapLevel{{level}}' ></ul>"),item:Mustache.compile("<li class='siteMapItem {{classes}}''>"+"  <a {{#link}}href='{{link}}'{{/link}}>{{name}}</a>"+"</li>")},update:function(){var items=[],myself=this;if(typeof this.siteMapSelectedParameter!=="undefined"&&this.siteMapSelectedParameter!=""){this.selected=Dashboards.getParameterValue(this.siteMapSelectedParameter)}
this.ph=$("#"+this.htmlObject).empty();if(this.ajaxUrl){var opts={url:this.ajaxUrl}
if(_.isEmpty(this.parameters)){opts.data=Dashboards.propertiesArrayToObject(this.ajaxData);}
myself.fetchItems(opts,function(items){myself.renderList(myself.ph,items,0);});}else if(this.siteMapParameter){this.renderList(this.ph,Dashboards.getParameterValue(this.siteMapParameter),0);}
this.ph.find(".siteMapItem.siteMapSelected").parents(".siteMapItem").addClass("siteMapSelected");this.ph.find(".siteMapItem.siteMapInitial").parents(".siteMapItem").addClass("siteMapInitial");},fetchItems:function(overrides,callback){var myself=this;overrides=overrides||{};var ajaxOpts={type:'GET',success:function(json){callback(json);},dataType:'json',async:true};ajaxOpts=_.extend({},ajaxOpts,overrides);$.ajax(ajaxOpts);},renderList:function(ph,arr,level){var myself=this;var list=$(myself.templates.list({level:level}));$.each(arr,function(n,l){var item=$(myself.templates.item({name:l.name||l.id||"",link:l.link,classes:l.classes||""}));if(!l.link&&typeof l.action==="function"){item.find('a').click(function(){l.action(item);myself.ph.find(".siteMapItem.siteMapSelected").removeClass("siteMapSelected");$(this).parents(".siteMapItem").addClass("siteMapSelected");Dashboards.fireChange(myself.siteMapSelectedParameter,typeof l.id!=="undefined"?l.id:l.name);});}
if(typeof(l.id)!=="undefined"?l.id==myself.selected:l.name==myself.selected){item.addClass("siteMapSelected siteMapInitial");}
if(l.sublinks&&l.sublinks.length>0)
myself.renderList(item,l.sublinks,level+1);item.appendTo(list);});list.appendTo(ph);}});
var TextEditorComponent=BaseComponent.extend({$ph:undefined,$rightPanel:undefined,isRightPanelShown:false,isInitialized:false,externalEditor:undefined,defaultButtons:[{clazz:"save",label:"Save",callback:function(){this.save();if(typeof this.saveCallback==="function"){this.saveCallback();}}}],template:function(){return"<div class='textEditorComponent'><div class='textEditorControls'>"+"<div class='textEditorFile'><span class='fileLabel'>File: </span>{{file}}</div>"+"<div class='textEditorButtons'>{{#buttons}}<button class='{{clazz}}'>{{label}}</button>{{/buttons}}</div>"+"</div><div class='textEditorNotification'><span class='textEditorNotificationMsg'>Test</span></div>"+"<div class='textEditorRightPanel'></div>"+"<div class='textEditorIframeContainer'><div class='textEditorIframe'><iframe seamless='true' marginheight='0'></iframe></div>"+"</div>"},initialize:function(){Dashboards.log("Initializing TextEditorComponent")
this.isInitialized=true;if(this.htmlObject){this.$ph=$("#"+this.htmlObject);}
else{this.$ph=$("<div id='textEditorDefautlId'></div>").appendTo("body");}},update:function(){var myself=this;if(this.parameter){this.setFile(Dashboards.getParameterValue(this.parameter));}
if(!this.isInitialized){myself.initialize();}
this.isRightPanelShown=false;var buttons=this.getButtons();this.$ph.html(Mustache.render(this.template(),{file:this.file||"Unknown file",buttons:buttons}));this.$ph.find(".textEditorControls").on("click","button",function(){var $this=$(this);var idx=$this.prevAll("button").length;buttons[idx].callback(arguments);})
if(this.file){this.loadFile();}},getButtons:function(){var myself=this;var _extraButtons=this.extraButtons||[];_.chain(this.defaultButtons).each(function(b){b.callback=_.bind(b.callback,myself);})
return this.defaultButtons.concat(_extraButtons);},setFile:function(_file){this.file=_file;},getFile:function(){return this.file;},loadFile:function(){var myself=this;$('button.save',this.$ph).attr('disabled',true);this.externalEditor=$('iframe',this.$ph);var headerHeight=$('.textEditorControls',this.$ph).height()+$('.textEditorNotification',this.$ph).height();var editorHeight=this.$ph.height()-headerHeight-5;this.externalEditor.height(editorHeight);this.externalEditor.load(function()
{var editorEnv=myself.getEditorWindow();editorEnv.listeners.onStatusUpdate=myself.setDirty;editorEnv.listeners.notify=function(msg,type){myself.notify(msg);}
$('#notifications').hide();});this.externalEditor.attr('src',"/pentaho"+wd.helpers.editor.getUrl()+'path='+this.file+'&theme=ace/theme/eclipse&editorOnly=true');},notify:function(msg,level){var $notifications=this.$ph.find(".textEditorNotificationMsg");$notifications.text(msg);$notifications.show().delay(4000).fadeOut('slow');},setDirty:function(isDirty){$('button.save',this.$ph).attr('disabled',!isDirty);},getEditorWindow:function(){return this.externalEditor[0].contentWindow;},save:function(){this.getEditorWindow().save();},getRightPanel:function(){return this.$ph.find(".textEditorRightPanel");},toggleRightPanel:function(){this.getRightPanel().toggle();this.isRightPanelShown=!this.isRightPanelShown;this.getEditorWindow().editor.getEditor().resize();return this.isRightPanelShown;}});var PopupTextEditorComponent=BaseComponent.extend({$ph:undefined,isInitialized:false,textEditor:undefined,textEditorPopupId:"popupTextEditorId",isQueryPreviewShown:false,testPromptPopup:undefined,$testPromptPopupObj:undefined,defaultButtons:[{clazz:"run",label:"Preview Test",callback:function(){this.runTest();}},{clazz:"previewQuery",label:"Query results",callback:function(){this.toggleQueryResults();}},{clazz:"close",label:"Close",callback:function(){this.hide();}}],initialize:function(){Dashboards.log("Initializing PopupTextEditorComponent")
this.isInitialized=true;this.$ph=$("#"+this.textEditorPopupId);if(this.$ph.length>0){Dashboards.log("[PopupTextEditorComponent] Unexpected - Found an element with id "+this.popupTextEditorDefautlId)}
else{this.$ph=$("<div id='"+this.textEditorPopupId+"'></div>").appendTo("body");}
this.textEditor={name:"popupInnerTextEditorComponent",type:"textEditor",file:undefined,htmlObject:this.textEditorPopupId,extraButtons:this.getButtons(),saveCallback:this.saveCallback};Dashboards.addComponents([this.textEditor]);},update:function(){var myself=this;this.isQueryPreviewShown=false;if(!this.isInitialized){myself.initialize();}
this.textEditor.update();},show:function(){this.$ph.find(">div.textEditorComponent").height($(window).height());this.$ph.slideDown();},hide:function(){this.$ph.slideUp();},runTest:function(){var env=this.setupEnvironment();if(env){var test=this.getTestToOperate(env,this.runTestCallback,$("button.previewQuery",this.$ph));}},runTestCallback:function(env,test){var myself=this;this.textEditor.notify("Running test...");env.cdv.runTest(test,{callback:function(result){myself.textEditor.notify(result.getTestResultDescription());}});},toggleQueryResults:function(){if(this.isQueryPreviewShown){this.isQueryPreviewShown=this.textEditor.toggleRightPanel();return;}
var env=this.setupEnvironment();if(env){var test=this.getTestToOperate(env,this.toggleQueryResultsCallback,$("button.run",this.$ph));}},toggleQueryResultsCallback:function(env,test){var myself=this;this.textEditor.notify("Running query...");env.cdv.executeQuery(test,null,function(test,opts,queryResult){myself.textEditor.notify("Queries ran in "+queryResult.duration+"ms");myself.textEditor.getRightPanel().html("<pre>"+JSON.stringify(queryResult.resultset,undefined,2)+"</pre>");myself.isQueryPreviewShown=myself.textEditor.toggleRightPanel();wd.log("Toggling!");});},getButtons:function(){var myself=this;var _extraButtons=this.extraButtons||[];_.chain(this.defaultButtons).each(function(b){b.callback=_.bind(b.callback,myself);})
return this.defaultButtons.concat(_extraButtons);},setFile:function(_file){this.file=_file;this.textEditor.setFile(_file);},setupEnvironment:function(){var src=this.textEditor.getEditorWindow().editor.getContents();var mask={cdv:wd.cdv.cdv({isServerSide:false})};for(p in this)
mask[p]=undefined;try{(new Function("with(this) { "+src+"}")).call(mask);}
catch(err){alert(err);return null;}
return mask;},getTestToOperate:function(env,operationCallback,target){var myself=this;var flattenedTests=env.cdv.listTestsFlatten().sort(function(a,b){return(a.group+a.name)>=(b.group+b.name)});if(flattenedTests.length==1){operationCallback.call(myself,env,env.cdv.getTest(flattenedTests[0].group,flattenedTests[0].name));return;}
if(!this.testPromptPopup){this.testPromptPopup={name:"testPromptPopup",type:"popup",htmlObject:'testPromptPopupObj',gravity:"S",draggable:false,closeOnClickOutside:true}
this.$testPromptPopupObj=$("<div id='testPromptPopupObj'></div>").appendTo("body");Dashboards.addComponents([this.testPromptPopup]);this.testPromptPopup.update();this.$testPromptPopupObj.parent("div.popupComponent").addClass("testPromptPopup");}
var template='<div class="testChooserWrapper"><div class="title">Multiple tests found. Choose the one you want:</div>'+'<div class="testChooserButtons">{{#tests}}<button> {{group}} - {{name}}</button>{{/tests}}</div></div>'
this.$testPromptPopupObj.html(Mustache.render(template,{tests:flattenedTests}));this.$testPromptPopupObj.off("click","button");this.$testPromptPopupObj.on("click","button",function(evt){var idx=$(this).prevAll("button").length;operationCallback.call(myself,env,env.cdv.getTest(flattenedTests[idx].group,flattenedTests[idx].name));myself.testPromptPopup.hide();})
this.testPromptPopup.popup(target);return;}});
var CurrentVersionComponent=BaseComponent.extend({ph:null,update:function(){var self=this;this.ph=$('#'+this.htmlObject).empty();$.get(this.versionUrl,function(result){var msgHolder=$('<div/>').html(result);self.ph.append(msgHolder);});}});var VersionCheckComponent=BaseComponent.extend({ph:null,versionInfo:null,getMsgUpdate:function(url){return'You are currently running an outdated version. Please update to the new version <a href="'+url+'">here</a>.';},getMsgLatest:function(){return'Your version is up to date.';},getMsgInconclusive:function(msg,url){return'Only ctools branches support version checking '+(msg?'('+msg+') .':'.')+' You can install lastest version <a href="'+url+'">here</a>';},getMsgError:function(errorMsg){return'There was an error checking for newer versions: '+errorMsg;},update:function(){var self=this;this.ph=$("#"+this.htmlObject).empty();$.get(this.versionCheckUrl,function(result){if(!result){return;}
try{result=JSON.parse(result);console.log("[VERSION CHECK COMPONENT] ### json parsed with no errors ###");}catch(e){alert(e.message);}
self.versionInfo=result;var msg='';switch(result.result){case'update':msg=self.getMsgUpdate(result.downloadUrl);break;case'latest':msg=self.getMsgLatest();break;case'error':msg=self.getMsgError(result.msg);break;case'inconclusive':msg=self.getMsgInconclusive(result.msg,result.downloadUrl);break;}
var msgHolder=$('<div/>').html(msg);self.ph.append(msgHolder);});}});
var CurrentVersionComponent=BaseComponent.extend({ph:null,update:function(){var self=this;this.ph=$('#'+this.htmlObject).empty();$.get(this.versionUrl,function(result){var msgHolder=$('<div/>').html(result);self.ph.append(msgHolder);});}});var VersionCheckComponent=BaseComponent.extend({ph:null,versionInfo:null,getMsgUpdate:function(url){return'You are currently running an outdated version. Please update to the new version <a href="'+url+'">here</a>.';},getMsgLatest:function(){return'Your version is up to date.';},getMsgInconclusive:function(msg,url){return'Only ctools branches support version checking '+(msg?'('+msg+') .':'.')+' You can install lastest version <a href="'+url+'">here</a>';},getMsgError:function(errorMsg){return'There was an error checking for newer versions: '+errorMsg;},update:function(){var self=this;this.ph=$("#"+this.htmlObject).empty();$.get(this.versionCheckUrl,function(result){if(!result){return;}
try{result=JSON.parse(result);console.log("[VERSION CHECK COMPONENT] ### json parsed with no errors ###");}catch(e){alert(e.message);}
self.versionInfo=result;var msg='';switch(result.result){case'update':msg=self.getMsgUpdate(result.downloadUrl);break;case'latest':msg=self.getMsgLatest();break;case'error':msg=self.getMsgError(result.msg);break;case'inconclusive':msg=self.getMsgInconclusive(result.msg,result.downloadUrl);break;}
var msgHolder=$('<div/>').html(msg);self.ph.append(msgHolder);});}});
var AjaxRequestComponent=BaseComponent.extend({visible:false,update:function(){this.executeRequest(this);},parseXML:function(sText){if(!sText){return null;}
var xmlDoc;try{parser=new DOMParser();xmlDoc=parser.parseFromString(sText,"text/xml");return xmlDoc;}catch(e){try{xmlDoc=new ActiveXObject("Microsoft.XMLDOM");xmlDoc.async="false";xmlDoc.loadXML(sText);return xmlDoc;}catch(e){}}
alert('XML is invalid or no XML parser found');return null;},executeRequest:function(object){var myself=this;var url=object.url;var ajaxRequestType=object.ajaxRequestType;var params=object.parameters;var asyncCall=object.asyncCall;if(url==undefined){Dashboards.log("Fatal - No url passed","error");return;}
if(ajaxRequestType==undefined){ajaxRequestType="json";}
if(params!=undefined){var containsTime=false;for(var i=0;i<params.length;i++){var value;if(params[i][0]=='time'){value=new Date().getTime();containsTime=true;}
else value=Dashboards.getParameterValue(params[i][0]);params[i][1]=value;}
containsTime?params.push(['time',new Date().getTime()]):0;params=Dashboards.propertiesArrayToObject(params);}else{params={};}
if(asyncCall==undefined)asyncCall=true;$.ajax({url:url,type:"GET",dataType:ajaxRequestType,async:asyncCall,data:params,complete:function(XMLHttpRequest,textStatus){var values=XMLHttpRequest.responseText;var changedValues=undefined;if(values==undefined){Dashboards.log("Found error: Empty Data");return;}
if(this.dataType=="xml"||this.dataType=="html"){var xmlDoc;try{parser=new DOMParser();xmlDoc=parser.parseFromString(values,"text/xml");}catch(e){try{xmlDoc=new ActiveXObject("Microsoft.XMLDOM");xmlDoc.async="false";xmlDoc.loadXML(values);values=xmlDoc;}catch(e){Dashboards.log('XML is invalid or no XML parser found');}}
values=xmlDoc;var nodeList=values.getElementsByTagName('return');if(nodeList.length>0&&nodeList[0].firstChild){values=nodeList[0].firstChild.nodeValue;}
else return;values=$.parseJSON(values);}else if(this.dataType=="json"){values=$.parseJSON(values);}else if(this.dataType!="script"&&this.dataType!="text"){Dashboards.log("Found error: Unknown returned format");return;}
if((typeof(object.postFetch)=='function')){changedValues=object.postFetch(values);}
if(changedValues!=undefined){values=changedValues;}
if(object.resultvar!=undefined){Dashboards.fireChange(object.resultvar,values);}},error:function(XMLHttpRequest,textStatus,errorThrown){Dashboards.log("Found error: "+XMLHttpRequest+" - "+textStatus+", Error: "+errorThrown,"error");}});}});
var loadGoogleMaps=(function($){var now=$.now(),promise;return function(version,apiKey){if(promise){return promise;}
var deferred=$.Deferred(),resolve=function(){deferred.resolve(window.google&&google.maps?google.maps:false);},callbackName="loadGoogleMaps_"+(now++),params;if(window.google&&google.maps){resolve();}else if(window.google&&google.load){google.load("maps",version||3,{"other_params":"sensor=false","callback":resolve});}else{params=$.extend({'v':version||3,'sensor':false,'callback':callbackName},apiKey?{"key":apiKey}:{});window[callbackName]=function(){resolve();setTimeout(function(){try{delete window[callbackName];}catch(e){}},20);};$.ajax({dataType:'script',data:params,url:'http://maps.googleapis.com/maps/api/js'});}
promise=deferred.promise();return promise;};}(jQuery));
(function(){var geonames={name:"geonames",label:"GeoNames",defaults:{username:''},implementation:function(tgt,st,opt){var location;var name=st.address;var featureClass;if(!name){if(st.city){name=st.city;featureClass='P';}else if(st.county){name=st.county;featureClass='A';}else if(st.region){name=st.region;featureClass='A';}else if(st.state){name=st.state;featureClass='A';}else if(st.country){name=st.country;featureClass='A';}}
var url='http://ws.geonames.org/searchJSON';var data={q:name.replace(/&/g,","),maxRows:1,dataType:"json",username:opt.username,featureClass:featureClass};if(featureClass){data.featureClass=featureClass;}
var success=function(result){if(result.geonames&&result.geonames.length>0){location=[parseFloat(result.geonames[0].lng),parseFloat(result.geonames[0].lat)];st.continuationFunction(location);}};$.getJSON(url,data,success);}};Dashboards.registerAddIn("NewMapComponent","LocationResolver",new AddIn(geonames));var nominatim={name:"openstreetmap",label:"OpenStreetMap",defaults:{url:'http://nominatim.openstreetmap.org/search',serviceParams:{format:'json',limit:'1'},mapping:{'street':'street','postalcode':'postalcode','city':'city','county':'county','state':'state','country':'country'}},implementation:function(tgt,st,opt){if(st.latitude||st.longitude){var location=[parseFloat(st.longitude),parseFloat(st.latitude)];st.continuationFunction(location);return;}
var params=$.extend(true,{},opt.serviceParams);_.each(_.keys(st),function(key){if(_.isFunction(st[key])){return;}
var keyLower=key.toLowerCase();if(keyLower in opt.mapping){params[opt.mapping[keyLower]]=st[key];}else{}});if(params['q']){params={q:params['q']+', '+_.compact(_.map(opt.mapping,function(field){return params[field];})).join(', ')};}
var success=function(result){if(result&&result.length>0){var location=[parseFloat(result[0].lon),parseFloat(result[0].lat)];st.continuationFunction(location);}};$.getJSON(opt.url,$.extend({},opt.serviceParams,params),success);}};Dashboards.registerAddIn("NewMapComponent","LocationResolver",new AddIn(nominatim));var mapquest={};$.extend(true,mapquest,nominatim,{name:"mapquest",label:"MapQuest",defaults:{url:"http://open.mapquestapi.com/nominatim/v1/search"}});Dashboards.registerAddIn("NewMapComponent","LocationResolver",new AddIn(mapquest));var componentPath=Dashboards.getWebAppPath()+'/content/pentaho-cdf-dd/resources/custom/components/NewMapComponent';var urlMarker={name:"urlMarker",label:"Url Marker",defaults:{defaultUrl:componentPath+'/images/marker_grey.png',imagePath:componentPath+'/images/',images:['marker_grey.png','marker_blue.png','marker_grey02.png','marker_orange.png','marker_purple.png',]},implementation:function(tgt,st,opt){if(st.url)
return st.url;if(st.position){return opt.imagePath+opt.images[st.position%opt.images.length]||opt.defaultUrl;}
return opt.defaultUrl;}};Dashboards.registerAddIn("NewMapComponent","MarkerImage",new AddIn(urlMarker));var cggMarker={name:"cggMarker",label:"CGG Marker",defaults:{},implementation:function(tgt,st,opt){var url=wd.helpers.cggHelper.getCggDrawUrl()+'?script='+st.cggGraphName;var width=st.width;var height=st.height;var cggParameters={};if(st.width)cggParameters.width=st.width;if(st.height)cggParameters.height=st.height;cggParameters.noChartBg=true;for(parameter in st.parameters){cggParameters[parameter]=st.parameters[parameter];}
var level=Dashboards.debug;if(level>1){cggParameters.debug=true;cggParameters.debugLevel=level;}
for(parameter in cggParameters){if(cggParameters[parameter]!==undefined){url+="&param"+parameter+"="+encodeURIComponent(cggParameters[parameter]);}}
return url;}};Dashboards.registerAddIn("NewMapComponent","MarkerImage",new AddIn(cggMarker));})();
var MapEngine=Base.extend({tileServices:undefined,tileServicesOptions:undefined,tileLayer:function(name){},renderMap:function(){},setMarker:function(){},showPopup:function(){},setShape:function(polygonArray,shapeStyle,data){},postSetShapes:function(){},toNativeStyle:function(foreignStyle){var validStyle={};_.each(foreignStyle,function(value,key){switch(key){case'visible':case'zIndex':case'fillColor':case'fillOpacity':case'strokeColor':case'strokeOpacity':case'strokeWidth':}});return validStyle;},wrapEvent:function(event,featureType){return{latitude:undefined,longitude:undefined,data:undefined,feature:undefined,featureType:featureType,style:undefined,mapEngineType:'abstract',draw:function(style){},raw:undefined};},_selectUrl:function(paramString,urls){var product=1;var URL_HASH_FACTOR=(Math.sqrt(5)-1)/2;for(var i=0,len=paramString.length;i<len;i++){product*=paramString.charCodeAt(i)*URL_HASH_FACTOR;product-=Math.floor(product);}
return urls[Math.floor(product*urls.length)];},_switchUrl:function(url){var list=url.match(/(http[s]?:\/\/[0-9a-z.]*?)\{switch:([a-z0-9,]+)\}(.*)/);if(!list||list.length==0){return url;}
var servers=list[2].split(",");var url_list=[];for(var i=0;i<servers.length;i++){url_list.push(list[1]+servers[i]+list[3]);}
return url_list;},_getTileServiceURL:function(name){var urlTemplate=this.tileServices[name];if(!urlTemplate){if(name.length>0&&name.contains('{')){urlTemplate=name;}}
return urlTemplate;}});
function OurMapOverlay(startPoint,width,height,htmlContent,popupContentDiv,map,borderColor){this.startPoint_=startPoint;this.width_=width;this.height_=height;this.map_=map;this.htmlContent_=htmlContent;this.popupContentDiv_=popupContentDiv;this.borderColor_=borderColor;this.div_=null;this.setMap(map);}
var GoogleMapEngine=MapEngine.extend({map:undefined,centered:false,overlays:[],API_KEY:false,init:function(mapComponent,tilesets){this.tilesets=tilesets;this.mapComponent=mapComponent;$.when(loadGoogleMaps('3',this.API_KEY)).then(function(status){OurMapOverlay.prototype=new google.maps.OverlayView();OurMapOverlay.prototype.onAdd=function(){var div=document.createElement('DIV');div.id='MapOverlay';div.style.position="absolute";if(this.borderColor_){div.style.border='3px solid '+this.borderColor_;}else{div.style.border="none";}
if(this.popupContentDiv_&&this.popupContentDiv_.length>0){$(div).append($('#'+this.popupContentDiv_));}else
div.innerHTML=this.htmlContent_;this.div_=div;var panes=this.getPanes();panes.overlayLayer.appendChild(div);};OurMapOverlay.prototype.draw=function(){var overlayProjection=this.getProjection();var sp=overlayProjection.fromLatLngToDivPixel(this.startPoint_);var div=this.div_;div.style.left=sp.x+'px';div.style.top=(sp.y+30)+'px';div.style.width=this.width_+'px';div.style.height=this.height_+'px';};OurMapOverlay.prototype.onRemove=function(){if(this.popupContentDiv_){}
this.div_.style.display='none';};mapComponent.initCallBack();});},toNativeStyle:function(foreignStyle){var validStyle={};_.each(foreignStyle,function(value,key){switch(key){case'strokeWidth':validStyle['strokeWeight']=value;break;case'zIndex':case'visible':case'fillColor':case'fillOpacity':case'strokeColor':case'strokeOpacity':validStyle[key]=value;}});return validStyle;},wrapEvent:function(event,feature,featureType,featureStyle,data,marker){var myself=this;return{latitude:event.latLng.lat(),longitude:event.latLng.lng(),data:data,feature:feature,featureType:featureType,style:_.clone(featureStyle),marker:feature.marker,mapEngineType:'google3',draw:function(style){var validStyle=myself.toNativeStyle(style);feature.setOptions(validStyle);feature.setVisible(false);feature.setVisible(_.has(style,'visible')?!!style.visible:true);},raw:event};},setShape:function(multiPolygon,shapeStyle,data){var myself=this;var shapes=[];_.each(multiPolygon,function(polygon){var polygonGM=_.map(polygon,function(ring){return _.map(ring,function(latlong){return new google.maps.LatLng(latlong[0],latlong[1]);});});var shape=new google.maps.Polygon(_.extend({paths:polygonGM},myself.toNativeStyle(shapeStyle)));shape.setMap(myself.map);shapes.push(shape);google.maps.event.addListener(shape,'click',function(event){_.each(shapes,function(s){myself.mapComponent.trigger('shape:click',myself.wrapEvent(event,s,'shape',shapeStyle,data));});});google.maps.event.addListener(shape,'mousemove',function(event){_.each(shapes,function(s){myself.mapComponent.trigger('shape:mouseover',myself.wrapEvent(event,s,'shape',shapeStyle,data));});});google.maps.event.addListener(shape,'mouseout',function(event){_.each(shapes,function(s){myself.mapComponent.trigger('shape:mouseout',myself.wrapEvent(event,s,'shape',shapeStyle,data));});});});},postSetShapes:function(){},setMarker:function(lon,lat,icon,description,data,markerWidth,markerHeight,markerInfo){var myLatLng=new google.maps.LatLng(lat,lon);var image=new google.maps.MarkerImage(icon,new google.maps.Size(markerWidth,markerHeight),new google.maps.Point(0,0),new google.maps.Point(0,0));var marker=new google.maps.Marker({marker:markerInfo,position:myLatLng,map:this.map,icon:image,title:description});var myself=this;google.maps.event.addListener(marker,'click',function(e){myself.mapComponent.trigger('marker:click',myself.wrapEvent(e,marker,'marker',markerInfo,data));});if(!this.centered)
this.map.setCenter(myLatLng);},renderMap:function(target,centerLongitude,centerLatitude,zoomLevel){var myself=this;var latlng;if(centerLatitude&&centerLatitude!=''&&centerLongitude&&centerLongitude!=''){latlng=new google.maps.LatLng(centerLatitude,centerLongitude);this.centered=true;}else
latlng=new google.maps.LatLng(38.471,-9.15);if(!zoomLevel)zoomLevel=2;var myOptions={zoom:zoomLevel,center:latlng,mapTypeId:google.maps.MapTypeId.ROADMAP};var layers=[],layerIds=[],layerOptions=[];for(var k=0;k<this.tilesets.length;k++){var thisTileset=this.tilesets[k].slice(0),tileset=thisTileset.slice(0).split('-')[0],variant=thisTileset.slice(0).split('-').slice(1).join('-')||'default';layerIds.push(thisTileset);layerOptions.push(_.extend(myOptions,{mapTypeId:thisTileset}));if(this.tileServices[thisTileset]){layers.push(this.tileLayer(thisTileset));}else{layers.push('');}}
this.map=new google.maps.Map(target,{mapTypeControlOptions:{mapTypeIds:layerIds.concat(_.values(google.maps.MapTypeId))}});for(k=0;k<layers.length;k++){if(!_.isEmpty(layers[k])){this.map.mapTypes.set(layerIds[k],layers[k]);this.map.setMapTypeId(layerIds[k]);this.map.setOptions(layerOptions[k]);}}},tileLayer:function(name){var options=_.extend({tileSize:new google.maps.Size(256,256),minZoom:1,maxZoom:19},this.tileServicesOptions[name]||{});var urlList=this._switchUrl(this._getTileServiceURL(name));var myself=this;return new google.maps.ImageMapType(_.defaults({name:name.indexOf('/')>=0?'custom':name,getTileUrl:function(coord,zoom){var limit=Math.pow(2,zoom);if(coord.y<0||coord.y>=limit){return'404.png';}else{coord.x=((coord.x%limit)+limit)%limit;var url;if(_.isArray(urlList)){url=urlList[(coord.x+coord.y+zoom)%urlList.length];var s=_.template('${z}/${x}/${y}',{x:coord.x,y:coord.y,z:zoom},{interpolate:/\$\{(.+?)\}/g});url=myself._selectUrl(s,urlList);}else{url=urlList;}
return _.template(url,{x:coord.x,y:coord.y,z:zoom},{interpolate:/\$\{(.+?)\}/g});}}},options));},showPopup:function(data,mapElement,popupHeight,popupWidth,contents,popupContentDiv,borderColor){var overlay=new OurMapOverlay(mapElement.getPosition(),popupWidth,popupHeight,contents,popupContentDiv,this.map,borderColor);$(this.overlays).each(function(i,elt){elt.setMap(null);});this.overlays.push(overlay);}});
var OpenLayersEngine=MapEngine.extend({map:undefined,markers:undefined,centered:false,useMercator:true,API_KEY:0,init:function(mapComponent,tilesets){this.tilesets=tilesets;this.mapComponent=mapComponent;Dashboards.log('Requested tilesets:'+JSON.stringify(tilesets),'debug');var contains=function(v){return _.some(tilesets,function(tileset){return tileset.search(v)>=0;});};if(contains('googleXXX')){$.when(loadGoogleMaps('3',this.API_KEY)).then(mapComponent.initCallBack);}else{mapComponent.initCallBack();}},setShape:function(multiPolygon,shapeStyle,data){var myself=this;var proj=new OpenLayers.Projection("EPSG:4326"),mapProj=this.map.getProjectionObject();var multiPolygonOL=_.map(multiPolygon,function(polygon){var polygonOL=_.map(polygon,function(ring){var linearRingOL=_.map(ring,function(latlong){var point=new OpenLayers.LonLat(latlong[1],latlong[0]).transform(proj,mapProj);return new OpenLayers.Geometry.Point(point.lon,point.lat);});return new OpenLayers.Geometry.LinearRing(linearRingOL);});return new OpenLayers.Geometry.Polygon(polygonOL);});var shape=new OpenLayers.Geometry.MultiPolygon(multiPolygonOL);var feature=new OpenLayers.Feature.Vector(shape,{data:data,style:shapeStyle},myself.toNativeStyle(shapeStyle));myself.shapes.addFeatures([feature]);},postSetShapes:function(){},toNativeStyle:function(foreignStyle){var validStyle={};_.each(foreignStyle,function(value,key){switch(key){case'visible':validStyle['display']=value?true:'none';break;case'zIndex':validStyle['graphicZIndex']=value;break;case'fillColor':case'fillOpacity':case'strokeColor':case'strokeOpacity':case'strokeWidth':validStyle[key]=value;}});return validStyle;},wrapEvent:function(event,featureType){var lastXy=this.map.getControlsByClass("OpenLayers.Control.MousePosition")[0].lastXy||{x:undefined,y:undefined};var coords=this.map.getLonLatFromPixel(lastXy).transform(this.map.getProjectionObject(),new OpenLayers.Projection('EPSG:4326'));var feature=event.feature.layer.getFeatureById(event.feature.id);var myself=this;return{latitude:coords.lat,longitude:coords.lon,data:event.feature.attributes.data,feature:feature,featureType:featureType,style:event.feature.attributes.style,marker:event.feature.attributes.marker,mapEngineType:'openlayers2',draw:function(style){var validStyle=myself.toNativeStyle(style);event.feature.layer.drawFeature(feature,validStyle);},raw:event};},setMarker:function(lon,lat,icon,description,data,markerWidth,markerHeight,markerInfo){var size=new OpenLayers.Size(markerWidth,markerHeight);var offset=new OpenLayers.Pixel(-(size.w/2),-size.h);var iconObj=new OpenLayers.Icon(icon,size,offset);var proj=new OpenLayers.Projection("EPSG:4326"),mapProj=this.map.getProjectionObject();var point=new OpenLayers.LonLat(lon,lat).transform(proj,mapProj);var marker=new OpenLayers.Geometry.Point(point.lon,point.lat);var style;var feature=new OpenLayers.Feature.Vector(marker,{data:data,style:style,marker:markerInfo},{externalGraphic:icon,graphicWidth:markerWidth,graphicHeight:markerHeight,fillOpacity:1});this.markers.addFeatures([feature]);if(!this.centered)
this.map.setCenter(point);},showPopup:function(data,mapElement,popupHeight,popupWidth,contents,popupContentDiv,borderColor){var feature=mapElement;if(popupContentDiv&&popupContentDiv.length>0){var div=$('<div>');div.append($('#'+popupContentDiv));contents=div.html();}
var name="featurePopup";if(borderColor!=undefined){name=name+borderColor.substring(1);}
var p=mapElement.geometry.getCentroid();feature.lonlat=new OpenLayers.LonLat(p.x,p.y);var popup=new OpenLayers.Popup.Anchored(name,feature.lonlat,new OpenLayers.Size(popupWidth,popupHeight),contents,null,true,null);feature.popup=popup;popup.feature=feature;$(this.map.popups).each(function(i,elt){elt.hide();});this.map.addPopup(popup,true);},renderMap:function(target,centerLongitude,centerLatitude,zoomLevel){Dashboards.log('Entered renderMap','debug');var myself=this;var useLayerControl=false;var customMap=false;var centerPoint;if(centerLongitude&&centerLongitude!=''&&centerLatitude&&centerLatitude!=''){if(this.useMercator){centerPoint=lonLatToMercator(new OpenLayers.LonLat(centerLongitude,centerLatitude));}else{centerPoint=new OpenLayers.LonLat(centerLongitude,centerLatitude);}}
this.map=new OpenLayers.Map(target,{maxExtent:new OpenLayers.Bounds(-20037508,-20037508,20037508,20037508),numZoomLevels:18,maxResolution:156543,units:'m',zoomDuration:10,displayProjection:new OpenLayers.Projection("EPSG:4326"),projection:"EPSG:900913",controls:[new OpenLayers.Control.Navigation(),new OpenLayers.Control.ZoomPanel(),new OpenLayers.Control.DragPan(),new OpenLayers.Control.PinchZoom(),new OpenLayers.Control.LayerSwitcher({'ascending':false}),new OpenLayers.Control.ScaleLine(),new OpenLayers.Control.KeyboardDefaults(),new OpenLayers.Control.MousePosition(),new OpenLayers.Control.Attribution(),new OpenLayers.Control.TouchNavigation()]});var myOptions={type:'png',transparent:'true',transitionEffect:'resize',displayOutsideMaxExtent:true};var layer;for(var k=0,m=this.tilesets.length;k<m;k++){var thisTileset=this.tilesets[k],tileset=this.tilesets[k].slice(0).split('-')[0],variant=this.tilesets[k].slice(0).split('-').slice(1).join('-')||'default';Dashboards.log('Tilesets: '+JSON.stringify(this.tilesets)+', handling now :'+thisTileset+', ie tileset '+tileset+', variant '+variant);switch(tileset){case'googleXXX':layer=new OpenLayers.Layer.Google("Google Streets",{visibility:true,version:'3'});break;case'opengeo':layer=new OpenLayers.Layer.WMS(thisTileset,"http://maps.opengeo.org/geowebcache/service/wms",{layers:variant,bgcolor:'#A1BDC4'},{wrapDateLine:true,transitionEffect:'resize'});break;default:layer=this.tileLayer(thisTileset);break;}
this.map.addLayer(layer);}
this.shapes=new OpenLayers.Layer.Vector('Shapes',{rendererOptions:{zIndexing:true}});this.shapes.styleMap=new OpenLayers.StyleMap({'default':{graphicZIndex:0},'select':{graphicZIndex:1}});this.markers=new OpenLayers.Layer.Vector("Markers");this.map.addLayers([this.shapes,this.markers]);this.setCallbacks();if(centerPoint){this.map.setCenter(centerPoint);this.centered=true;}else{this.map.setCenter(lonLatToMercator(new OpenLayers.LonLat(-9.15,38.46)));}
if(zoomLevel!='')
this.map.zoomTo(zoomLevel);Dashboards.log('NewMapComponent: exited renderMap','debug');this.postRenderMap();},postRenderMap:function(){},setCallbacks:function(){var myself=this;function event_relay(e){var prefix;if(e.feature.layer.name=="Shapes"){prefix='shape';}else{prefix='marker';}
var events={'featurehighlighted':'mouseover','featureunhighlighted':'mouseout','featureselected':'click'};if(events[e.type]){myself.mapComponent.trigger(prefix+':'+events[e.type],myself.wrapEvent(e));}}
var hoverCtrl=new OpenLayers.Control.SelectFeature([this.markers,this.shapes],{hover:true,highlightOnly:true,renderIntent:"temporary",eventListeners:{featurehighlighted:event_relay,featureunhighlighted:event_relay,featureselected:event_relay},outFeature:function(feature){if(this.hover){if(this.highlightOnly){if(feature._lastHighlighter==this.id){if(feature._prevHighlighter&&feature._prevHighlighter!=this.id){delete feature._lastHighlighter;var control=this.map.getControl(feature._prevHighlighter);if(control){control.highlight(feature);this.events.triggerEvent("featureunhighlighted",{feature:feature});}}else{this.unhighlight(feature);}}else{this.events.triggerEvent("featureunhighlighted",{feature:feature});;}}else{this.unselect(feature);}}}});this.map.addControl(hoverCtrl);hoverCtrl.activate();var clickCtrl=new OpenLayers.Control.SelectFeature([this.markers,this.shapes],{clickout:false});this.map.addControl(clickCtrl);clickCtrl.activate();this.markers.events.on({featurehighlighted:function(e){myself.mapComponent.trigger('marker:mouseover',myself.wrapEvent(e));},featureunhighlighted:function(e){myself.mapComponent.trigger('marker:mouseout',myself.wrapEvent(e));},featureselected:function(e){myself.mapComponent.trigger('marker:click',myself.wrapEvent(e));clickCtrl.unselectAll();}});this.shapes.events.on({featureselected:function(e){myself.mapComponent.trigger('shape:click',myself.wrapEvent(e));}})},tileLayer:function(name){var urlTemplate=this.tileServices[name];var options=_.extend({"transitionEffect":"resize"},this.tileServicesOptions[name]||{});if(!urlTemplate){if(name.length>0&&name.contains('{')){urlTemplate=name;name='custom';}}
return new OpenLayers.Layer.XYZ(name,this._switchUrl(urlTemplate),_.defaults({},options));}});
var NewMapComponent=(function(){var ShapeConversionMixin={parseShapeKey:undefined,getShapeFromKML:function(rawData){var myself=this,mymap={};var result=$(rawData).find('Placemark').each(function(idx,y){var key;if(_.isFunction(myself.parseShapeKey)){try{key=myself.parseShapeKey(y);}catch(e){key=$(y).find('name').text();}}else{key=$(y).find('name').text();}
var polygonArray=_.map($(y).find('Polygon'),function(yy){var polygon=[];_.each(['outerBoundaryIs','innerBoundaryIs'],function(b){var polygonObj=$(yy).find(b+' LinearRing coordinates');_.each(polygonObj,function(v){var s=$(v).text().trim();if(s.length>0){var p=_.map(s.split(' '),function(el){return _.map(el.split(',').slice(0,2),parseFloat).reverse();});polygon.push(p);}});});return polygon;});if(_.isEmpty(polygonArray)){return;}
if(!mymap[key]){mymap[key]=polygonArray;}});return mymap;},reducePoints:function(points,precision_m){if(precision_m<0){return points;}
function properRDP(points,epsilon){var firstPoint=points[0];var lastPoint=points[points.length-1];if(points.length<3){return points;}
var index=-1;var dist=0;for(var i=1;i<points.length-1;i++){var cDist=findPerpendicularDistance(points[i],firstPoint,lastPoint);if(cDist>dist){dist=cDist;index=i;}}
if(dist>epsilon){var l1=points.slice(0,index+1);var l2=points.slice(index);var r1=properRDP(l1,epsilon);var r2=properRDP(l2,epsilon);var rs=r1.slice(0,r1.length-1).concat(r2);return rs;}else{return[firstPoint,lastPoint];}}
function findPerpendicularDistance(p,p1,p2){var result;var slope;var intercept;if(p1[0]==p2[0]){result=Math.abs(p[0]-p1[0]);}else{slope=(p2[1]-p1[1])/(p2[0]-p1[0]);intercept=p1[1]-(slope*p1[0]);result=Math.abs(slope*p[0]-p[1]+intercept)/Math.sqrt(Math.pow(slope,2)+1);}
return result;}
return properRDP(points,precision_m/6.3e6);},exportShapeDefinition:function(){if(this.shapeDefinition){window.open("data:text/json;charset=utf-8,"+escape(JSON.stringify(this.shapeDefinition)));}}};var ColorMapMixin={colormap:[[0,102,0,255],[255,255,0,255],[255,0,0,255]],colormaps:{'jet':[],'gray':[[0,0,0,255],[255,255,255,255]],'french-flag':[[255,0,0,255],[255,254,255,255],[0,0,255,255]]},getColorMap:function(){var interpolate=function(a,b,n){var c=[],d=[];var k,kk,step;for(k=0;k<a.length;k++){c[k]=[];for(kk=0,step=(b[k]-a[k])/n;kk<n;kk++){c[k][kk]=a[k]+kk*step;}}
for(k=0;k<c[0].length;k++){d[k]=[];for(kk=0;kk<c.length;kk++){d[k][kk]=Math.round(c[kk][k]);}}
return d;};var cmap=[];for(k=1;k<this.colormap.length;k++)
{cmap=cmap.concat(interpolate(this.colormap[k-1],this.colormap[k],32));}
return _.map(cmap,function(v){return'rgba('+v.join(',')+')';});},mapColor:function(value,minValue,maxValue,colormap){var n=colormap.length;var level=(value-minValue)/(maxValue-minValue);return colormap[Math.floor(level*(n-1))];}};var MyClass=UnmanagedComponent.extend(ShapeConversionMixin).extend(ColorMapMixin).extend({ph:undefined,mapEngine:undefined,values:undefined,locationResolver:undefined,API_KEY:false,tileServices:{'default':"http://otile{switch:1,2,3,4}.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png",'apple':"http://gsp2.apple.com/tile?api=1&style=slideshow&layers=default&lang=en_US&z=${z}&x=${x}&y=${y}&v=9",'google':"http://mt{switch:0,1,2,3}.googleapis.com/vt?x=${x}&y=${y}&z=${z}",'mapquest':"http://otile{switch:1,2,3,4}.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png",'mapquest-normal':"http://otile{switch:1,2,3,4}.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png",'mapquest-hybrid':"http://otile{switch:1,2,3,4}.mqcdn.com/tiles/1.0.0/hyb/${z}/${x}/${y}.png",'mapquest-sat':"http://otile{switch:1,2,3,4}.mqcdn.com/tiles/1.0.0/sat/${z}/${x}/${y}.jpg",'mapbox-world-light':"https://{switch:a,b,c,d}.tiles.mapbox.com/v3/mapbox.world-light/${z}/${x}/${y}.jpg",'mapbox-world-dark':"https://{switch:a,b,c,d}.tiles.mapbox.com/v3/mapbox.world-dark/${z}/${x}/${y}.jpg",'mapbox-terrain':'https://{switch:a,b,c,d}.tiles.mapbox.com/v3/examples.map-9ijuk24y/${z}/${x}/${y}.jpg','mapbox-satellite':'https://{switch:a,b,c,d}.tiles.mapbox.com/v3/examples.map-qfyrx5r8/${z}/${x}/${y}.png','mapbox-example':'https://{switch:a,b,c,d}.tiles.mapbox.com/v3/examples.c7d2024a/${z}/${x}/${y}.png','mapbox-example2':'https://{switch:a,b,c,d}.tiles.mapbox.com/v3/examples.bc17bb2a/${z}/${x}/${y}.png','openstreetmaps':"http://{switch:a,b,c}.tile.openstreetmap.org/${z}/${x}/${y}.png",'openmapsurfer':'http://129.206.74.245:8001/tms_r.ashx?x=${x}&y=${y}&z=${z}','openmapsurfer-roads':'http://129.206.74.245:8001/tms_r.ashx?x=${x}&y=${y}&z=${z}','openmapsurfer-semitransparent':'http://129.206.74.245:8003/tms_h.ashx?x=${x}&y=${y}&z=${z}','openmapsurfer-hillshade':'http://129.206.74.245:8004/tms_hs.ashx?x=${x}&y=${y}&z=${z}','openmapsurfer-contour':'http://129.206.74.245:8006/tms_b.ashx?x=${x}&y=${y}&z=${z}','openmapsurfer-administrative':'http://129.206.74.245:8007/tms_b.ashx?x=${x}&y=${y}&z=${z}','openmapsurfer-roads-grayscale':'http://129.206.74.245:8008/tms_rg.ashx?x=${x}&y=${y}&z=${z}','stamen':"http://{switch:a,b,c,d}.tile.stamen.com/terrain/${z}/${x}/${y}.jpg",'stamen-terrain':"http://{switch:a,b,c,d}.tile.stamen.com/terrain/${z}/${x}/${y}.jpg",'stamen-terrain-background':"http://{switch:a,b,c,d}.tile.stamen.com/terrain-background/${z}/${x}/${y}.jpg",'stamen-terrain-labels':"http://{switch:a,b,c,d}.tile.stamen.com/terrain-labels/${z}/${x}/${y}.jpg",'stamen-toner':"http://{switch:a,b,c,d}.tile.stamen.com/toner/${z}/${x}/${y}.png",'stamen-toner-lite':"http://{switch:a,b,c,d}.tile.stamen.com/toner-lite/${z}/${x}/${y}.png",'stamen-toner-background':"http://{switch:a,b,c,d}.tile.stamen.com/toner-background/${z}/${x}/${y}.png",'stamen-toner-hybrid':"http://{switch:a,b,c,d}.tile.stamen.com/toner-hybrid/${z}/${x}/${y}.png",'stamen-toner-labels':"http://{switch:a,b,c,d}.tile.stamen.com/toner-labels/${z}/${x}/${y}.png",'stamen-toner-lines':"http://{switch:a,b,c,d}.tile.stamen.com/toner-lines/${z}/${x}/${y}.png",'stamen-toner-2010':"http://{switch:a,b,c,d}.tile.stamen.com/toner-2010/${z}/${x}/${y}.png",'stamen-toner-2011':"http://{switch:a,b,c,d}.tile.stamen.com/toner-2011/${z}/${x}/${y}.png",'stamen-watercolor':"http://{switch:a,b,c,d}.tile.stamen.com/watercolor/${z}/${x}/${y}.jpg",'nokia-normal':'http://maptile.maps.svc.ovi.com/maptiler/maptile/newest/normal.day/${z}/${x}/${y}/256/png8','nokia-normal-grey':'http://maptile.maps.svc.ovi.com/maptiler/maptile/newest/normal.day.grey/${z}/${x}/${y}/256/png8','nokia-normal-transit':'http://maptile.maps.svc.ovi.com/maptiler/maptile/newest/normal.day.transit/${z}/${x}/${y}/256/png8','nokia-satellite':'http://maptile.maps.svc.ovi.com/maptiler/maptile/newest/satellite.day/${z}/${x}/${y}/256/png8','nokia-terrain':'http://maptile.maps.svc.ovi.com/maptiler/maptile/newest/terrain.day/${z}/${x}/${y}/256/png8','arcgis-street':'http://services.arcgisonline.com/ArcGIS/rest/services/World_street_Map/MapServer/tile/${z}/${y}/${x}','arcgis-topographic':'http://services.arcgisonline.com/ArcGIS/rest/services/World_street_Topo/MapServer/tile/${z}/${y}/${x}','arcgis-natgeo':'http://services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/${z}/${y}/${x}','arcgis-world':'http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${z}/${y}/${x}','arcgis-lightgray':'http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/${z}/${y}/${x}','arcgis-delorme':'http://services.arcgisonline.com/ArcGIS/rest/services/Specialty/DeLorme_World_Base_Map/MapServer/tile/${z}/${y}/${x}'},otherTileServices:[],tileServicesOptions:{'apple':{minZoom:3,maxZoom:14}},update:function(){this.registerEvents();if(_.isString(this.tilesets)){this.tilesets=[this.tilesets];}
if(this.testData){this.render(this.testData);return;}
Dashboards.log('Starting clock of '+this.htmlObject,'debug');this.clock=(new Date());if(this.queryDefinition&&!$.isEmptyObject(this.queryDefinition)){if((this.mapMode=="shapes")&&(!_.isEmpty(this.shapeSource))){this.load_deferred();}else{this.triggerQuery(this.queryDefinition,_.bind(this.render,this));}}else{this.synchronous(_.bind(this.render,this),{});}},dataRequest:function(url,callback){return $.ajax(url,{async:true,type:'GET',processData:url.endsWith('json')}).then(callback);},load_deferred_hack:function(){var myself=this;var deferredQuery=function(){var _deferredQuery=$.Deferred(),myself=this;this.triggerQuery(this.queryDefinition,function(data){_deferredQuery.resolve(data);});return _deferredQuery.promise();};return $.when(this.dataRequest(this.shapeSource),deferredQuery()).done(function(shapes,resultset){myself.processShapeDefinition(shapes,function(){});myself.render(resultset);});},load_deferred:function(){var myself=this;if(!this.preExec()){return null;}
var deferreds=[this.dataRequest(myself.shapeSource,_.bind(this.processShapeDefinition,this))];if(this.mapEngine=='google'){deferreds.push(loadGoogleMaps('3',this.API_KEY));}
return this.deferredTriggerQuery(this.queryDefinition,deferreds,function(resultset){myself.render(resultset);});},deferredTriggerQuery:function(queryDef,deferreds,callback,userQueryOptions){var silent=this.isSilent();if(!silent){this.block();};userQueryOptions=userQueryOptions||{};var success=_.bind(function(data){return data;},this);var always=_.bind(function(){if(!silent){this.unblock();}},this);this.getDeferredSuccessHandler=function(success){var counter=this.callCounter();return _.bind(function(data){var newData,result;if(counter>=this.runCounter){try{if(typeof this.postFetch=="function"){newData=this.postFetch(data);this.trigger('cdf cdf:postFetch',this,data);data=typeof newData=="undefined"?data:newData;}
result=success(data);}catch(e){this.error(Dashboards.getErrorObj('COMPONENT_ERROR').msg,e);this.dashboard.log(e,"error");}}
return result;},this);};var querySuccess=this.getDeferredSuccessHandler(success);var queryError=this.getErrorHandler();var query=this.queryState=this.query=Dashboards.getQuery(queryDef);var ajaxOptions={async:true};if(userQueryOptions.ajax){_.extend(ajaxOptions,userQueryOptions.ajax);}
query.setAjaxOptions(ajaxOptions);if(userQueryOptions.pageSize){query.setPageSize(userQueryOptions.pageSize);}
var myself=this;var launchQuery=function(){var _deferredQuery=$.Deferred();query.fetchData(myself.parameters,function(){var data=querySuccess.apply(myself,arguments);var processedArgs=_.extend([],arguments);processedArgs[0]=data;_deferredQuery.resolve.apply(myself,processedArgs);},function(){queryError.apply(myself,arguments);_deferredQuery.reject();});return _deferredQuery.promise().done(always);};var deferredSuccess=function(datasets){if(_.isFunction(callback)){callback(datasets);}
myself.postExec();};deferreds=deferreds||[];deferreds.unshift(launchQuery());return $.when.apply(null,deferreds).then(deferredSuccess);},triggerQuery:function(queryDef,callback,userQueryOptions){var myself=this;if(!this.preExec()){return;}
this.deferredTriggerQuery(this.queryDefinition,null,function(resultset){if(_.isFunction(callback)){callback(resultset);}});},load_sequential:function(){var myself=this;this.triggerQuery(this.queryDefinition,function(resultset){myself.getShapeDefinition(function(){myself.render(resultset);});});},getShapeDefinition:function(callback){Dashboards.log('NewMapComponent.getShapeDefinition: entered with arguments '+JSON.stringify(arguments),'debug');var myself=this;if(this.shapeSource&&!_.isEmpty(this.shapeSource)&&!this.shapeDefinition){var filetype=this.shapeSource.split('.').reverse()[0].toLowerCase();$.ajax(this.shapeSource,{async:true,type:'GET',processData:this.shapeSource.endsWith('json'),success:function(data){myself.processShapeDefinition(data,callback);}});}},processShapeDefinition:function(data,callback){var filetype=this.shapeSource.split('.').reverse()[0].toLowerCase();if(data){switch(filetype){case'kml':Dashboards.log('parsing shapes','debug');this.shapeDefinition=this.getShapeFromKML(data,this.parseShapeKey);break;case'json':this.shapeDefinition=data;break;}
if(_.isFunction(this.postProcessShape)){this.shapeDefinition=this.postProcessShape(this.shapeDefinition);}}
if(_.isFunction(callback)){Dashboards.log('NewMapComponent.processShapeDefinition: callback is a function','debug');callback(data);}},postProcessShape:function(shapeDefinition){return shapeDefinition;},render:function(values){Dashboards.log('Stopping clock at render in '+this.htmlObject+': took '+(new Date()-this.clock)+' ms','debug');if(this.shapeDefinition){Dashboards.log('Loaded '+_.keys(this.shapeDefinition).length+' shapes','debug');}
if(this.mapEngineType=='google'){this.mapEngine=new GoogleMapEngine();}else{this.mapEngine=new OpenLayersEngine();}
this.values=values;this.mapEngine.API_KEY=this.API_KEY||window.API_KEY;this.mapEngine.tileServices=this.tileServices;this.mapEngine.tileServicesOptions=this.tileServicesOptions;this.mapEngine.init(this,this.tilesets);},initCallBack:function(){this.ph=$('#'+this.htmlObject);var $popupDivHolder=$("#"+this.popupContentsDiv).clone();this.ph.empty();if(this.popupContentsDiv&&$("#"+this.popupContentsDiv).length!=1){this.ph.append($popupDivHolder.html("None"));}
this.mapEngine.renderMap(this.ph[0],this.centerLongitude,this.centerLatitude,this.defaultZoomLevel);switch(this.mapMode){case'shapes':this.setupShapes(this.values);break;case'markers':this.setupMarkers(this.values);break;}
Dashboards.log('Stopping clock: update cycle of '+this.htmlObject+' took '+(new Date()-this.clock)+' ms','debug');},registerEvents:function(){var myself=this;this.on('marker:click',function(event){var result;if(_.isFunction(this.markerClickFunction)){result=this.markerClickFunction(event);}
if(result!==false){this.markerClickCallback(event);}});this.on('shape:mouseover',function(event){if(_.isFunction(myself.shapeMouseOver)){var result=myself.shapeMouseOver(event);if(result){event.draw(_.defaults(result,{'zIndex':1},event.style));}}});this.on('shape:mouseout',function(event){var result={};if(_.isFunction(myself.shapeMouseOut)){result=myself.shapeMouseOut(event);}
if(event.feature==event.feature.layer.selectedFeatures[0]){event.draw(_.defaults(result,event.raw.feature.attributes.clickSelStyle));}else if(_.size(result)>0){event.draw(_.defaults(result,event.style));}else if(myself.shapeMouseOver){event.draw(event.style);}});this.on('shape:click',function(event){if(_.isFunction(myself.shapeMouseClick)){var result=myself.shapeMouseClick(event);if(result){var selStyle=_.defaults(result,event.style);event.raw.feature.attributes.clickSelStyle=selStyle;event.draw(selStyle);}}});},setupShapes:function(values){if(!this.shapeDefinition){return;}
if(!values||!values.resultset){return;}
var myself=this;var idxKey=0,idxValue=1;var shapeSettings=_.defaults(this.shapeSettings||{},{strokeWidth:2,strokeColor:'white',zIndex:0});var colormap=this.getColorMap();var qvalues=_.map(values.resultset,function(row){return row[idxValue];});var minValue=_.min(qvalues),maxValue=_.max(qvalues);$(values.resultset).each(function(i,elt){var fillColor=myself.mapColor(elt[idxValue],minValue,maxValue,colormap);myself.renderShape(myself.shapeDefinition[elt[idxKey]],_.defaults({fillColor:fillColor},shapeSettings),{rawData:elt,key:elt[idxKey],value:elt[idxValue],minValue:minValue,maxValue:maxValue});});this.mapEngine.postSetShapes(this);},renderShape:function(shapeDefinition,shapeSettings,data){this.mapEngine.setShape(shapeDefinition,shapeSettings,data);},setupMarkers:function(values){if(!values||!values.resultset)
return;var mapping=this.getMapping(values);var myself=this;$(values.resultset).each(function(i,elt){var location;if(mapping.addressType!='coordinates'){location=myself.getAddressLocation((mapping.address!=undefined?elt[mapping.address]:undefined),mapping.addressType,elt,mapping,i);}else{location=[elt[mapping.longitude],elt[mapping.latitude]];myself.renderMarker(location,elt,mapping,i);}});},renderMarker:function(location,elt,mapping,position){var myself=this;if(location===undefined){Dashboards.log('Unable to get location for address '+elt[mapping.address]+'. Ignoring element.','debug');return true;}
var markerIcon;var description;var markerWidth=myself.markerWidth;if(mapping.markerWidth){markerWidth=elt[mapping.markerWidth];}
var markerHeight=myself.markerHeight;if(mapping.markerHeight){markerHeight=elt[mapping.markerHeight];}
var defaultMarkers=false;if(mapping.marker){markerIcon=elt[mapping.marker];}
if(markerIcon==undefined){var st={data:elt,position:position};var addinName=this.markerImageGetter;if(this.markerCggGraph){st.cggGraphName=this.markerCggGraph;st.width=markerWidth;st.height=markerHeight;st.parameters={};$(this.cggGraphParameters).each(function(i,parameter){st.parameters[parameter[0]]=elt[mapping[parameter[1]]];});addinName='cggMarker';}else{st.url=myself.marker;defaultMarkers=(myself.marker==undefined);addinName='urlMarker';}
if(!addinName){addinName='urlMarker';}
var addIn=this.getAddIn("MarkerImage",addinName);markerIcon=addIn.call(this.ph,st,this.getAddInOptions("MarkerImage",addIn.name));}
if(mapping.description)description=elt[mapping.description];Dashboards.log('About to render '+location[0]+' / '+location[1]+' with marker '+marker+' sized '+markerHeight+' / '+markerWidth+'and description '+description,'debug');var markerInfo={longitude:location[0],latitude:location[1],defaultMarkers:defaultMarkers,position:position,mapping:mapping};myself.mapEngine.setMarker(location[0],location[1],markerIcon,description,elt,markerWidth,markerHeight,markerInfo);},markerClickCallback:function(event){var myself=this;var elt=event.data;var defaultMarkers=event.marker.defaultMarkers;var mapping=event.marker.mapping;var position=event.marker.position;$(this.popupParameters).each(function(i,eltA){Dashboards.fireChange(eltA[1],event.data[mapping[eltA[0].toLowerCase()]]);});if(this.popupContentsDiv||mapping.popupContents){var contents;if(mapping.popupContents)contents=elt[mapping.popupContents];var height=mapping.popupContentsHeight?elt[mapping.popupContentsHeight]:undefined;if(!height)height=this.popupHeight;var width=mapping.popupContentsWidth?elt[mapping.popupContentsWidth]:undefined;if(!width)width=this.popupWidth;var borderColor=undefined;if(defaultMarkers){var borderColors=["#394246","#11b4eb","#7a879a","#e35c15","#674f73"];borderColor=borderColors[position%5];}
this.mapEngine.showPopup(event.data,event.feature,height,width,contents,this.popupContentsDiv,borderColor);}},getAddressLocation:function(address,addressType,data,mapping,position){var addinName=this.locationResolver;if(!addinName)addinName='openstreetmap';var addIn=this.getAddIn("LocationResolver",addinName);var target=this.ph;var state={address:address,addressType:addressType,position:position};if(mapping.country!=undefined)state.country=data[mapping.country];if(mapping.city!=undefined)state.city=data[mapping.city];if(mapping.county!=undefined)state.county=data[mapping.county];if(mapping.region!=undefined)state.region=data[mapping.region];if(mapping.state!=undefined)state.state=data[mapping.state];var myself=this;state.continuationFunction=function(location){myself.renderMarker(location,data,mapping,position);};addIn.call(target,state,this.getAddInOptions("LocationResolver",addIn.getName()));},getMapping:function(values){var map={};if(!values.metadata||values.metadata.length==0)
return map;$(values.metadata).each(function(i,elt){switch(elt.colName.toLowerCase()){case'latitude':map.addressType='coordinates';map.latitude=i;break;case'longitude':map.addressType='coordinates';map.longitude=i;break;case'description':map.description=i;break;case'marker':map.marker=i;break;case'markerwidth':map.markerWidth=i;break;case'markerheight':map.markerHeight=i;break;case'popupcontents':map.popupContents=i;break;case'popupwidth':map.popupWidth=i;break;case'popupheight':map.popupHeight=i;break;case'address':if(!map.addressType){map.address=i;map.addressType='address';}
break;default:map[elt.colName.toLowerCase()]=i;break;}});return map;}});return MyClass;})();
var PopupComponent=BaseComponent.extend({ph:undefined,arrow:undefined,content:undefined,cancel:undefined,$overlay:undefined,popupClass:undefined,popupOverlayClass:undefined,update:function(){var myself=this;this.content=$("#"+this.htmlObject).detach();this.ph=this.ph?this.ph.empty():$('<div>').appendTo($('body'));this.content.appendTo(this.ph);this.ph.hide();this.ph.addClass('popupComponent');if(this.popupClass){this.ph.addClass(this.popupClass);}
this.cancel=$("<a>&nbsp;</a>");this.cancel.addClass("close").click(function(){myself.hide();});this.cancel.appendTo(this.ph);this.arrow=$("<div class='arrow'>").appendTo(this.ph);this.content.removeClass('hidePopup');},clone:function(params,comps,html){var that=this.base(params,comps,html);that.ph=this.ph.clone();that.ph.insertAfter(this.ph);that.ph.hide();that.ph.find("[id]").each(function(i,e){$e=$(e);var id=$e.attr("id");if(id&&id in html){$e.attr("id",html[id]);}else{$e.attr("id",id+'_'+Dashboards.duplicateIndex);}});return that;},popup:function(target,gravity){var pos=target.offset(),css={'top':'auto','bottom':'auto','left':'auto','right':'auto'},minimumDistance=20,vertexOffset=18-6,vertexSize=45,targetOffset,phHeight=this.ph.outerHeight(),phWidth=this.ph.outerWidth();gravity=gravity||this.gravity;var draggable=typeof this.draggable==="undefined"?true:this.draggable;if(this.horizontalScroll){$("#"+this.htmlObject).css("overflow-x","scroll");}
if(this.verticalScroll){$("#"+this.htmlObject).css("overflow-y","scroll");}
var closeOnClickOutside=typeof this.closeOnClickOutside==="undefined"?false:this.closeOnClickOutside;this.arrow.css({top:"",left:"",bottom:"",right:""});this.arrow.show();this.ph.removeClass('north south east west');var minWidth=minimumDistance,maxWidth=$(document).width()-minimumDistance,minHeight=minimumDistance,maxHeight=$(document).height()-minimumDistance,targetWidth,targetHeight,paddingNear,paddingFar;switch(gravity){case'N':paddingNear=parseInt(target.css('padding-top').replace(/(.*)px/,"$1"),10);css.left=this.center(target.outerWidth(),phWidth,pos.left,minWidth,maxWidth);targetHeight="ownerSVGElement"in target[0]?(target.attr("height")?target.attr("height")-0:0):target.height();targetOffset=pos.left-css.left-this.ph.css('border-top-width').replace(/(.*)px/,"$1");css.top=this.offset(targetHeight,phHeight,pos.top+paddingNear,vertexOffset,minHeight,maxHeight,'near');this.arrow.css('left',this.center(target.outerWidth(),vertexSize,targetOffset,0,phWidth));this.ph.addClass(css.top<pos.top?'north':'south');break;case'S':paddingNear=parseInt(target.css('padding-top').replace(/(.*)px/,"$1"),10);targetHeight="ownerSVGElement"in target[0]?(target.attr("height")?target.attr("height")-0:0):target.height();css.left=this.center(target.outerWidth(),phWidth,pos.left,minWidth,maxWidth);css.top=this.offset(targetHeight,phHeight,pos.top+paddingNear,vertexOffset,minHeight,maxHeight,'far');targetOffset=pos.left-css.left-this.ph.css('border-top-width').replace(/(.*)px/,"$1");this.arrow.css('left',this.center(target.outerWidth(),vertexSize,targetOffset,0,phWidth));this.ph.addClass(css.top<pos.top?'north':'south');break;case'W':paddingNear=parseInt(target.css('padding-left').replace(/(.*)px/,"$1"),10);css.top=this.center(target.outerHeight(),phHeight,pos.top,minHeight,maxHeight);targetWidth="ownerSVGElement"in target[0]?(target.attr("width")?target.attr("width")-0:0):target.width();css.left=this.offset(target.width(),phWidth,pos.left+paddingNear,vertexOffset,minWidth,maxWidth,'near');targetOffset=pos.top-css.top-this.ph.css('border-left-width').replace(/(.*)px/,"$1");this.arrow.css('top',this.center(target.outerHeight(),vertexSize,targetOffset,0,phHeight));this.ph.addClass(css.left<pos.left?'west':'east');break;case'E':paddingNear=parseInt(target.css('padding-left').replace(/(.*)px/,"$1"),10);css.top=this.center(target.outerHeight(),phHeight,pos.top,minHeight,maxHeight);targetWidth="ownerSVGElement"in target[0]?(target.attr("width")?target.attr("width")-0:0):target.width();css.left=this.offset(targetWidth,phWidth,pos.left+paddingNear,vertexOffset,minWidth,maxWidth,'far');targetOffset=pos.top-css.top-this.ph.css('border-left-width').replace(/(.*)px/,"$1");this.arrow.css('top',this.center(target.outerHeight(),vertexSize,targetOffset,0,phHeight));this.ph.addClass(css.left<pos.left?'west':'east');break;}
this.ph.css(css);this.ph.show();var escHandler,myself=this;escHandler=function(e){if(e.which==27){myself.ph.hide();$(document).unbind('keydown',escHandler);}};$(document).keydown(escHandler);var dragHandler;dragHandler=function(){myself.arrow.hide();}
this.ph.bind('drag',dragHandler);if(draggable){this.ph.draggable({cancel:"#"+this.htmlObject});}
var basePos,dragPos;this.ph.bind('touchstart',function(e){basePos=myself.ph.offset();dragPos={left:e.originalEvent.touches[0].pageX,top:e.originalEvent.touches[0].pageY};});this.ph.bind('touchmove',function(e){var finalPos={top:basePos.top+e.originalEvent.touches[0].pageY-dragPos.top,left:basePos.left+e.originalEvent.touches[0].pageX-dragPos.left};myself.ph.offset(finalPos);myself.arrow.hide();e.preventDefault();});if(closeOnClickOutside){if(!this.$overlay){this.$overlay=$('<div id="popupComponentOverlay"></div>');if(this.popupOverlayClass){this.$overlay.addClass(this.popupOverlayClass);}}
this.$overlay.appendTo("body").click(function(event){event.stopPropagation();myself.hide();})}},hide:function(){this.ph.hide();if(this.$overlay){this.$overlay.unbind('click');this.$overlay.detach();}},center:function(targetSize,phSize,offset,min,max){var candidate=offset+targetSize/2-phSize/2;return candidate+phSize>max?max-phSize:candidate<min?min:candidate;},offset:function(targetSize,phSize,offset,gap,min,max,range){var near=offset-phSize-gap,far=offset+targetSize+gap,nearAdmissible=near>min,farAdmissible=far+phSize<max;return range=='near'?(nearAdmissible||!farAdmissible?near:far):range=='far'?(farAdmissible||!nearAdmissible?far:near):near;}});var ExportPopupComponent=PopupComponent.extend({ph:undefined,arrow:undefined,content:undefined,cancel:undefined,dataComponent:undefined,chartComponent:undefined,baseSize:200,scalingFactor:1.5,clone:function(parameterRemap,componentRemap,htmlRemap){var dataComponent=this.dataComponent,chartComponent=this.chartComponent;delete this.dataComponent;delete this.chartComponent;var that=this.base(parameterRemap,componentRemap,htmlRemap);if(dataComponent){this.dataComponent=dataComponent;that.dataComponent=componentRemap[dataComponent.name]||dataComponent;}
if(chartComponent){this.chartComponent=chartComponent;var truncated=/render_(.*)/.test(chartComponent.name)?chartComponent.name.match(/render_(.*)/)[1]:null;if(componentRemap[chartComponent.name]){that.chartComponent=Dashboards.getComponentByName(componentRemap[chartComponent.name]);that.chartExportComponent=componentRemap[chartComponent.name];}else if(truncated&&componentRemap[truncated]){that.chartComponent=Dashboards.getComponentByName("render_"+componentRemap[truncated]);that.chartExportComponent=componentRemap[truncated];}else{that.chartComponent=chartComponent;}
that.chartComponent=componentRemap[chartComponent.name]||chartComponent;}
return that;},update:function(){var myself=this;if(this.ph){this.ph.remove();}
this.chartComponent=window["render_"+this.chartExportComponent];this.dataComponent=window["render_"+this.dataExportComponent];this.ph=$('<div>');$("#"+this.htmlObject).empty();var link=$('<div class="popupTitle">');link.text(this.title||'Export');link.click(function(e){myself.popup(link);e.stopPropagation();})
$("#"+this.htmlObject).append(link);if(this.chartComponent){var realChartExportLabel="Export Chart";if(this.chartExportLabel&&this.chartExportLabel.length>0)
realChartExportLabel=this.chartExportLabel;var chartExportElt=$('<div class="exportElement">');chartExportElt.text(realChartExportLabel);chartExportElt.click(function(){myself.exportChart();});chartExportElt.appendTo(myself.ph);}
if(this.dataComponent){var realTableExportLabel="Export Data";if(this.dataExportLabel&&this.dataExportLabel.length>0)
realTableExportLabel=this.dataExportLabel;var dataExportElt=$('<div class="exportElement">');dataExportElt.text(realTableExportLabel);dataExportElt.click(function(){myself.exportData();});dataExportElt.appendTo(myself.ph);}
$(this.contentLinks).each(function(i,elt){var popupElt=$('<div class="exportElement">');popupElt.text(elt[0]);popupElt.click(elt[1]);popupElt.appendTo(myself.ph);});this.ph.hide().appendTo($('body'));this.ph.addClass('popupComponent');this.ph.addClass('exportOptions');this.cancel=$("<a>&nbsp;</a>");this.cancel.addClass("close").click(function(){myself.hide();});this.cancel.appendTo(this.ph);this.arrow=$("<div class='arrow'>").appendTo(this.ph);},popup:function(target,gravity){this.base(target,gravity);var myself=this;var docClick=function(e){var x=e.pageX;var y=e.pageY;var linkPos=$("#"+myself.htmlObject).position();if((x<linkPos.left||x>linkPos.left+$("#"+myself.htmlObject).width())||(y<linkPos.top||y>linkPos.top+$("#"+myself.htmlObject).height())){myself.hide();$(document).unbind('click',docClick);}};$(document).click(docClick);},exportData:function(det){var effectiveExportType=det==undefined?this.dataExportType:det;Dashboards.log("Exporting to "+effectiveExportType);var parameters=this.dataComponent.parameters.slice();for(var i=0;i<parameters.length;i++){if(parameters[i][0]==='metadata'){parameters[i]=parameters[i].slice();parameters[i][1]='false';break;}}
var cd=this.dataComponent.chartDefinition||this.dataComponent.queryDefinition;var query=Dashboards.getQuery(cd);query.exportData(effectiveExportType,parameters,{filename:this.dataExportAttachmentName+"."+effectiveExportType});},exportChart:function(cet){var effectiveExportType=cet==undefined?this.chartExportType:cet;Dashboards.log("Exporting to "+effectiveExportType);var parameters=this.chartComponent.parameters;var dataAccess=this.chartComponent.chartDefinition.dataAccessId;var path=this.chartComponent.chartDefinition.path;var loc=(Dashboards.context.fullPath)?Dashboards.context.fullPath.replace(/[^\/]+$/,""):Dashboards.context.path.replace(/[^\/]+$/,"");var url=wd.helpers.cggHelper.getCggDrawUrl()+"?script="+loc+this.chartExportComponent+".js&outputType="+effectiveExportType;var param;for(var i=0;i<parameters.length;i++){param=Dashboards.ev(Dashboards.getParameterValue(parameters[i][1]));if(param!==undefined){url+="&param"+parameters[i][0]+"="+(parameters[i][0]!='metadata'?encodeURIComponent(param):'false');}}
var level=Dashboards.debug;if(level>1){url+="&paramdebug=true";url+="&paramdebugLevel="+level;}
var myself=this;var masterDiv=$('<div class="exportChartMasterDiv">');var totalWidth=Math.max(700,this.chartComponent.chartDefinition.width);var popupButtonsDiv=$("<div class='exportChartPopupButtons' style='width:"+totalWidth+"px'>");masterDiv.append(popupButtonsDiv);var titleDiv=$("<div class='exportChartTitle'>Export Options</div>");popupButtonsDiv.append(titleDiv);var smallButton=$("<div class='exportChartPopupButton exportChartButtonNotLast'>Small</div>");smallButton.click(function(){$('.exportChartPopupButtonClicked').each(function(i,elt){$(elt).removeClass('exportChartPopupButtonClicked')})
$(this).addClass('exportChartPopupButtonClicked');$('#width').attr('disabled',true);$('#height').attr('disabled',true);$('#width').val(myself.baseSize);$('#height').val(myself.baseSize*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width));});popupButtonsDiv.append(smallButton);var mediumButton=$("<div class='exportChartPopupButton exportChartButtonNotLast exportChartButtonMiddle'>Medium</div>");mediumButton.click(function(){$('.exportChartPopupButtonClicked').each(function(i,elt){$(elt).removeClass('exportChartPopupButtonClicked')})
$(this).addClass('exportChartPopupButtonClicked');$('#width').attr('disabled',true);$('#height').attr('disabled',true);var size=myself.baseSize*myself.scalingFactor;$('#width').val(size);$('#height').val(size*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width));});mediumButton.getComponentData=function(){return[(myself.chartComponent.chartDefinition.width),(myself.chartComponent.chartDefinition.height)];}
popupButtonsDiv.append(mediumButton);var largeButton=$("<div class='exportChartPopupButton exportChartButtonNotLast exportChartButtonMiddle'>Large</div>");largeButton.click(function(){$('.exportChartPopupButtonClicked').each(function(i,elt){$(elt).removeClass('exportChartPopupButtonClicked')})
$(this).addClass('exportChartPopupButtonClicked');$('#width').attr('disabled',true);$('#height').attr('disabled',true);var size=myself.baseSize*myself.scalingFactor*myself.scalingFactor;$('#width').val(size);$('#height').val(size*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width));});popupButtonsDiv.append(largeButton);var customButton=$("<div class='exportChartPopupButton exportChartButtonMiddle'>Custom</div>");customButton.click(function(){$('.exportChartPopupButtonClicked').each(function(i,elt){$(elt).removeClass('exportChartPopupButtonClicked')})
$(this).addClass('exportChartPopupButtonClicked');$('#width').removeAttr('disabled');$('#height').removeAttr('disabled');$('#width').val(myself.chartComponent.chartDefinition.width);$('#height').val(myself.chartComponent.chartDefinition.height);});popupButtonsDiv.append(customButton);var inputsWidthDiv=$("<div class='exportChartInput'>&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;Width:&nbsp;<input id='width'  disabled='true' style='width:50px' value='"+this.chartComponent.chartDefinition.width+"' onChange='javascript:$(\"#height\").val($(\"#width\").val() * "+(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width)+");' type='text'></div>");popupButtonsDiv.append(inputsWidthDiv);var inputsHeightDiv=$("<div class='exportChartInput'>Height:&nbsp;</span><input id='height' disabled='true' style='width:50px' value='"+this.chartComponent.chartDefinition.height+"' type='text'></div>");popupButtonsDiv.append(inputsHeightDiv);var okButton=$("<div class='exportChartPopupButton exportChartOkButton'>Export</div>");okButton.click(function(){var dimensions,size;switch($('.exportChartPopupButtonClicked').text()){case"Small":dimensions=[myself.baseSize,myself.BaseSize*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width)];break;case"Medium":size=myself.baseSize*myself.scalingFactor;dimensions=[size,size*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width)];break;case"Large":size=myself.baseSize*myself.scalingFactor*myself.scalingFactor;dimensions=[size,size*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width)];break;case"Custom":default:dimensions=[$('#width').val(),$('#height').val()];break;}
var _exportIframe=$('<iframe style="display:none">');_exportIframe.detach();_exportIframe[0].src=url+"&attachmentName="+myself.dataExportAttachmentName+"."+effectiveExportType+"&paramwidth="+dimensions[0]+'&paramheight='+dimensions[1];_exportIframe.appendTo($('body'));});popupButtonsDiv.append(okButton);var img=$("<img src='"+url+"&paramwidth="+this.chartComponent.chartDefinition.width+"&paramheight="+this.chartComponent.chartDefinition.height+"'/>");var imgDiv=$("<div class='exportChartImageDiv'>");imgDiv.append(img);imgDiv.append("&nbsp;");masterDiv.append(imgDiv);$.fancybox({type:"html",closeBtn:true,content:masterDiv,width:totalWidth,height:this.chartComponent.chartDefinition.height+60});}});
var PopupComponent=BaseComponent.extend({ph:undefined,arrow:undefined,content:undefined,cancel:undefined,$overlay:undefined,popupClass:undefined,popupOverlayClass:undefined,update:function(){var myself=this;this.content=$("#"+this.htmlObject).detach();this.ph=this.ph?this.ph.empty():$('<div>').appendTo($('body'));this.content.appendTo(this.ph);this.ph.hide();this.ph.addClass('popupComponent');if(this.popupClass){this.ph.addClass(this.popupClass);}
this.cancel=$("<a>&nbsp;</a>");this.cancel.addClass("close").click(function(){myself.hide();});this.cancel.appendTo(this.ph);this.arrow=$("<div class='arrow'>").appendTo(this.ph);this.content.removeClass('hidePopup');},clone:function(params,comps,html){var that=this.base(params,comps,html);that.ph=this.ph.clone();that.ph.insertAfter(this.ph);that.ph.hide();that.ph.find("[id]").each(function(i,e){$e=$(e);var id=$e.attr("id");if(id&&id in html){$e.attr("id",html[id]);}else{$e.attr("id",id+'_'+Dashboards.duplicateIndex);}});return that;},popup:function(target,gravity){var pos=target.offset(),css={'top':'auto','bottom':'auto','left':'auto','right':'auto'},minimumDistance=20,vertexOffset=18-6,vertexSize=45,targetOffset,phHeight=this.ph.outerHeight(),phWidth=this.ph.outerWidth();gravity=gravity||this.gravity;var draggable=typeof this.draggable==="undefined"?true:this.draggable;if(this.horizontalScroll){$("#"+this.htmlObject).css("overflow-x","scroll");}
if(this.verticalScroll){$("#"+this.htmlObject).css("overflow-y","scroll");}
var closeOnClickOutside=typeof this.closeOnClickOutside==="undefined"?false:this.closeOnClickOutside;this.arrow.css({top:"",left:"",bottom:"",right:""});this.arrow.show();this.ph.removeClass('north south east west');var minWidth=minimumDistance,maxWidth=$(document).width()-minimumDistance,minHeight=minimumDistance,maxHeight=$(document).height()-minimumDistance,targetWidth,targetHeight,paddingNear,paddingFar;switch(gravity){case'N':paddingNear=parseInt(target.css('padding-top').replace(/(.*)px/,"$1"),10);css.left=this.center(target.outerWidth(),phWidth,pos.left,minWidth,maxWidth);targetHeight="ownerSVGElement"in target[0]?(target.attr("height")?target.attr("height")-0:0):target.height();targetOffset=pos.left-css.left-this.ph.css('border-top-width').replace(/(.*)px/,"$1");css.top=this.offset(targetHeight,phHeight,pos.top+paddingNear,vertexOffset,minHeight,maxHeight,'near');this.arrow.css('left',this.center(target.outerWidth(),vertexSize,targetOffset,0,phWidth));this.ph.addClass(css.top<pos.top?'north':'south');break;case'S':paddingNear=parseInt(target.css('padding-top').replace(/(.*)px/,"$1"),10);targetHeight="ownerSVGElement"in target[0]?(target.attr("height")?target.attr("height")-0:0):target.height();css.left=this.center(target.outerWidth(),phWidth,pos.left,minWidth,maxWidth);css.top=this.offset(targetHeight,phHeight,pos.top+paddingNear,vertexOffset,minHeight,maxHeight,'far');targetOffset=pos.left-css.left-this.ph.css('border-top-width').replace(/(.*)px/,"$1");this.arrow.css('left',this.center(target.outerWidth(),vertexSize,targetOffset,0,phWidth));this.ph.addClass(css.top<pos.top?'north':'south');break;case'W':paddingNear=parseInt(target.css('padding-left').replace(/(.*)px/,"$1"),10);css.top=this.center(target.outerHeight(),phHeight,pos.top,minHeight,maxHeight);targetWidth="ownerSVGElement"in target[0]?(target.attr("width")?target.attr("width")-0:0):target.width();css.left=this.offset(target.width(),phWidth,pos.left+paddingNear,vertexOffset,minWidth,maxWidth,'near');targetOffset=pos.top-css.top-this.ph.css('border-left-width').replace(/(.*)px/,"$1");this.arrow.css('top',this.center(target.outerHeight(),vertexSize,targetOffset,0,phHeight));this.ph.addClass(css.left<pos.left?'west':'east');break;case'E':paddingNear=parseInt(target.css('padding-left').replace(/(.*)px/,"$1"),10);css.top=this.center(target.outerHeight(),phHeight,pos.top,minHeight,maxHeight);targetWidth="ownerSVGElement"in target[0]?(target.attr("width")?target.attr("width")-0:0):target.width();css.left=this.offset(targetWidth,phWidth,pos.left+paddingNear,vertexOffset,minWidth,maxWidth,'far');targetOffset=pos.top-css.top-this.ph.css('border-left-width').replace(/(.*)px/,"$1");this.arrow.css('top',this.center(target.outerHeight(),vertexSize,targetOffset,0,phHeight));this.ph.addClass(css.left<pos.left?'west':'east');break;}
this.ph.css(css);this.ph.show();var escHandler,myself=this;escHandler=function(e){if(e.which==27){myself.ph.hide();$(document).unbind('keydown',escHandler);}};$(document).keydown(escHandler);var dragHandler;dragHandler=function(){myself.arrow.hide();}
this.ph.bind('drag',dragHandler);if(draggable){this.ph.draggable({cancel:"#"+this.htmlObject});}
var basePos,dragPos;this.ph.bind('touchstart',function(e){basePos=myself.ph.offset();dragPos={left:e.originalEvent.touches[0].pageX,top:e.originalEvent.touches[0].pageY};});this.ph.bind('touchmove',function(e){var finalPos={top:basePos.top+e.originalEvent.touches[0].pageY-dragPos.top,left:basePos.left+e.originalEvent.touches[0].pageX-dragPos.left};myself.ph.offset(finalPos);myself.arrow.hide();e.preventDefault();});if(closeOnClickOutside){if(!this.$overlay){this.$overlay=$('<div id="popupComponentOverlay"></div>');if(this.popupOverlayClass){this.$overlay.addClass(this.popupOverlayClass);}}
this.$overlay.appendTo("body").click(function(event){event.stopPropagation();myself.hide();})}},hide:function(){this.ph.hide();if(this.$overlay){this.$overlay.unbind('click');this.$overlay.detach();}},center:function(targetSize,phSize,offset,min,max){var candidate=offset+targetSize/2-phSize/2;return candidate+phSize>max?max-phSize:candidate<min?min:candidate;},offset:function(targetSize,phSize,offset,gap,min,max,range){var near=offset-phSize-gap,far=offset+targetSize+gap,nearAdmissible=near>min,farAdmissible=far+phSize<max;return range=='near'?(nearAdmissible||!farAdmissible?near:far):range=='far'?(farAdmissible||!nearAdmissible?far:near):near;}});var ExportPopupComponent=PopupComponent.extend({ph:undefined,arrow:undefined,content:undefined,cancel:undefined,dataComponent:undefined,chartComponent:undefined,baseSize:200,scalingFactor:1.5,clone:function(parameterRemap,componentRemap,htmlRemap){var dataComponent=this.dataComponent,chartComponent=this.chartComponent;delete this.dataComponent;delete this.chartComponent;var that=this.base(parameterRemap,componentRemap,htmlRemap);if(dataComponent){this.dataComponent=dataComponent;that.dataComponent=componentRemap[dataComponent.name]||dataComponent;}
if(chartComponent){this.chartComponent=chartComponent;var truncated=/render_(.*)/.test(chartComponent.name)?chartComponent.name.match(/render_(.*)/)[1]:null;if(componentRemap[chartComponent.name]){that.chartComponent=Dashboards.getComponentByName(componentRemap[chartComponent.name]);that.chartExportComponent=componentRemap[chartComponent.name];}else if(truncated&&componentRemap[truncated]){that.chartComponent=Dashboards.getComponentByName("render_"+componentRemap[truncated]);that.chartExportComponent=componentRemap[truncated];}else{that.chartComponent=chartComponent;}
that.chartComponent=componentRemap[chartComponent.name]||chartComponent;}
return that;},update:function(){var myself=this;if(this.ph){this.ph.remove();}
this.chartComponent=window["render_"+this.chartExportComponent];this.dataComponent=window["render_"+this.dataExportComponent];this.ph=$('<div>');$("#"+this.htmlObject).empty();var link=$('<div class="popupTitle">');link.text(this.title||'Export');link.click(function(e){myself.popup(link);e.stopPropagation();})
$("#"+this.htmlObject).append(link);if(this.chartComponent){var realChartExportLabel="Export Chart";if(this.chartExportLabel&&this.chartExportLabel.length>0)
realChartExportLabel=this.chartExportLabel;var chartExportElt=$('<div class="exportElement">');chartExportElt.text(realChartExportLabel);chartExportElt.click(function(){myself.exportChart();});chartExportElt.appendTo(myself.ph);}
if(this.dataComponent){var realTableExportLabel="Export Data";if(this.dataExportLabel&&this.dataExportLabel.length>0)
realTableExportLabel=this.dataExportLabel;var dataExportElt=$('<div class="exportElement">');dataExportElt.text(realTableExportLabel);dataExportElt.click(function(){myself.exportData();});dataExportElt.appendTo(myself.ph);}
$(this.contentLinks).each(function(i,elt){var popupElt=$('<div class="exportElement">');popupElt.text(elt[0]);popupElt.click(elt[1]);popupElt.appendTo(myself.ph);});this.ph.hide().appendTo($('body'));this.ph.addClass('popupComponent');this.ph.addClass('exportOptions');this.cancel=$("<a>&nbsp;</a>");this.cancel.addClass("close").click(function(){myself.hide();});this.cancel.appendTo(this.ph);this.arrow=$("<div class='arrow'>").appendTo(this.ph);},popup:function(target,gravity){this.base(target,gravity);var myself=this;var docClick=function(e){var x=e.pageX;var y=e.pageY;var linkPos=$("#"+myself.htmlObject).position();if((x<linkPos.left||x>linkPos.left+$("#"+myself.htmlObject).width())||(y<linkPos.top||y>linkPos.top+$("#"+myself.htmlObject).height())){myself.hide();$(document).unbind('click',docClick);}};$(document).click(docClick);},exportData:function(det){var effectiveExportType=det==undefined?this.dataExportType:det;Dashboards.log("Exporting to "+effectiveExportType);var parameters=this.dataComponent.parameters.slice();for(var i=0;i<parameters.length;i++){if(parameters[i][0]==='metadata'){parameters[i]=parameters[i].slice();parameters[i][1]='false';break;}}
var cd=this.dataComponent.chartDefinition||this.dataComponent.queryDefinition;var query=Dashboards.getQuery(cd);query.exportData(effectiveExportType,parameters,{filename:this.dataExportAttachmentName+"."+effectiveExportType});},exportChart:function(cet){var effectiveExportType=cet==undefined?this.chartExportType:cet;Dashboards.log("Exporting to "+effectiveExportType);var parameters=this.chartComponent.parameters;var dataAccess=this.chartComponent.chartDefinition.dataAccessId;var path=this.chartComponent.chartDefinition.path;var loc=(Dashboards.context.fullPath)?Dashboards.context.fullPath.replace(/[^\/]+$/,""):Dashboards.context.path.replace(/[^\/]+$/,"");var url=wd.helpers.cggHelper.getCggDrawUrl()+"?script="+loc+this.chartExportComponent+".js&outputType="+effectiveExportType;var param;for(var i=0;i<parameters.length;i++){param=Dashboards.ev(Dashboards.getParameterValue(parameters[i][1]));if(param!==undefined){url+="&param"+parameters[i][0]+"="+(parameters[i][0]!='metadata'?encodeURIComponent(param):'false');}}
var level=Dashboards.debug;if(level>1){url+="&paramdebug=true";url+="&paramdebugLevel="+level;}
var myself=this;var masterDiv=$('<div class="exportChartMasterDiv">');var totalWidth=Math.max(700,this.chartComponent.chartDefinition.width);var popupButtonsDiv=$("<div class='exportChartPopupButtons' style='width:"+totalWidth+"px'>");masterDiv.append(popupButtonsDiv);var titleDiv=$("<div class='exportChartTitle'>Export Options</div>");popupButtonsDiv.append(titleDiv);var smallButton=$("<div class='exportChartPopupButton exportChartButtonNotLast'>Small</div>");smallButton.click(function(){$('.exportChartPopupButtonClicked').each(function(i,elt){$(elt).removeClass('exportChartPopupButtonClicked')})
$(this).addClass('exportChartPopupButtonClicked');$('#width').attr('disabled',true);$('#height').attr('disabled',true);$('#width').val(myself.baseSize);$('#height').val(myself.baseSize*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width));});popupButtonsDiv.append(smallButton);var mediumButton=$("<div class='exportChartPopupButton exportChartButtonNotLast exportChartButtonMiddle'>Medium</div>");mediumButton.click(function(){$('.exportChartPopupButtonClicked').each(function(i,elt){$(elt).removeClass('exportChartPopupButtonClicked')})
$(this).addClass('exportChartPopupButtonClicked');$('#width').attr('disabled',true);$('#height').attr('disabled',true);var size=myself.baseSize*myself.scalingFactor;$('#width').val(size);$('#height').val(size*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width));});mediumButton.getComponentData=function(){return[(myself.chartComponent.chartDefinition.width),(myself.chartComponent.chartDefinition.height)];}
popupButtonsDiv.append(mediumButton);var largeButton=$("<div class='exportChartPopupButton exportChartButtonNotLast exportChartButtonMiddle'>Large</div>");largeButton.click(function(){$('.exportChartPopupButtonClicked').each(function(i,elt){$(elt).removeClass('exportChartPopupButtonClicked')})
$(this).addClass('exportChartPopupButtonClicked');$('#width').attr('disabled',true);$('#height').attr('disabled',true);var size=myself.baseSize*myself.scalingFactor*myself.scalingFactor;$('#width').val(size);$('#height').val(size*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width));});popupButtonsDiv.append(largeButton);var customButton=$("<div class='exportChartPopupButton exportChartButtonMiddle'>Custom</div>");customButton.click(function(){$('.exportChartPopupButtonClicked').each(function(i,elt){$(elt).removeClass('exportChartPopupButtonClicked')})
$(this).addClass('exportChartPopupButtonClicked');$('#width').removeAttr('disabled');$('#height').removeAttr('disabled');$('#width').val(myself.chartComponent.chartDefinition.width);$('#height').val(myself.chartComponent.chartDefinition.height);});popupButtonsDiv.append(customButton);var inputsWidthDiv=$("<div class='exportChartInput'>&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;Width:&nbsp;<input id='width'  disabled='true' style='width:50px' value='"+this.chartComponent.chartDefinition.width+"' onChange='javascript:$(\"#height\").val($(\"#width\").val() * "+(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width)+");' type='text'></div>");popupButtonsDiv.append(inputsWidthDiv);var inputsHeightDiv=$("<div class='exportChartInput'>Height:&nbsp;</span><input id='height' disabled='true' style='width:50px' value='"+this.chartComponent.chartDefinition.height+"' type='text'></div>");popupButtonsDiv.append(inputsHeightDiv);var okButton=$("<div class='exportChartPopupButton exportChartOkButton'>Export</div>");okButton.click(function(){var dimensions,size;switch($('.exportChartPopupButtonClicked').text()){case"Small":dimensions=[myself.baseSize,myself.BaseSize*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width)];break;case"Medium":size=myself.baseSize*myself.scalingFactor;dimensions=[size,size*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width)];break;case"Large":size=myself.baseSize*myself.scalingFactor*myself.scalingFactor;dimensions=[size,size*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width)];break;case"Custom":default:dimensions=[$('#width').val(),$('#height').val()];break;}
var _exportIframe=$('<iframe style="display:none">');_exportIframe.detach();_exportIframe[0].src=url+"&attachmentName="+myself.dataExportAttachmentName+"."+effectiveExportType+"&paramwidth="+dimensions[0]+'&paramheight='+dimensions[1];_exportIframe.appendTo($('body'));});popupButtonsDiv.append(okButton);var img=$("<img src='"+url+"&paramwidth="+this.chartComponent.chartDefinition.width+"&paramheight="+this.chartComponent.chartDefinition.height+"'/>");var imgDiv=$("<div class='exportChartImageDiv'>");imgDiv.append(img);imgDiv.append("&nbsp;");masterDiv.append(imgDiv);$.fancybox({type:"html",closeBtn:true,content:masterDiv,width:totalWidth,height:this.chartComponent.chartDefinition.height+60});}});
var wd=wd||{};wd.cpk=wd.cpk||{};(function(namespace){function _testFile(url,successCallback,errorCallback){successCallback=successCallback||function(){return true;};errorCallback=errorCallback||function(){return true;};$.ajax({url:url,type:'HEAD',error:errorCallback,success:successCallback});}
namespace.models=namespace.models||{};namespace.views=namespace.views||{};namespace.templates=namespace.templates||{};namespace.models.sparklNewPluginCard=Backbone.Model.extend({defaults:{"pluginId":"newPluginId","actionOpts":[]},fireAction:function(action){this.trigger('action:'+action,this.get('pluginId'));}});namespace.models.sparklPluginCard=Backbone.Model.extend({defaults:{"pluginId":"","plugin_name":"","plugin_description":"","author_name":"","company_name":"","company_url":"","creation_date":"","version":"","CPK_version":"","pluginImage":"","actionOpts":[],"imgSrc":"","backgroundColor":"none"},initialize:function(){var pluginId=this.get('pluginId'),imgSrc=Dashboards.getWebAppPath()+'/pentaho/api/repos/'+pluginId+'/static/system/img/pluginLogo___.png';this.set('imgSrc',imgSrc);},fireAction:function(action){this.trigger('action:'+action,this.get('pluginId'));}});namespace.templates.sparklNewPluginCard=Mustache.compile("   <div class='overlay'></div>"+"  <div class='optionsContainer'></div>"+"  <div class='separator'>"+"   <div class='horizontalRectangle'></div>"+"   <div class='verticalRectangle'></div>"+"  </div>");namespace.templates.sparklPluginCard=Mustache.compile("  <div class=descriptionExpandCont>"+"   <div class='cardHeader'>"+"     <div class='nameContainer'>"+"         <span class='name' title='{{plugin_name}}'>{{plugin_name}}</span>"+"       </div>"+"    <div class='id' title='{{pluginId}}'>{{pluginId}}</div>"+"   </div>"+"   <div class='cardBody'>"+"    <div class='imageContainer'>"+"    </div>"+"    <div class='descriptionContainer'>"+"     <div class='header'>Description</div>"+"     <div class='body'>{{plugin_description}}</div>"+"    </div>"+"   </div>"+"  </div>"+"  <div class='cardFooter'>"+"   <div class='optionsContainer'>"+"   </div>"+"  </div>");namespace.views.sparklNewPluginCard=Backbone.View.extend({template:namespace.templates.sparklNewPluginCard,tagName:'div',className:'sparklNewPluginCardContainer',events:{},initialize:function(){},render:function(ph){var that=this;that.$el.html(that.template(that.model.toJSON()));var $optsContainer=that.$el.find('.optionsContainer');_.each(that.model.get('actionOpts'),function(action,idx){$('<div/>').addClass('optionCont').append($('<span/>').text(action.label).addClass('label')).click(function(){that.model.fireAction(action.id);}).appendTo($optsContainer);});that.$el.addClass('numActions-'+that.model.get('actionOpts').length);this.appendView(ph);},appendView:function(ph){if(ph){this.$ph=$(ph);}
if(this.$ph){this.$ph.append(this.$el);}
return this;}});namespace.views.sparklPluginCard=Backbone.View.extend({template:namespace.templates.sparklPluginCard,tagName:'div',className:'sparklPluginCardContainer',events:{"click .optionsIcon":"toggleOptionsExpanded"},initialize:function(){this.model.on('change:imgSrc',function(v){if(v){this.$el.find('img').show();}});},render:function(ph){var self=this;this.$el.html(this.template(this.model.toJSON()));_.each(this.model.get('actionOpts'),function(action){var $optsContainer=self.$el.find('.optionsContainer');var $opt=$("<div/>").text(action.label).attr('id',action.id).addClass('optionCont').addClass(action.classes||"");$optsContainer.append($opt);$opt.click(function(){self.model.fireAction(action.id);self.toggleOptionsExpanded(false);});});var imgSrc=this.model.get('imgSrc'),$container=this.$el.find('.imageContainer'),successCallback=function(){$('<img/>').attr('src',imgSrc).addClass('image').appendTo($container);},errorCallback=function(){var label=self.model.get('plugin_name')||self.model.get('pluginId')||"";$('<div/>').text(label).addClass('imagePlaceholder').appendTo($container);};$container.css('background-color',self.model.get('backgroundColor'));_testFile(imgSrc,successCallback,errorCallback);this.appendView(ph);},appendView:function(ph){if(ph){this.$ph=$(ph);}
if(this.$ph){this.$ph.append(this.$el);}
var $header=this.$el.find('.cardHeader'),$title=$header.find('.name');if($title.width()>$header.width()){$header.addClass('overflow');}
return this;},detachView:function(){this.$el.detach();return this;},toggleOptionsExpanded:function(predicate){var $ph=this.$el.find('.optsExternCont');var pred=_.isUndefined(predicate)?!$ph.hasClass('expanded'):predicate;$ph.toggleClass('expanded',pred);}});})(wd.cpk);
var SparklPluginCardComponent=(function(){function _getHashCode(str){var hash=0,i,char;if(str.length==0)return hash;for(i=0,l=str.length;i<l;i++){char=str.charCodeAt(i);hash=((hash<<5)-hash)+char;hash|=0;}
return hash;}
var MyClass=UnmanagedComponent.extend({pluginActions:[{id:"action1",label:"Action 1"},{id:"action2",label:"Action 2"}],newPluginActions:[{id:"newAction1",label:"New Action 1"},{id:"newAction2",label:"New Action 2"}],colorPalette:["#e6b313","#ed5825","#ed2556","#0fb63a","#5825ed"],_models:{},_views:{},_newPluginModel:undefined,_newPluginView:undefined,update:function(){$.extend(this.options,this);this.ph=$("#"+this.htmlObject);var callback=_.bind(this.handleJsonResponse,this);this.clean();this.triggerQuery(this.chartDefinition,callback);},clean:function(){_.each(this._models,function(model){model.destroy();});this._views={};this._models={};},handleJsonResponse:function(json){var myself=this;var plugins=_.map(json.resultset,function(rawPlugin){var plugin={};_.each(rawPlugin,function(value,idx){plugin[json.metadata[idx].colName]=value;plugin.actionOpts=myself.pluginActions;});return plugin;});this.redraw(plugins);},getColor:function(str){var idx=Math.abs(_getHashCode(str))%this.colorPalette.length;return this.colorPalette[idx];},redraw:function(plugins){$('#'+this.htmlObject).empty();var cd=this.chartDefinition;var that=this;var newPlugin={};newPlugin.pluginId=Dashboards.getParameterValue('pluginIdParam');newPlugin.actionOpts=this.newPluginActions;if(!that._newPluginModel){that._newPluginModel=new wd.cpk.models.sparklNewPluginCard(newPlugin);}else{that._newPluginModel.set(newPlugin);}
if(!that._newPluginView){that._newPluginView=new wd.cpk.views.sparklNewPluginCard({model:that._newPluginModel,tagName:'div'});}
that._newPluginView.render('#'+that.htmlObject);that.configureListeners(that._newPluginModel,that.newPluginActions);_.each(plugins,function(pluginOpts){pluginOpts.backgroundColor=that.getColor(pluginOpts.pluginId);if(!that._models[pluginOpts.pluginId]){that._models[pluginOpts.pluginId]=new wd.cpk.models.sparklPluginCard(pluginOpts);}else{that._models[pluginOpts.pluginId].set(pluginOpts);}
if(!that._views[pluginOpts.pluginId]){that._views[pluginOpts.pluginId]=new wd.cpk.views.sparklPluginCard({model:that._models[pluginOpts.pluginId],tagName:'div'});}
that.configureListeners(that._models[pluginOpts.pluginId],that.pluginActions);});_.each(this.getSortedViews(),function(v){v.render('#'+that.htmlObject);});},getSortedViews:function(prop,direction){var viewsArray=_.map(this._views,function(el){return el;});if(prop){viewsArray.sort(function(v1,v2){var s1=v1.model.get(prop).toLowerCase(),s2=v2.model.get(prop).toLowerCase();return(s1<s2)?-1:1;});}
return viewsArray;},sortViews:function(prop,direction){var viewsArray=this.getSortedViews(prop,direction);_.each(viewsArray,function(v){v.detachView().appendView();});},configureListeners:function(model,actions){var myself=this;_.each(actions,function(action){if(action.callback){model.off('action:'+action.id);model.on('action:'+action.id,action.callback,this);}});}});return MyClass;})();
var HelpMixin=Base.extend({_docstring:function(){return"Mixin that provides documentation for the developer";},help:function(fun){var h0=h='';switch(typeof fun){case"string":if(fun){h0=(this.name+'.'+fun+': ');fun=this[fun];}else{return this.help();}
break;case"function":h0=fun.name?(this.name+'.'+fun.name+': '):'';break;default:h0=(this.name+': '+this._docstring()+'\n')||"";fun=this._docstring;}
var sf=new String(fun);var matches=(sf.slice(0).split('/**',2)[1]||"").split('*/',1)[0];if(matches){h=_.map(matches.split('\n'),function(s){return s.trim();}).join('\n').trim();}
h=(h.length>0)?h:"No help available";return Dashboards.log(h0+h);if(!(fun instanceof Function)){if(fun.help){return Dashboards.log(fun.help);}
return Dashboards.log("I can not help you with that topic.");}
return Dashboards.log("I can not help you with that function.");}});var ActionComponent=ActionComponent||UnmanagedComponent.extend(new HelpMixin()).extend({_docstring:function(){return"Abstract class for components triggering a query on demand";},update:function(){var render=_.bind(this.render,this);if(typeof this.manageCallee=="undefined"||this.manageCallee){this.synchronous(render);}else{render();}},render:function(){},triggerAction:function(){var ad=this.actionDefinition,params=Dashboards.propertiesArrayToObject(this.actionParameters);var failureCallback=(this.failureCallback)?(this.failureCallback):function(){},successCallback=this.successCallback?(this.successCallback):function(){};return Dashboards.getQuery(ad).fetchData(params,_.bind(successCallback,this),_.bind(failureCallback,this));if(Dashboards.debug){Dashboards.log('ActionComponent.triggerAction('+ad.pluginId+', '+ad.endpoint+') was called','debug');}},hasAction:function(){if(!this.actionDefinition){return false;}
if(Dashboards.detectQueryType){return!!Dashboards.detectQueryType(this.actionDefinition);}else{return!!this.actionDefinition.queryType&&Dashboards.hasQuery(this.actionDefinition.queryType);}}});
var MixinButtonAPI=Base.extend({initButtonAPI:function(bool){bool=(bool==undefined)?true:bool;this._isJquery=bool;},disable:function(){if(this._isJquery){$('#'+this.htmlObject+' button').attr('disabled','disabled');}},enable:function(){if(this._isJquery){$('#'+this.htmlObject+' button').removeAttr('disabled');}},setLabel:function(label){if(this._isJquery){$('#'+this.htmlObject+' button').text(label.toString());}}});var ActionButtonComponent=ActionComponent.extend(new MixinButtonAPI()).extend({_docstring:function(){return"Button Component that triggers a server action when clicked";},render:function(){var myself=this,ad=this.actionDefinition;var b=$("<button type='button'/>").text(this.label).unbind("click").bind("click",function(){if(_.isFunction(myself.expression)){myself.expression.apply(myself,arguments);}
if(myself.hasAction()){return myself.triggerAction.apply(myself);}});if(typeof this.buttonStyle==="undefined"||this.buttonStyle==="themeroller"){b.button();this.initButtonAPI(true);}else{this.initButtonAPI(false);}
b.appendTo($("#"+this.htmlObject).empty());}});
wd=wd||{};wd.helpers=wd.helpers||{};wd.helpers.olap={getServiceUrl:function(){return"/plugin/pentaho-cdf-dd/api/olap/";},getCubesUrl:function(){return"getCubes";},getCubeStructureUrl:function(){return"getCubeStructure";},getPaginatedLevelMembersUrl:function(){return"getPaginatedLevelMembers";},getLevelMembersStructureUrl:function(){return"getLevelMembersStructure";}};
wd=wd||{};wd.helpers=wd.helpers||{};wd.helpers.repository={getRsourceUrl:function(){return"res";},getBaseSolutionPluginRoot:function(){return"/public/";},getWidgetsLocation:function(){return"/public/cde/widgets/";}};
wd=wd||{};wd.helpers=wd.helpers||{};wd.helpers.views={getViewsEndpoint:function(){return"/plugin/pentaho-cdf/api/views";},getSaveViewsEndpoint:function(){return getViewsEndpoint()+"/save";},getDeleteViewsEndpoint:function(){return getViewsEndpoint()+"/delete";},getListViewsEndpoint:function(){return getViewsEndpoint()+"/list";},getUrl:function(solution,file,path,view){var newPath=(solution+path+file).replace(/\//g,':').replace(/\+/g,"%20");return webAppPath+"/api/repos/"+newPath+"/generatedContent?view="+view.replace(/\+/g,"%20");}};
wd=wd||{};wd.helpers=wd.helpers||{};wd.helpers.editor={getUrl:function(){return"/plugin/pentaho-cdf-dd/api/editor/getExternalEditor?";}};